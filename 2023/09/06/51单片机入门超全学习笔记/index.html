<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>51单片机入门笔记 | null</title><meta name="author" content="被窝理想家"><meta name="copyright" content="被窝理想家"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="前言  这个板子是普中A2 STC89C52RC的板子，下面为开发板各功能模块    单片机最小系统：（1）晶振电路（2）复位电路（3）电源电路（4）下载电路 GPIO概念：GPIO是通用输入输出端口的简称，可以通过软件来控制其输入和输出。 开发板上使用的 51 单片机型号是 STC89C52RC，此芯片共有 40 引脚，芯片引脚图如下图所示：  51单片机引脚分类： （1）电源引脚：引脚图中的V">
<meta property="og:type" content="article">
<meta property="og:title" content="51单片机入门笔记">
<meta property="og:url" content="https://huangchux.github.io/2023/09/06/51%E5%8D%95%E7%89%87%E6%9C%BA%E5%85%A5%E9%97%A8%E8%B6%85%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
<meta property="og:site_name">
<meta property="og:description" content="前言  这个板子是普中A2 STC89C52RC的板子，下面为开发板各功能模块    单片机最小系统：（1）晶振电路（2）复位电路（3）电源电路（4）下载电路 GPIO概念：GPIO是通用输入输出端口的简称，可以通过软件来控制其输入和输出。 开发板上使用的 51 单片机型号是 STC89C52RC，此芯片共有 40 引脚，芯片引脚图如下图所示：  51单片机引脚分类： （1）电源引脚：引脚图中的V">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://huangchux.github.io/img/num1.webp">
<meta property="article:published_time" content="2023-09-06T01:28:59.000Z">
<meta property="article:modified_time" content="2023-10-15T03:47:19.543Z">
<meta property="article:author" content="被窝理想家">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://huangchux.github.io/img/num1.webp"><link rel="shortcut icon" href="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/v2-50aa75835d2f370adadf52d12009f034_720w.jpg"><link rel="canonical" href="https://huangchux.github.io/2023/09/06/51%E5%8D%95%E7%89%87%E6%9C%BA%E5%85%A5%E9%97%A8%E8%B6%85%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '51单片机入门笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-15 11:47:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="preconnect" href="https://s1.hdslb.com/" /><link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" media="all" onload="this.media='all'" /><link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/medium.css" media="all" onload="this.media='all'" /><link href="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/butterfly/css/all.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/my.css" media="all" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css" ><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/css/iziToast.min.css" media="all" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><style>css-doodle {--color: @p(#51eaea, #fffde1, #ff9d76, #FB3569);--rule: (:doodle {@grid: 30x1 / 18vmin;--deg: @p(-180deg, 180deg);}:container {perspective: 30vmin;}:after, :before {content: '';background: var(--color); @place-cell: @r(100%) @r(100%); @size: @r(6px); @shape: heart;} @place-cell: center; @size: 100%;box-shadow: @m2(0 0 50px var(--color));background: @m100(radial-gradient(var(--color) 50%, transparent 0)@r(-20%, 120%) @r(-20%, 100%) / 1px 1px no-repeat); will-change: transform, opacity; animation: scale-up 12s linear infinite; animation-delay: calc(-12s / @I * @i); @keyframes scale-up { 0%, 95.01%, 100% {transform: translateZ(0) rotate(0);opacity: 0;}10% {opacity: 1;}95% {transform: translateZ(35vmin) rotateZ(@var(--deg));}})}</style><css-doodle use="var(--rule)"></css-doodle><script async="async" src="https://cdn.bootcdn.net/ajax/libs/css-doodle/0.32.2/css-doodle.min.js"></script></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/v2-50aa75835d2f370adadf52d12009f034_720w.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/light.png"/></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">51单片机入门笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-06T01:28:59.000Z" title="发表于 2023-09-06 09:28:59">2023-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-15T03:47:19.543Z" title="更新于 2023-10-15 11:47:19">2023-10-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/51%E7%B3%BB%E5%88%97/">51系列</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><h2 id="前言">前言</h2>
<blockquote>
<p>这个板子是普中A2 STC89C52RC的板子，下面为开发板各功能模块</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/dfgdfgdfgdfg.webp" style="zoom:67%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/ac75ed38bd59453aa5598c0ecd0dfce9.webp" style="zoom:67%;" />
<p><strong>单片机最小系统</strong>：<code>（1）晶振电路（2）复位电路（3）电源电路（4）下载电路</code></p>
<p><strong>GPIO概念</strong>：GPIO是通用输入输出端口的简称，可以通过软件来控制其输入和输出。</p>
<p>开发板上使用的 51 单片机型号是 STC89C52RC，此芯片共有 40 引脚，芯片引脚图如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230907172607.webp" style="zoom:67%;" />
<p>51单片机引脚分类：<br>
（1）<code>电源引脚</code>：引脚图中的VCC、GND都属于电源引脚。</p>
<p>（2）<code>晶振引脚</code>：引脚图中的XTAL1、XTAL2都属于晶振引脚。</p>
<p>（3）<code>复位引脚</code>：引脚图中的RST/VPD属于复位引脚，不做其他功能使用。</p>
<p>（4）<code>下载引脚</code>：51单片机的串口功能引脚（TXD、RXD）可以作为下载引脚使用。</p>
<p>（5）<code>GPIO引脚</code>：引脚图中带有Px.x等字样的均属于GPIO引脚。从引脚图可以看出，GPIO占用了芯片大部分的引脚，共达32个，分为了4组，P0、P1、P2、P3，每组为<code>8个IO</code>，而且在P3组中每个IO都具备额外功能，只要通过相应的寄存器设置即可配置对应的附加功能，同一时刻，每个引脚只能使用该引脚的一个功能</p>
<h2 id="LED">LED</h2>
<h3 id="LED简介">LED简介</h3>
<p>LED（light-emitting diode），即 <code>发光二极管</code>，俗称LED小灯，是一种由磷化镓（GaP）等半导体材料制成的、能直接将电能转变成光能的发光显示件。当<code>LED内部有一定电流通过</code>时，它就会<code>发光</code>，不同LED能发出不同颜色的光，常见的有红色、黄色等。</p>
<h3 id="LED原理图">LED原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/ee2ff7ced41e4666b08613aec9d9bfe7.webp" style="zoom: 50%;" />
<h3 id="LED程序">LED程序</h3>
<blockquote>
<h4 id="控制LED闪烁">控制LED闪烁</h4>
</blockquote>
<p>因为是<code>正极流进来</code>，想要点亮LED灯所以要给<code>P2.0低电平</code>，单片机初始状态管脚默认为<code>高电平</code>，即对应值为<code>1</code>。所以如果想要点亮LED灯，只需要让他的管脚电平为<code>低电平</code>即可，即对应值为<code>0</code>。</p>
<p><code>LED.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：控制LED1灯闪烁</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_flicker</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    LED1 = <span class="number">0</span>;   <span class="comment">//LED1端口设置为低电平</span></span><br><span class="line">    delay_10us(<span class="number">50000</span>); </span><br><span class="line">    LED1 = <span class="number">1</span>;   <span class="comment">//LED1端口设置为高电平</span></span><br><span class="line">    delay_10us(<span class="number">50000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LED.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LED_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LED_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit LED1 = P2^<span class="number">0</span>; <span class="comment">//将p2^0管脚定义为LED1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============函数声明区=============*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_flicker</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        LED_flicker();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<blockquote>
<p>将所有的头文件放到AllHead.h，这样子就比较方便，直接在各个模块下调用这个头文件即可</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="LED流水灯">LED流水灯</h4>
</blockquote>
<p>~ 这个符号表示按位取反 （0变1 1变0）</p>
<p><code>LED.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：LED流水灯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_fall</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        LED_PORT = ~(<span class="number">0x01</span> &lt;&lt; i); <span class="comment">//0000 0001 左移i位 按位取反变成 1111 1110 （点亮第一个灯）以此类推循环8次</span></span><br><span class="line">        delay_10us(<span class="number">50000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LED.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LED_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LED_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_PORT    P2 <span class="comment">//宏定义P2端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============函数声明区=============*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_fall</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        LED_fall();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="用库函数写LED灯左右来回流水">用库函数写LED灯左右来回流水</h4>
</blockquote>
<p>还有一种流水灯的做法是用库函数：<code>#include “intrins.h”</code></p>
<p>crol_和_cror都是库函数，每次移动后不会自动补0而是把前面移出去的补到后面去</p>
<p><code>LED.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：用库函数写LED流水灯</span></span><br><span class="line"><span class="comment">_crol_函数（左移函数） ：参数一：用来控制位； 参数二：用来控制每次移动的位数</span></span><br><span class="line"><span class="comment">_cror_函数（右移函数） ：参数一：用来控制位； 参数二：用来控制每次移动的位数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_ku_fall</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    LED_PORT = ~<span class="number">0x01</span>;  <span class="comment">//先点亮第一个LED灯（0000 0001 按位取反 --&gt; 1111 1110） or 直接写0xfe</span></span><br><span class="line">    Delay1ms(<span class="number">500</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">7</span>;i++)               <span class="comment">//循环七次，因为灯一开始就点亮了</span></span><br><span class="line">    &#123;</span><br><span class="line">        LED_PORT = _crol_(LED_PORT,<span class="number">1</span>);   <span class="comment">//LED从左边开始每次移动一位</span></span><br><span class="line">                                         <span class="comment">//（1111 1110 向左移动一位 --&gt; 1111 1101）</span></span><br><span class="line">        Delay1ms(<span class="number">500</span>);                  <span class="comment">//延时500毫秒</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">7</span>;i++)               <span class="comment">//循环七次，因为灯一开始就点亮了</span></span><br><span class="line">    &#123;</span><br><span class="line">        LED_PORT = _cror_(LED_PORT,<span class="number">1</span>);   <span class="comment">//LED从右边开始每次移动一位</span></span><br><span class="line">                                          <span class="comment">//（0111 1111 向右移动一位 --&gt; 1011 1111）</span></span><br><span class="line">        Delay1ms(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LED.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LED_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LED_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_PORT    P2 <span class="comment">//宏定义P2端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============函数声明区=============*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_ku_fall</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        LED_ku_fall();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span>  <span class="comment">//库函数</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="蜂鸣器">蜂鸣器</h2>
<h3 id="蜂鸣器简介">蜂鸣器简介</h3>
<p>蜂鸣器：是一种一体化结构的电子讯响器，采用直流电压供电，分为 <code>压电式蜂鸣器</code> 和 <code>电磁式蜂鸣器</code>(无源和有源)， 51 开发板一般是 <code>压电式</code> 的蜂鸣器。</p>
<p>根据网上查的资料可以知道无源和有源的区别:</p>
<p><code>(1)有无震荡源</code></p>
<p>无源这里的“源”不是指电源，而是指<code>震荡源</code>。也就是说，有源蜂鸣器内部带震荡源，所以只要一通电就会叫。而无源内部不带震荡源，所以如果用直流信号无法令其鸣叫。</p>
<p><code>(2)价格不同</code></p>
<p>有源蜂鸣器往往比无源蜂鸣器<code>贵</code>，就是因为里面多个震荡电路。</p>
<p>怎么区分?</p>
<p><code>有绿色电路板的一种是无源蜂鸣器，没有电路板而用黑胶封闭的一种是有源蜂鸣器。</code></p>
<p>无源蜂鸣器通过<code>脉冲频率</code>才能发声。</p>
<h3 id="蜂鸣器原理图">蜂鸣器原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/81153a83819b4ce1a4dec41ea39ddf59.webp" style="zoom: 50%;" />
<p>从图中可以看出，蜂鸣器控制管脚直接连接到 51 单片机的 <code>P2.5</code> 管脚上。图中并没有使用三极管进行电流放大，而是使用 <code>ULN2003 芯片</code>来驱动，当 <code>P2.5</code> 输入<code>高电平</code>，<code>BEEP</code> 则输出<code>低电平</code>；当 <code>P2.5</code> 输入<code>低电平</code>，<code>BEEP</code> 则输出<code>高电平</code>，类似一个<code>非门</code></p>
<p>开发板上使用的是<code>无源蜂鸣器</code>，它需要<code>一定频率的脉冲</code>（高低电平)才会发声，因此<code>需要让 P2.5 脚以一定频率不断输出高低电平信号才能控制蜂鸣器发出声音</code></p>
<h3 id="蜂鸣器程序">蜂鸣器程序</h3>
<blockquote>
<h4 id="蜂鸣器发出声音，一段时间后关闭">蜂鸣器发出声音，一段时间后关闭</h4>
</blockquote>
<p><code>BEEP.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BEEP_Contral</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    u16 i = <span class="number">2000</span>; <span class="comment">//控制循环次数</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(i--)  <span class="comment">//循环2000次（循环2000次之后跳出循环）</span></span><br><span class="line">        &#123;</span><br><span class="line">            BEEP = !BEEP; <span class="comment">//产生一定频率的脉冲信号</span></span><br><span class="line">            Delay1ms(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        i = <span class="number">0</span>;      <span class="comment">//清零 赋0蜂鸣器就不会再响了</span></span><br><span class="line">        BEEP  = <span class="number">0</span>;  <span class="comment">//关闭蜂鸣器 赋0和1都行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BEEP.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _BEEP_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _BEEP_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit BEEP = P2^<span class="number">5</span>;  <span class="comment">//将P2.5管脚定义为BEEP</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BEEP_Contral</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        BEEP_Contral();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BEEP.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong>修改变量 i 的值可以改变蜂鸣器发声时间</strong></p>
<p>若要<code>改变音调</code>可以<code>修改延时时间</code>，但要注意频率不能太大或者太小，若要<code>改变音量</code>，可以<code>修改 BEEP 输出高电平时间</code></p>
<h2 id="数码管">数码管</h2>
<h3 id="数码管简介">数码管简介</h3>
<p>数码管是一种半导体发光器件，其基本单元是<code>发光二极管</code>。按发光二极管单元连接方式可分为<code>共阳极数码管</code>和<code>共阴极数码管</code></p>
<p><strong>共阳数码管</strong> 是指将<code>所有发光二极管的阳极接到一起形成公共阳极</code>(COM)的数码管，共阳数码管在应用时应将公共极 COM 接到+5V，当某一字段发光二极管的<code>阴极为低电平</code>时，相应字段就<code>点亮</code>，当某一字段的<code>阴极为高电平</code>时，相应字段就<code>不亮</code></p>
<p><strong>共阴数码管</strong> 是指将<code>所有发光二极管的阴极接到一起形成公共阴极</code>(COM)的数码管，共阴数码管在应用时应将公共极 COM 接到地线 GND 上，当某一字段发光二极管的<code>阳极为高电平</code>时，相应字段就<code>点亮</code>，当某一字段的<code>阳极为低电平</code>时，相应字段就<code>不亮</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/217fcff413b741fe9d84596889d3677f.webp" style="zoom: 50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f4eded5159394b4a88d68b28d11aec0f.webp" style="zoom: 50%;" />
<h3 id="数码表">数码表</h3>
<h4 id="共阴数码管码表">共阴数码管码表</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/bb3dbfeacf05457cbe25386d414f03e5.webp" style="zoom:67%;" />
<h4 id="共阳数码管码表">共阳数码管码表</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/940a73e91bda42df9689fd4e348bd0e6.webp" style="zoom:67%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f2ae309462ea43f0853818fd6966fd66.webp" style="zoom:67%;" />
<p>从上述共阳和共阴码表中不难发现，它们的数据正好是<code>相互取反</code>的值。比如共阴数码管数字 0 段码：0x3f，其二进制是：0011 1111，取反后为：1100 0000， 转换成 16 进制即为 0XC0。其他段码依此类推。该段码数据由来，是将 a 段作为最低位，b 段作为次低位，其他按顺序类推，dp 段为最高位，共 8 位，正好和 51 单片机的一组端口数一样，因此可以直接使用某一组端口控制数码管的段选数据口，比如 P0 口</p>
<h3 id="原理图">原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/596bb8217a604d33910495115d0b7b63.webp" style="zoom: 50%;" />
<h3 id="数码管显示">数码管显示</h3>
<p><strong>静态显示</strong>：多位数码管依然可以静态显示，但是<code>显示时要么只显示一位数码管，要么多位同时显示相同内容</code>。当多位数码管应用于某一系统时，它们的“位选”是可独立控制的，而“段选”是连接在一起的，我们可以通过位选信号控制哪几个数码管亮，而在同一时刻，位选选通的所有数码管上显示的数字始终都是一样的，因为它们的段选是连接在一起的，送入所有数码管的段选信号都是相同的，所以它们显示的数字必定一样，数码管的这种显示方法叫做<code>静态显示</code>。</p>
<p><strong>动态显示</strong>：就是利用<code>减少段选线，分开位选线</code>，利用位选线不同时选择通断，改变段选数据来实现的。比如在第一次选中第一位数码管时，给段选数据 0， 下一次位选中第二位数码管时显示 1。为了在显示 1 的时候，0 不会消失（当然实际上是消失了），必须在人肉眼观察不到的时间里再次点亮第一次点亮的 0。 而这时就需要记住，人的肉眼正常情况下只能分辨变化超过 24ms 间隔的运动。 也就是说，在下一次点亮 0 这个数字的时间差不得大于 24ms。这时就会发现， 数码管点亮是在向右或者向左一位一位点亮，形成了动态效果。如果把间隔时间改长就能直接展现这一现象。</p>
<h3 id="74HC245芯片">74HC245芯片</h3>
<p>74HC245 是一种<code>三态输出、八路信号收发器</code>，主要应用于大屏显示，以及其它的消费类电子产品中增加驱动。</p>
<p><strong>（1）主要特性</strong></p>
<p>①采用 CMOS 工艺<br>
②宽电压工作范围：3.0V-5.0V<br>
③双向三态输出<br>
④八线双向收发器<br>
⑤封装形式：SOP20、SOP20-2、TSSOP20、DIP20</p>
<p><strong>（2）管脚功能定义</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1017cfcafaa1420c8bf8dafb3c8d9de5.webp" style="zoom: 50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f50fb79a1a8043ca839b9153ef9cb510.webp" style="zoom: 50%;" />
<p>从上面的管脚功能定义说明及真值表可以知道该芯片使用方法很简单，给 <code>OE 使能管脚低电平</code>，<code>DIR 管脚为高电平</code>，传输方向是 <code>A-&gt;B， DIR 管脚为低电平</code>，传输方向是 <code>B-&gt;A</code>，至于输出高电平还是输出低电平取决于输入端的状态，如果<code>输入为低电平</code>，<code>输出即为低</code>；<code>输入为高电平</code>，<code>输出即为高</code>。如果 OE 使能管脚为高电平， 不论 DIR 管脚是高还是低，输出是高组态。 通常我们使用 74HC245 芯片用作驱动只会让其在<code>一个方向输出</code>，即 <code>DIR 管脚高电平，传输方向是 A--&gt;B</code></p>
<h3 id="74HC138-芯片">74HC138 芯片</h3>
<p>74HC138D 是一种<code>三通道输入、八通道输出</code>译码器，主要应用于消费类电子产品</p>
<p><strong>（1）主要特性</strong></p>
<p>①采用CMOS 工艺<br>
②低功耗<br>
③工作电压：3.0V-5.0V<br>
④封装形式：SOP16</p>
<p><strong>（2）管脚功能定义</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/75542afeff6c46a0814709d6a6ee08c7.webp" style="zoom: 50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e96d832c9b7a4360a2bb2c10204f8d11.webp" style="zoom:67%;" />
<p><code>头上有一横表示在低电平时有效</code><br>
真值：<br>
L：<strong>表示低电平0</strong><br>
H：<strong>表示高电平1</strong><br>
X：<strong>表示无论是高电平还是低电平都不影响真值</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5160ee5325034407a6e6e50cd3b52b95.webp" style="zoom: 50%;" />
<p>从上面的管脚功能定义说明及真值表可以知道该芯片使用方法很简单，给 <code>E1、E2 使能管脚低电平，E3 管脚为高电平</code>，至于哪个管脚输出有效电平（低电平），要看 A0，A1，A2 输入管脚的电平状态。如果 <code>A0，A1，A2 都为低电平</code>，则 <code>Y0 输出有效电平（低电平）</code>，其他管脚均输出高电平。如果 A0 为高电平，A1， A2 都为低电平，则 Y1 输出有效电平（低电平），其他管脚均输出高电平。如果 E1、E2 使能管脚任意一个为高电平或者 E3 为低电平，不论输入是什么，输出都为高电平。</p>
<blockquote>
<p>方法：<code>A0、A1、A2 输入就相当于 3 位 2 进制数，A0 是低位，A1 是次高位，A2 是高位。而 Y0-Y7 具体哪一个输出有效电平，就看输入二进制对应的十进制数值。比如输入是 101（A2，A1，A0），其对应的十进制数是 5，所以Y5输出有效电平（低电平）。</code></p>
</blockquote>
<h3 id="数码管程序">数码管程序</h3>
<h4 id="静态数码管实验">静态数码管实验</h4>
<blockquote>
<p>实验现象：下载程序后“数码管模块”最左边数码管显示数字 0</p>
</blockquote>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; </span><br><span class="line">                                                              <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    SMG_A_DP_PORT = gsmg_code[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="动态数码管实验">动态数码管实验</h4>
<blockquote>
<h5 id="从左到右显示数字1到7">从左到右显示数字1到7</h5>
</blockquote>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; </span><br><span class="line">                                                              <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(i)  <span class="comment">//位选（选择在第几个位置显示）</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = gsmg_code[i]; <span class="comment">//传输段选数据</span></span><br><span class="line">        Delay1ms(<span class="number">1</span>);                  <span class="comment">//延时1毫秒左右，等待显示稳定</span></span><br><span class="line">        SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        smg_display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h5 id="动态数码管显示日期">动态数码管显示日期</h5>
</blockquote>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; </span><br><span class="line">                                                              <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span>(location) <span class="comment">//位置</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">    &#125;</span><br><span class="line">    SMG_A_DP_PORT = gsmg_code[number]; <span class="comment">//传输段选数据</span></span><br><span class="line">    Delay1ms(<span class="number">1</span>);                  <span class="comment">//延时1毫秒左右，等待显示稳定</span></span><br><span class="line">    SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        smg_display(<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">        smg_display(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">        smg_display(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">        smg_display(<span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line">        smg_display(<span class="number">4</span>,<span class="number">0</span>);</span><br><span class="line">        smg_display(<span class="number">5</span>,<span class="number">7</span>);</span><br><span class="line">        smg_display(<span class="number">6</span>,<span class="number">1</span>);</span><br><span class="line">        smg_display(<span class="number">7</span>,<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="按键">按键</h2>
<h3 id="独立按键介绍">独立按键介绍</h3>
<p>按键是一种电子开关，使用时轻轻按开关按钮就可使开关接通，当松开手时, 开关断开</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6b1c272ae522463398b33d640e5f0f24.webp" style="zoom: 50%;" />
<p><code>“1，2”和“3，4”管脚之间距离短，初始不导通，“1，3”和“2，4”管脚之间距离长，初始值导通。</code></p>
<p>当按键按下时，<code>距离短的会变为导通，距离长的会变为不导通</code> ,所以就可以利用按键这一特性来控制其他的事物。</p>
<p>例如管脚1接单片机的一个引脚，管脚2接地。当按键被按下时，就会给这个引脚一个 <code>低电平</code> 。如果不按，单片机的这个引脚默认的是 <code>高电平</code> 。</p>
<p>但是按键一般都会抖动，所以要进行消抖： <code>硬件消抖和软件消抖</code></p>
<p>硬件消抖是通过 <code>充放电延时时间</code> 来进行消抖，但成本高，一个按键就需要（一个电阻与一个电源），所以 <code>一般选择软件消抖，软件消抖时间一般为 10ms</code> 。</p>
<p>按键管脚两端距离长的表示默认是导通状态，距离短的默认是断开状态， 如果按键按下，初始导通状态变为断开，初始断开状态变为导通。 通常的按键所用开关为机械弹性开关，当机械触点断开、闭合时，电压信号如下图所示</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5fc1be1391c2437d9468ea8d4e123aa6.webp" style="zoom:67%;" />
<h3 id="独立按键原理图">独立按键原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/531b251d0f3d45b7960397e8b92fe9ec.webp" style="zoom: 50%;" />
<h3 id="独立按键程序">独立按键程序</h3>
<blockquote>
<h4 id="独立按键控制LED亮灭">独立按键控制LED亮灭</h4>
</blockquote>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果mode=1则表示连续扫描按键 如果mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下(&amp;&amp;这个符号表示两个条件必须同时满足才能进入这个if语句）</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line">sbit LED1 = P2^<span class="number">0</span>; <span class="comment">//将p2^0管脚定义为LED1</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);     <span class="comment">//0代表单次扫描按键</span></span><br><span class="line">        <span class="keyword">if</span>(key == KEY1_PRESS)  <span class="comment">//如果按键K1按下</span></span><br><span class="line">        &#123;</span><br><span class="line">            LED1 = !LED1;   <span class="comment">//LED1状态翻转</span></span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="独立按键控制LED移动">独立按键控制LED移动</h4>
</blockquote>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果mode=1则表示连续扫描按键 如果mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下(&amp;&amp;这个符号表示两个条件必须同时满足才能进入这个if语句）</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">       u8 key = <span class="number">0</span>;</span><br><span class="line">       u8 LEDNum = ~<span class="number">0x01</span>; <span class="comment">//点亮第一个LED灯（因为下面程序直接LEDNum ++了，如果不先点亮第一个灯的话，上电之后按下按键1一开始是在第二个LED灯亮）</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);     <span class="comment">//0代表单次扫描按键</span></span><br><span class="line">        <span class="comment">//按键1控制LED1到LED8方向移动</span></span><br><span class="line">        <span class="keyword">if</span>(key == KEY1_PRESS)  <span class="comment">//如果按键K1按下</span></span><br><span class="line">        &#123;</span><br><span class="line">            LEDNum++;                  </span><br><span class="line">            <span class="keyword">if</span>(LEDNum &gt;= <span class="number">8</span>) <span class="comment">//如果移动大于或等于八位</span></span><br><span class="line">                LEDNum = <span class="number">0</span>; <span class="comment">//将移动位置清0</span></span><br><span class="line">            LED_PORT = ~(<span class="number">0x01</span> &lt;&lt; LEDNum); <span class="comment">//左移LEDNum位再进行取反 0000 0001 --&gt; 0000 0010(左移一位）</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//按键2控制LED8到LED1方向移动</span></span><br><span class="line">        <span class="keyword">if</span>(key == KEY2_PRESS)      <span class="comment">//如果按键K2按下</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(LEDNum == <span class="number">0</span>) <span class="comment">//如果移动位置为0则表示LED1亮</span></span><br><span class="line">                LEDNum = <span class="number">7</span>; <span class="comment">//让移动位置为7表示LED8亮</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                LEDNum--; </span><br><span class="line">            LED_PORT = ~(<span class="number">0x01</span> &lt;&lt; LEDNum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="独立按键控制数码管和蜂鸣器">独立按键控制数码管和蜂鸣器</h4>
</blockquote>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果mode=1则表示连续扫描按键 如果mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下(&amp;&amp;这个符号表示两个条件必须同时满足才能进入这个if语句）</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>, <span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; </span><br><span class="line">                                                               <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span>(location) <span class="comment">//位置</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">    &#125;</span><br><span class="line">    SMG_A_DP_PORT = gsmg_code[number]; <span class="comment">//传输段选数据</span></span><br><span class="line">    Delay1ms(<span class="number">1</span>);                  <span class="comment">//延时1毫秒左右，等待显示稳定</span></span><br><span class="line">    SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>BEEP.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BEEP_Time</span><span class="params">(u8 ms)</span>  <span class="comment">//参数传入数值多少毫秒</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; ms; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        BEEP = !BEEP; <span class="comment">//产生一定频率的脉冲信号</span></span><br><span class="line">        Delay1ms(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BEEP.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _BEEP_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _BEEP_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit BEEP = P2^<span class="number">5</span>;  <span class="comment">//将P2.5管脚定义为BEEP</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BEEP_Time</span><span class="params">(u8 ms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 key = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    smg_display(<span class="number">0</span>,<span class="number">0</span>); <span class="comment">//上机后在一个数码管显示0 </span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);     <span class="comment">//0代表单次扫描按键</span></span><br><span class="line">        <span class="keyword">if</span>(key)</span><br><span class="line">        &#123;</span><br><span class="line">            BEEP_Time(<span class="number">500</span>);</span><br><span class="line">            smg_display(<span class="number">0</span>,key);  <span class="comment">//在第一个数码管显示按键的值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BEEP.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="矩阵按键">矩阵按键</h3>
<h4 id="矩阵按键介绍">矩阵按键介绍</h4>
<p>在键盘中按键数量较多时，为了减少I/O口的占用，通常将按键排列成矩阵形式 采用逐行或逐列的“扫描”，就可以读出任何位置按键的状态。</p>
<h4 id="矩阵按键原理图">矩阵按键原理图</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/d93a53633fae4e12b60178c68e6b2a0f.webp" style="zoom:67%;" />
<h4 id="矩阵按键的实现">矩阵按键的实现</h4>
<p><code>行列描述法</code></p>
<p>先让一列为 <code>低电平</code>，其余几列全为<code>高电平</code>(此时我们确定了列数)，然后立即轮流检测一次各行是否有<code>低电平</code>， 若检测到某一行为<code>低电平</code>(这时我们又确定了行数)则我们便可确认当前被按下的键是哪一行哪一列的，用同样方法轮流送各列一次低电平，再轮流检测一次各行是否变为 <code>低电平</code> ，这样即可检测完所有的按键，当有键被按下时便可判断出按下的键是哪一个键。当然我们也可以将行线置<code>低电平</code>，扫描列是否有<code>低电平</code>。从而达到整个键盘的检测。</p>
<p><code>线翻转法</code></p>
<p>使所有行线为 <code>低电平</code> 时，检测所有列线是否有 <code>低电平</code> ，如果有，就<code>记录列线值</code>；然后再<code>翻转</code>，使所有列线都为 <code>低电平</code>，检测所有行线的值由于有按键按下，行线的值也会有变化，记录行线的值。从而就可以检测到全部按键。</p>
<h4 id="矩阵按键程序">矩阵按键程序</h4>
<blockquote>
<h5 id="行列扫描法-按下矩阵按键S1-S16-键，数码管显示-0-F">行列扫描法_按下矩阵按键S1-S16 键，数码管显示 0-F</h5>
</blockquote>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_matrix_ranks_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 使用行列式扫描方法，检测矩阵按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : key_value：1-16，对应 S1-S16 键，</span></span><br><span class="line"><span class="comment">0：按键未按下</span></span><br><span class="line"><span class="comment">****************************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_matrix_ranks_scan</span><span class="params">(<span class="type">void</span>)</span> <span class="comment">//行列式扫描函数</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key_value = <span class="number">0</span>;</span><br><span class="line">    KEY_MATRIX_PORT = <span class="number">0xf7</span>;  <span class="comment">//给第一列赋值0，其余全为1  1111 0111 --&gt; 0xf7</span></span><br><span class="line">    <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0xf7</span>)  <span class="comment">//判断第一列按键是否按下(若按下则矩阵按键控制管脚不等于0xf7)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        <span class="keyword">switch</span>(KEY_MATRIX_PORT) <span class="comment">//保存第一列按键按下后的键值</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x77</span>: key_value = <span class="number">1</span>;  <span class="keyword">break</span>; <span class="comment">//S1</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xb7</span>: key_value = <span class="number">5</span>;  <span class="keyword">break</span>; <span class="comment">//S5</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xd7</span>: key_value = <span class="number">9</span>;  <span class="keyword">break</span>; <span class="comment">//S9</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xe7</span>: key_value = <span class="number">13</span>; <span class="keyword">break</span>; <span class="comment">//S13</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(KEY_MATRIX_PORT != <span class="number">0xf7</span>); <span class="comment">//等待按键松开(松开矩阵按键控制管脚等于0xf7则退出循环)</span></span><br><span class="line">    </span><br><span class="line">    KEY_MATRIX_PORT = <span class="number">0xfb</span>;  <span class="comment">//给第二列赋值0，其余全为1  1111 1011 --&gt; 0xfb</span></span><br><span class="line">    <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0xfb</span>)  <span class="comment">//判断第二列按键是否按下(若按下则矩阵按键控制管脚不等于0xfb)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        <span class="keyword">switch</span>(KEY_MATRIX_PORT) <span class="comment">//保存第二列按键按下后的键值</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x7b</span>: key_value = <span class="number">2</span>;  <span class="keyword">break</span>;  <span class="comment">//S2</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xbb</span>: key_value = <span class="number">6</span>;  <span class="keyword">break</span>;  <span class="comment">//S6</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xdb</span>: key_value = <span class="number">10</span>;  <span class="keyword">break</span>; <span class="comment">//S10</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xeb</span>: key_value = <span class="number">14</span>; <span class="keyword">break</span>;  <span class="comment">//S14</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(KEY_MATRIX_PORT != <span class="number">0xfb</span>); <span class="comment">//等待按键松开(松开矩阵按键控制管脚等于0xfb则退出循环)</span></span><br><span class="line">    </span><br><span class="line">    KEY_MATRIX_PORT = <span class="number">0xfd</span>;  <span class="comment">//给第三列赋值0，其余全为1  1111 1101 --&gt; 0xfd</span></span><br><span class="line">    <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0xfd</span>)  <span class="comment">//判断第三列按键是否按下(若按下则矩阵按键控制管脚不等于0xfd)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        <span class="keyword">switch</span>(KEY_MATRIX_PORT) <span class="comment">//保存第三列按键按下后的键值</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x7d</span>: key_value = <span class="number">3</span>;  <span class="keyword">break</span>; <span class="comment">//S3</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xbd</span>: key_value = <span class="number">7</span>;  <span class="keyword">break</span>; <span class="comment">//S7</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xdd</span>: key_value = <span class="number">11</span>;  <span class="keyword">break</span>; <span class="comment">//S11</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xed</span>: key_value = <span class="number">15</span>; <span class="keyword">break</span>; <span class="comment">//S15</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(KEY_MATRIX_PORT != <span class="number">0xfd</span>); <span class="comment">//等待按键松开(松开矩阵按键控制管脚等于0xfd则退出循环)</span></span><br><span class="line">    </span><br><span class="line">    KEY_MATRIX_PORT = <span class="number">0xfe</span>;  <span class="comment">//给第四列赋值0，其余全为1  1111 1110 --&gt; 0xfe</span></span><br><span class="line">    <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0xfe</span>) <span class="comment">//判断第四列按键是否按下(若按下则矩阵按键控制管脚不等于0xfe)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        <span class="keyword">switch</span>(KEY_MATRIX_PORT) <span class="comment">//保存第四列按键按下后的键值</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0x7e</span>: key_value = <span class="number">4</span>;  <span class="keyword">break</span>; <span class="comment">//S4</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xbe</span>: key_value = <span class="number">8</span>;  <span class="keyword">break</span>; <span class="comment">//S8</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xde</span>: key_value = <span class="number">12</span>;  <span class="keyword">break</span>; <span class="comment">//S12</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0xee</span>: key_value = <span class="number">16</span>; <span class="keyword">break</span>; <span class="comment">//S16</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(KEY_MATRIX_PORT != <span class="number">0xfe</span>); <span class="comment">//等待按键松开(松开矩阵按键控制管脚等于0xfe则退出循环)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> key_value; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_MATRIX_PORT  P1  <span class="comment">//使用宏定义矩阵按键控制管脚</span></span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_matrix_ranks_scan</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key = <span class="number">0</span>;</span><br><span class="line">    u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;;  </span><br><span class="line">                                                                  <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_matrix_ranks_scan();        <span class="comment">//接收键值</span></span><br><span class="line">        <span class="keyword">if</span>(key != <span class="number">0</span>)                          <span class="comment">//要确保key不能为0 </span></span><br><span class="line">            SMG_A_DP_PORT = gsmg_code[key - <span class="number">1</span>]; <span class="comment">//数码管显示(得到的按键值减 1 换算成数组下标对应 0-F 段码)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h5 id="线翻转扫描法-按下矩阵按键S1-S16-键，数码管显示-0-F">线翻转扫描法_按下矩阵按键S1-S16 键，数码管显示 0-F</h5>
</blockquote>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_matrix_flip_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 使用线翻转扫描方法，检测矩阵按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : key_value：1-16，对应 S1-S16 键，</span></span><br><span class="line"><span class="comment">0：按键未按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_matrix_flip_scan</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">static</span> u8 key_value = <span class="number">0</span>; <span class="comment">//键值</span></span><br><span class="line">    KEY_MATRIX_PORT = <span class="number">0x0f</span>;  <span class="comment">//行为低电平，测试列 给所有行赋值0，列全为1  0000 1111 --&gt; 0x0f</span></span><br><span class="line">    <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0x0f</span>)  <span class="comment">//判断按键是否按下(若按下则矩阵按键控制管脚不等于0x0f)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        <span class="keyword">if</span>(KEY_MATRIX_PORT != <span class="number">0x0f</span>)</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">//测试列</span></span><br><span class="line">            KEY_MATRIX_PORT = <span class="number">0x0f</span>;  <span class="comment">//行为低电平，测试列 给所有行赋值0，列全为1  0000 1111 --&gt; 0x0f</span></span><br><span class="line">            <span class="keyword">switch</span>(KEY_MATRIX_PORT)  <span class="comment">//保存行为0，按键按下后的列值</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x07</span>: key_value = <span class="number">1</span>; <span class="keyword">break</span>; <span class="comment">//第一列 0000 0111 --&gt; 0x07</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x0b</span>: key_value = <span class="number">2</span>; <span class="keyword">break</span>; <span class="comment">//第二列 0000 1011 --&gt; 0x0b</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x0d</span>: key_value = <span class="number">3</span>; <span class="keyword">break</span>; <span class="comment">//第三列 0000 1101 --&gt; 0x0d</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x0e</span>: key_value = <span class="number">4</span>; <span class="keyword">break</span>; <span class="comment">//第四列 0000 1110 --&gt; 0x0e</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//测试行</span></span><br><span class="line">            KEY_MATRIX_PORT = <span class="number">0xf0</span>;  <span class="comment">//列为低电平，测试行 给所有行赋值1，列全为0  1111 0000 --&gt; 0xf0</span></span><br><span class="line">            <span class="keyword">switch</span>(KEY_MATRIX_PORT)  <span class="comment">//保存列为0，按键按下后的键值</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x70</span>: key_value = key_value;      <span class="keyword">break</span>;  <span class="comment">//第一行 0111 0000 --&gt; 0x70</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0xb0</span>: key_value = key_value + <span class="number">4</span>;  <span class="keyword">break</span>;  <span class="comment">//第二行 1011 0000 --&gt; 0xb0</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0xd0</span>: key_value = key_value + <span class="number">8</span>;  <span class="keyword">break</span>;  <span class="comment">//第三行 1101 0000 --&gt; 0xd0</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">0xe0</span>: key_value = key_value + <span class="number">12</span>; <span class="keyword">break</span>;  <span class="comment">//第四行 1110 0000 --&gt; 0xe0</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(KEY_MATRIX_PORT != <span class="number">0xf0</span>);  <span class="comment">//等待按键松开(松开矩阵按键控制管脚等于0xf0则退出循环)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        key_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> key_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_MATRIX_PORT  P1  <span class="comment">//使用宏定义矩阵按键控制管脚</span></span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_matrix_flip_scan</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key = <span class="number">0</span>;</span><br><span class="line">    u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_matrix_flip_scan();        <span class="comment">//接收键值</span></span><br><span class="line">        <span class="keyword">if</span>(key != <span class="number">0</span>)                          <span class="comment">//要确保key不能为0 </span></span><br><span class="line">            SMG_A_DP_PORT = gsmg_code[key - <span class="number">1</span>]; <span class="comment">//数码管显示(得到的按键值减 1 换算成数组下标对应 0-F 段码)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="LED点阵">LED点阵</h2>
<h3 id="LED点阵介绍">LED点阵介绍</h3>
<p>LED 点阵是由发光二极管排列组成的显示器件</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/0617d6aa17c04d7f9b2b6c0563634667.webp" style="zoom: 50%;" />
<p>8*8 点阵共由 64 个发光二极管组成，且每个发光二极管是放置在行线和列线的交叉点上，当对应的<code>某一行置 1 电平，某一列置 0 电平</code>，则<code>相应的二极管就亮</code>； 如要将第一个点点亮，则 1 脚接高电平 a 脚接低电平，则第一个点就亮了；如果 要将第一行点亮，则第 1 脚要接高电平，而（a、b、c、d、e、f、g、h ）这些引脚接低电平，那么第一行就会点亮；如要将第一列点亮，则第 a 脚接低电平， 而（1、2、3、4、5、6、7、8）接高电平，那么第一列就会点亮。</p>
<h3 id="LED点阵原理图">LED点阵原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/c097273903d84869b2a46564603aa9a6.webp" style="zoom: 50%;" />
<h3 id="74HC595-芯片介绍">74HC595 芯片介绍</h3>
<p>74HC595 是一个 <code>8 位串行输入、并行输出</code>的位移缓存器，其中并行输出为三态输出（即高电平、低电平和高阻抗）芯片管脚及功能说明如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/521414b0a1bd472f8fcd0870c13bf36a.webp" style="zoom: 40%;" />
<p><strong>芯片管脚功能</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/955ee63464074b73aa31b248ca3b434a.webp" style="zoom: 50%;" />
<p>74HC595 是具有 <code>8 位移位寄存器和一个存储器，三态输出功能</code>。移位寄存器和存储器是单独的时钟。<code>数据在 SCK 的上升沿输入，在 RCK 的上升沿进入到存储器中</code>。如果两个时钟连在一起，则移位寄存器总是比存储器早一个脉冲。移位寄存器有一个串行输入（DS），和一个串行输出（Q7 非），和一个异步的低电平复位，存储寄存器有一个并行 8 位的，具有三态的总线输出，当 <code>MR 为高电平，OE为低电平时，数据在 SHCP 上升沿进入移位寄存器，在 STCP 上升沿输出到并行端口</code>。</p>
<blockquote>
<p><strong>注意：74HC595是 <code>先传输字节的高位后传输低位</code>， 所以需要 <code>将字节低位移动到高位传输</code>，在传输数据时，要注意 <code>移位寄存器时钟和存储寄存器时钟的先后顺序</code>，将要写入的数据先传输到74HC595寄存器中，即在准备好每位数据时要将 <code>SRCLK进行一个上升沿变化</code>，此时即可将数据传输到寄存器内， 待 <code>循环8次即一个字节传输到寄存器中时</code>，就可以来一个<code>存储时钟上升沿</code>，此时就可以将74HC595寄存器中的数据全部一次<code>传输到595端口输出</code>。【要注意清除寄存器缓存的数据】</strong></p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/dc82d2d3e3c0416c90a18e51a2586ba4.webp" style="zoom: 67%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/525e8310f6014dbe9fa393877ba81e01.webp" style="zoom: 50%;" />
<h3 id="取字模软件">取字模软件</h3>
<p>双击打开该软件，首先选择“基本操作-&gt;新建图像”，设置图像的宽度和高度为8，点击确定后将在显示窗口出现一个8x8的白色格子，这个就类似于8x8LED 点阵，具体操作如下</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/22f71d4269a245639a8558f79e1fb483.webp" style="zoom: 30%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/39ebc5e1da884edf8e8f58586a5692f7.webp" style="zoom: 30%;" />
<p>可以看到上图 8*8 点阵区域非常小，我们可以将其放大，选择“模拟动画”， 后点击“放大格点”，<br>
如下所示</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5d802ea9148c4d8e91cb3c05156f65d8.webp" style="zoom:30%;" />
<p>然后可以在这个 8x8 白色格子里面点击，点击后即会在对应位置出现一个黑点，表示在 LED 点阵对应位置的 LED 灯点亮，未点击位置（白色）表示 LED 点阵对应位置的 LED 灯熄灭。 比如在 8x8LED 点阵上显示数字 0，那么可以在图中 8x8 白色框内通过点 击对应位置描出一个数字 0 的外形，如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/d35505e5381b4ae2be226f503eeb3a21.webp" style="zoom: 50%;" />
<p>然后设置取模数据的取模方式等内容，选择“参数设置”后点击“其他 选项”，具体操作如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/a4f098144dd14958bbedfdea961678fd.webp" style="zoom:33%;" />
<p>然后点击“取模方式”，选择 C51 格式选项，然后在点阵生成区自动会 生成数字字符对应的数据<br>
（如果是使用汇编编程，那么汇编对应的汉字数据可选择 A51 ）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/95b4a1b6bdfe465faf4813f1bcfec3a7.webp" style="zoom:33%;" />
<p>到这里我们就将数字0的数据生成了，然后将生成的数据复制到我们程序定义的数组中</p>
<h3 id="LED点阵实验">LED点阵实验</h3>
<h4 id="IO-扩展-串转并-实验-74HC595">IO 扩展(串转并)实验-74HC595</h4>
<blockquote>
<p>实验现象：下载程序后，8*8LED 点阵以一行循环滚动显示<br>
注意事项：<code>LED 点阵旁的 J24 黄色跳线帽短接到 GND 一端</code></p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/8b125458be214355bfcea9dbb851bbd8.webp" style="zoom: 25%;" />
<p>从上图中可以看出，74HC595 需要用到的控制管脚<code>SER、RCLK、SRCLK</code>直接连接到 51 单片机的 <code>P3.4-P3.6</code> IO 口上，输出端则是直接连接到 LED 点阵模块的<code>行端口</code>上，即为 LED 发光二极管的阳极，LED点阵的列则为发光二极管的阴极。 要想控制 LED 点阵，可以将单片机管脚按照 74HC595 芯片的通信时序要求来传输数据，这样即可控制 LED 点阵的行数据。根据 LED 发光二极管导通原理，当<code>阳极为高电平，阴极为低电平则点亮，否则熄灭</code>。因此通过单片机 P0 口可控制点阵列，74HC595 可控制点阵行。</p>
<p><code>Hc595.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : hc595_write_data(u8 dat)</span></span><br><span class="line"><span class="comment">* 函数功能 : 向 74HC595 写入一个字节的数据</span></span><br><span class="line"><span class="comment">* 输 入 : dat：数据</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次即可将一个字节写入移位寄存器中(该寄存器先传输高位）</span></span><br><span class="line">    &#123;</span><br><span class="line">        SER  = dat &gt;&gt; <span class="number">7</span>;     <span class="comment">//优先传输一个字节中的高位  1000 0000 --&gt; 0000 0001 (将高位移到最低位)</span></span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;           <span class="comment">//将低位移动到高位(将次高位移到最高位) </span></span><br><span class="line">        SRCLK = <span class="number">0</span>;        </span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">        SRCLK = <span class="number">1</span>;           <span class="comment">//移位寄存器时钟上升沿将端口数据送入寄存器中 (上升沿：先低位后高位 先=0,后=1)</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">    &#125;</span><br><span class="line">    rCLK = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    rCLK = <span class="number">1</span>;              <span class="comment">//存储寄存器时钟上升沿将前面写入到寄存器的数据输出 (上升沿：先低位后高位 先=0,后=1) </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hc595.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _HC595_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _HC595_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义74HC595控制管脚</span></span><br><span class="line">sbit SER = P3^<span class="number">4</span>;            <span class="comment">//串行数据输入</span></span><br><span class="line">sbit rCLK = P3^<span class="number">5</span>;           <span class="comment">//存储寄存器时钟输入</span></span><br><span class="line">sbit SRCLK = P3^<span class="number">6</span>;          <span class="comment">//移位寄存器时钟输入</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDZ_COL_PORT  P0  <span class="comment">//点阵列控制端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">  u8 i = <span class="number">0</span>;</span><br><span class="line">  u8 ghc595_buf[<span class="number">8</span>] = &#123;<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x04</span>,<span class="number">0x08</span>,<span class="number">0x10</span>,<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="number">0x80</span>&#125;;</span><br><span class="line">  LEDDZ_COL_PORT = <span class="number">0x00</span>;  <span class="comment">//将LED点阵列全部设置为0，即LED阴极为低电平</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            hc595_write_data(<span class="number">0x00</span>);  <span class="comment">//消除前面寄存器缓存数据</span></span><br><span class="line">            hc595_write_data(ghc595_buf[i]);  <span class="comment">//写入新的数据</span></span><br><span class="line">            Delay1ms(<span class="number">500</span>);   <span class="comment">//延时500ms</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc595.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="点亮一个点">点亮一个点</h4>
<blockquote>
<p>实验现象：下载程序后，8*8LED 点阵点亮左上角第一个点<br>
注意事项：<code>LED 点阵旁的 J24 黄色跳线帽短接到 GND 一端</code></p>
</blockquote>
<p><code>Hc595.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : hc595_write_data(u8 dat)</span></span><br><span class="line"><span class="comment">* 函数功能 : 向 74HC595 写入一个字节的数据</span></span><br><span class="line"><span class="comment">* 输 入 : dat：数据</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次即可将一个字节写入移位寄存器中(该寄存器先传输高位）</span></span><br><span class="line">    &#123;</span><br><span class="line">        SER  = dat &gt;&gt; <span class="number">7</span>;     <span class="comment">//优先传输一个字节中的高位  1000 0000 --&gt; 0000 0001 (将高位移到最低位)</span></span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;           <span class="comment">//将低位移动到高位(将次高位移到最高位) </span></span><br><span class="line">        SRCLK = <span class="number">0</span>;        </span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">        SRCLK = <span class="number">1</span>;           <span class="comment">//移位寄存器时钟上升沿将端口数据送入寄存器中 (上升沿：先低位后高位 先=0,后=1)</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">    &#125;</span><br><span class="line">    rCLK = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    rCLK = <span class="number">1</span>;              <span class="comment">//存储寄存器时钟上升沿将前面写入到寄存器的数据输出 (上升沿：先低位后高位 先=0,后=1) </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hc595.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _HC595_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _HC595_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义74HC595控制管脚</span></span><br><span class="line">sbit SER = P3^<span class="number">4</span>;            <span class="comment">//串行数据输入</span></span><br><span class="line">sbit rCLK = P3^<span class="number">5</span>;           <span class="comment">//存储寄存器时钟输入</span></span><br><span class="line">sbit SRCLK = P3^<span class="number">6</span>;          <span class="comment">//移位寄存器时钟输入</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDZ_COL_PORT  P0  <span class="comment">//点阵列控制端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">  LEDDZ_COL_PORT = <span class="number">0x7f</span>; ;<span class="comment">//将LED点阵左边第一列设置为0，即LED阴极为低电平，其余列为1，即高电平</span></span><br><span class="line">                          <span class="comment">// 0111 1111 --&gt; 0x7f</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        hc595_write_data(<span class="number">0x80</span>);<span class="comment">//将LED点阵上边第一行设置为1，即LED阳极为高电平，其余行为0，即低电平</span></span><br><span class="line">                                  <span class="comment">// 1000 0000 --&gt; 0x80</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc595.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="LED点阵显示图像“0”">LED点阵显示图像“0”</h4>
</blockquote>
<p><code>Hc595.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : hc595_write_data(u8 dat)</span></span><br><span class="line"><span class="comment">* 函数功能 : 向 74HC595 写入一个字节的数据</span></span><br><span class="line"><span class="comment">* 输 入 : dat：数据</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次即可将一个字节写入移位寄存器中(该寄存器先传输高位）</span></span><br><span class="line">    &#123;</span><br><span class="line">        SER  = dat &gt;&gt; <span class="number">7</span>;     <span class="comment">//优先传输一个字节中的高位  1000 0000 --&gt; 0000 0001 (将高位移到最低位)</span></span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;           <span class="comment">//将低位移动到高位(将次高位移到最高位) </span></span><br><span class="line">        SRCLK = <span class="number">0</span>;        </span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">        SRCLK = <span class="number">1</span>;           <span class="comment">//移位寄存器时钟上升沿将端口数据送入寄存器中 (上升沿：先低位后高位 先=0,后=1)</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">    &#125;</span><br><span class="line">    rCLK = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    rCLK = <span class="number">1</span>;              <span class="comment">//存储寄存器时钟上升沿将前面写入到寄存器的数据输出 (上升沿：先低位后高位 先=0,后=1) </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hc595.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _HC595_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _HC595_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义74HC595控制管脚</span></span><br><span class="line">sbit SER = P3^<span class="number">4</span>;            <span class="comment">//串行数据输入</span></span><br><span class="line">sbit rCLK = P3^<span class="number">5</span>;           <span class="comment">//存储寄存器时钟输入</span></span><br><span class="line">sbit SRCLK = P3^<span class="number">6</span>;          <span class="comment">//移位寄存器时钟输入</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDZ_COL_PORT  P0  <span class="comment">//点阵列控制端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 gled_row[<span class="number">8</span>] = &#123;<span class="number">0x00</span>,<span class="number">0x7C</span>,<span class="number">0x82</span>,<span class="number">0x82</span>,<span class="number">0x82</span>,<span class="number">0x7C</span>,<span class="number">0x00</span>,<span class="number">0x00</span>&#125;; <span class="comment">//LED点阵显示数字0的行数据(使用取字模软件)</span></span><br><span class="line">    u8 gled_col[<span class="number">8</span>] = &#123;<span class="number">0x7f</span>,<span class="number">0xbf</span>,<span class="number">0xdf</span>,<span class="number">0xef</span>,<span class="number">0xf7</span>,<span class="number">0xfb</span>,<span class="number">0xfd</span>,<span class="number">0xfe</span>&#125;; <span class="comment">//LED点阵显示数字0的列数据</span></span><br><span class="line">                  <span class="comment">//0111 1111 --&gt; 0x7f  1011 1111 --&gt; 0xbf  1101 1111 --&gt; 0xdf  1110 1111 --&gt; 0xef</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">       <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)              <span class="comment">//循环8次扫描8行、列</span></span><br><span class="line">        &#123;</span><br><span class="line">            LEDDZ_COL_PORT = gled_col[i];   <span class="comment">//传送列选数据</span></span><br><span class="line">            hc595_write_data(gled_row[i]);  <span class="comment">//传送行选数据 </span></span><br><span class="line">            Delay1ms(<span class="number">1</span>);                    <span class="comment">//延时一段时间，等待显示稳定</span></span><br><span class="line">            hc595_write_data(<span class="number">0x00</span>);         <span class="comment">//消影</span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc595.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>如果想要显示其他图案或者数字直接在<code>取模软件生成行的数据</code>复制就可以了</p>
<h4 id="LED点阵显示动画">LED点阵显示动画</h4>
<p>当我们了解了LED点阵屏显示图形后，就可以尝试用点阵屏来显示动画了，我们可以定义一个数组，把要显示的图形的数据存到数组里，然后逐个移动数据显示就变成了动画了</p>
<p><code>Hc595.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : hc595_write_data(u8 dat)</span></span><br><span class="line"><span class="comment">* 函数功能 : 向 74HC595 写入一个字节的数据</span></span><br><span class="line"><span class="comment">* 输 入 : dat：数据</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次即可将一个字节写入移位寄存器中(该寄存器先传输高位）</span></span><br><span class="line">    &#123;</span><br><span class="line">        SER  = dat &gt;&gt; <span class="number">7</span>;     <span class="comment">//优先传输一个字节中的高位  1000 0000 --&gt; 0000 0001 (将高位移到最低位)</span></span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;           <span class="comment">//将低位移动到高位(将次高位移到最高位) </span></span><br><span class="line">        SRCLK = <span class="number">0</span>;        </span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">        SRCLK = <span class="number">1</span>;           <span class="comment">//移位寄存器时钟上升沿将端口数据送入寄存器中 (上升沿：先低位后高位 先=0,后=1)</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);       </span><br><span class="line">    &#125;</span><br><span class="line">    rCLK = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    rCLK = <span class="number">1</span>;              <span class="comment">//存储寄存器时钟上升沿将前面写入到寄存器的数据输出 (上升沿：先低位后高位 先=0,后=1) </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//LED点阵显示函数 参数一：LED点阵列数 参数二：传输数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MatrixLED_ShowCol</span><span class="params">(u8 col,u8 dat)</span> </span><br><span class="line">&#123;</span><br><span class="line">    hc595_write_data(dat);</span><br><span class="line">    LEDDZ_COL_PORT = ~(<span class="number">0x80</span> &gt;&gt; col); <span class="comment">//LED点阵第一列向右移动 1000 0000 按位取反--&gt; 0111 1111</span></span><br><span class="line">    Delay1ms(<span class="number">1</span>);</span><br><span class="line">    LEDDZ_COL_PORT = <span class="number">0xff</span>; <span class="comment">//消影</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hc595.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _HC595_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _HC595_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义74HC595控制管脚</span></span><br><span class="line">sbit SER = P3^<span class="number">4</span>;            <span class="comment">//串行数据输入</span></span><br><span class="line">sbit rCLK = P3^<span class="number">5</span>;           <span class="comment">//存储寄存器时钟输入</span></span><br><span class="line">sbit SRCLK = P3^<span class="number">6</span>;          <span class="comment">//移位寄存器时钟输入</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDZ_COL_PORT  P0  <span class="comment">//点阵列控制端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hc595_write_data</span><span class="params">(u8 dat)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">MatrixLED_ShowCol</span><span class="params">(u8 col,u8 dat)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 offset = <span class="number">0</span>; <span class="comment">//偏移量Offset</span></span><br><span class="line">    u8 count = <span class="number">0</span>;</span><br><span class="line">    u8 gled_row[] = &#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">                     <span class="number">0x00</span>,<span class="number">0x7F</span>,<span class="number">0x08</span>,<span class="number">0x08</span>,<span class="number">0x08</span>,<span class="number">0x7F</span>,<span class="number">0x00</span>,<span class="number">0x1C</span>,</span><br><span class="line">                     <span class="number">0x2A</span>,<span class="number">0x2A</span>,<span class="number">0x2A</span>,<span class="number">0x18</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x7E</span>,<span class="number">0x01</span>,</span><br><span class="line">                     <span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x7E</span>,<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x1E</span>,<span class="number">0x21</span>,</span><br><span class="line">                     <span class="number">0x21</span>,<span class="number">0x1E</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x7D</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">                     <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,&#125;; <span class="comment">//LED点阵显示动画的行数据(使用取字模软件)</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            MatrixLED_ShowCol(i,gled_row[i + offset]); <span class="comment">//gled_row[i + offset] 为移动数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">if</span>(count &gt; <span class="number">10</span>) <span class="comment">//计次延时，不要用Delay,最好用定时器</span></span><br><span class="line">        &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">            offset++;</span><br><span class="line">            <span class="keyword">if</span>(offset &gt; <span class="number">40</span>) <span class="comment">//当超过数组的范围时偏移量清零</span></span><br><span class="line">                offset = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc595.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>做 LED 点阵实验时，一定要将 LED 点阵旁的 J24 黄色跳线帽短接到 GND 一端。</code>如下所示：</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/84e38448527e44eb87a9f502831d0e21.webp" style="zoom:50%;" />
<h3 id="16-16点阵">16*16点阵</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b719f20eefc942b89a1d2a07b091df60.webp" style="zoom: 33%;" />
<p>4片74HC595芯片，数据传入是 <code>第一个字节最终传到第4片，第二个字节最终传到第3片，第三个字节最终传到第2片，第四个字节最终传到第1片上。</code>（因为第一片8位满了后再传入的就会把前面的挤出去）</p>
<h2 id="直流电机">直流电机</h2>
<h3 id="直流电机介绍">直流电机介绍</h3>
<p>直流电机是指 <code>能将直流电能转换成机械能（直流电动机）或将机械能转换成直流电能（直流发电机的旋转电机)</code>。它是能实现直流电能和机械能互相转换的电机。当它作电动机运行时是直流电动机，将电能转换为机械能；作发电机运行时是直流发电机，将机械能转换为电能。</p>
<p>直流电机的结构应由 <code>定子和转子</code> 两大部分组成。直流电机运行时静止不动的部分称为定子；运行时转动的部分称为转子。 <code>直流电机没有正负之分</code> ，在两端加上直流电就能工作。需要知道直流电机的额定电压和额定功率，不能使之长时间超负荷运作。在交换接线后，可以形成正反转。</p>
<p><code>其内部相当于非门电路，即输入高输出为低，输入为低输出是高</code></p>
<p>外观实物图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/c49d8528d1dc41ea8d405c4f23ecc44e.webp" style="zoom:33%;" />
<p>其内部结构如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/283c8a4323d145cab91a45d4a3992eb8.webp" style="zoom: 50%;" />
<h3 id="ULN2003-芯片介绍">ULN2003 芯片介绍</h3>
<p>该芯片是一个单片高电压、高电流的达林顿晶体管阵列集成电路。不仅可以用来驱动直流电机，还可用来驱动<code>五线四相步进电机</code>，比如 28BYJ-48 步进电机。</p>
<p><strong>ULN2003 是一个单片高电压、高电流的达林顿晶体管阵列集成电路</strong>。它是由 7 对 NPN 达林顿管组成的，它的高电压输出特性和阴极箝位二极管可以转换感应负载。单个达林顿对的集电极电流是 500mA。达林顿管并联可以承受更大的电流。 此电路主要应用于继电器驱动器，字锤驱动器，灯驱动器，显示驱动器（LED 气体放电），线路驱动器和逻辑缓冲器。ULN2003 的每对达林顿管都有一个 2.7k 串联电阻，可以直接和 TTL 或 5V CMOS 装置。</p>
<p><strong><code>逻辑框图</code></strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1fcfa4437b2242dfbb0432a5667d54b2.webp" style="zoom: 33%;" />
<p>从上图可以很容易理解该芯片的使用方法，其内部相当于<code>非门电路</code>，即<code>输入高输出为低，输入为低输出是高</code>，这里要注意：因为 ULN2003 的输出是集电极开路，ULN2003 要输出高电平，必须在输出口外接上拉电阻。这也就能解释在后面连接直流电机时为什么不能直接将 ULN2003 的 2 个输出口接电机线，而必须一根线接电源，另一个才接 ULN2003 输出口。</p>
<p>若使用该芯片驱动直流电机，只可实现单方向控制，电机一端接电源正极， 另一端接芯片的输出口。若想控制五线四相步进电机，则可将四路输出接到步进电机的四相上，电机另一条线接电正极。</p>
<h3 id="直流电机实验">直流电机实验</h3>
<p><strong>（1）硬件设计</strong></p>
<blockquote>
<p>实验现象：下载程序后，直流电机旋转 5秒 后停止</p>
</blockquote>
<p>本实验使用到硬件资源如下：<br>
（1）步进电机驱动模块<br>
（2）直流电机</p>
<p>开发板上的步进电机驱动模块电路如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1c2f92387cd84a349625028f92b32687.webp" style="zoom:67%;" />
<p>从上图可知，ULN2003 的输入口与单片机的 <code>P1.0-P1.3</code> 连接，对应输出则是 <code>OUT1-OUT4</code>，而 <code>J47</code> 则是提供给外部连接电机的接口，可以支持直流电机、五线四相步进电机 28BYJ-48 连接。本实验使用的是<code>直流电机</code>，电机的一根线连接在 VCC 上，另一根连接在 OUT1 上，因此可通过单片机 <code>P1.0</code> 口<code>输出高电平</code>来<code>控制电机旋转</code>，<code>输出低电源控制电机停止</code>。</p>
<p><strong>注意：单片机 P1.0 输出低电平时，ULN2003 的 OUT1 并不会输出高电平导致停止，而是因为集电极开路，导致电机无电流流入致使停止。</strong></p>
<p><code>注意：直流电机的两根线要连接在 J47 端子的 O1 和 5V 上。如下所示：</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/a91b15e0f81a41aeb56283bdadac0992.webp" style="zoom:50%;" />
<p><strong>（2）软件设计</strong></p>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  sbit DC_Motor = P1^<span class="number">0</span>;             <span class="comment">//定义直流电机控制管脚</span></span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> DC_MOTOR_RUN_TIME  5000   <span class="comment">//定义直流电机运行时间为5000ms</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">  DC_Motor = <span class="number">1</span>;                 <span class="comment">//开启直流电机</span></span><br><span class="line">  Delay1ms(DC_MOTOR_RUN_TIME);</span><br><span class="line">  DC_Motor = <span class="number">0</span>;                 <span class="comment">//关闭直流电机</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="步进电机">步进电机</h2>
<h3 id="步进电机简介">步进电机简介</h3>
<p>步进电机是将<code>电脉冲信号转变为角位移或线位移</code>的开环控制元件。在非超载的情况下，电机的转速、停止的位置<code>只取决于脉冲信号的频率和脉冲数</code>，而<code>不受负载变化的影响</code>，即给电机加一个脉冲信号，电机则转过一个步距角。这一线性关系的存在，加上步进电机只有周期性的误差而无累计误差等特点。使得在速度、位置等控制领域用步进电机来控制变的非常的简单。</p>
<p><code>下图为混合式步进电机组成图</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/0eb51a3eb994442d87e5d2ba0b8d8963.webp" style="zoom:33%;" />
<h3 id="步进电机工作原理">步进电机工作原理</h3>
<p>通常步进电机的转子为永磁体，当电流流过定子绕组时，定子绕组产生一矢量磁场。输入一个电脉冲，电动机转动一个角度前进一步。它输出的角位移与输入的脉冲 数成正比、转速与脉冲频率成正比。改变绕组通电的顺序，电机就会反转。所以可以控制脉冲数量、频率及电动机各相绕组的通电顺序来控制步进电机的转动。 具体看下图：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/af53b8b5e6334243a3daad45db2e5c07.webp" style="zoom:33%;" />
<p>步进电机工作原理:当定子的矢量磁场旋转一个角度。转子也随着该磁场转步距角。每输入一个<code>电脉冲</code> ，电动机转动一个角度前进一步。它输出的角位移与输入的脉冲数成正比、转速与脉冲频率成正比。<code>改变绕组通电的顺序，电机就会反转</code> 。所以可以控制脉冲数量、频率及电动机各相绕维组的通电顺序来控制步进电机的转动。</p>
<h3 id="步进电机驱动原理">步进电机驱动原理</h3>
<p><strong>（1）双极性步进电机驱动原理</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/66ebfe1a62064723afd6df243fca808c.webp" style="zoom: 40%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A 相通电，B 相不通电 </span><br><span class="line">A、B 相全部通电，且电流相同，产生相同磁性 </span><br><span class="line">B 相通电，A 断电 </span><br><span class="line">B 相通电，A 相通电，且电流相等，产生相同磁性 </span><br><span class="line">A 相通电，B 断电 </span><br><span class="line">A、B 相全部通电，且电流相同，产生相同磁性 </span><br><span class="line">B 相通电，A 断电 </span><br><span class="line">B 相通电，A 相通电，且电流相等，产生相同磁性 </span><br></pre></td></tr></table></figure>
<p><code>其中 1~4 步与 5~8 步的电流方向相反（电流相反，电磁的极性就相反）这样就产生了顺时针旋转，同理逆时针是将通电顺序反过来即可</code></p>
<p><strong>（2）单极性步进电机驱动原理</strong></p>
<p>单极性与双极性步进电机驱动类似，都可以分为整步与半步的驱动方式，不同的是，<code>双极性的步进电机可以通过改变电流的方向来改变每相的磁场方向</code>，但是<code>单极性的就不可以</code>了，它有一个公共端，这就<code>直接决定了电流方向</code>。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/66ebfe1a62064723afd6df243fca808c.webp" style="zoom:40%;" />
<p>图中的通电顺序为：<code>A-&gt;AB-&gt;B-&gt;BC-&gt;C-&gt;CD-&gt;D-&gt;DA</code>， 转子每次只走半步 45 度，所以这也被称为半步驱动，与整步相比半步的旋转方式旋转起来更加的顺滑。</p>
<p><strong>（3）细分驱动原理</strong></p>
<p>对于细分驱动的原理，不分单双极性步进电机，下图以单极性为例：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5a98d6e78dd847a0a2b843d2bc3c3baf.webp" style="zoom:40%;" />
<p>在上图中均为双相激励；其中图（a）为 A 相电流很大，B 相的电流极其微弱，接近 0；图 © 为 A 相和 B 相的电流相同，电流决定磁场，所以说 A 相 和 B 相的磁场也是相同的，(a) 和（c）可以是极限特殊的情况，再看图（b） 和图（d）这两个是由于 A 相和 B 相的电流不同产生位置情况；由此可以得出改变定子的电流比例就可以使得转子在任意角度停住。细分的原理就是：<code>通过改变定子的电流比例，改变转子在一个整步中的不同位置，可以将一个整步分成多个小步来运行 。</code></p>
<p>在上图中就是一个整步分成了 4 步来跑，从（a）~（d）是 A 相的电流逐渐减小，B 相电流逐渐增大的过程，如果驱动器的细分能力很强，可以将其分成 32 细分、64 细分等；这不仅<code>提高了步进电机旋转的顺畅度而且提高了每步的精度</code>。细分驱动具有<code>转动顺畅、精度高、转矩大的特点，但控制复杂，一般需要专用芯片来实现</code>。</p>
<h3 id="步进电机技术指标">步进电机技术指标</h3>
<p><strong>（1）静态技术指标</strong></p>
<p>• <code>相数</code>：产生不同对极 N、S 磁场的激磁线圈对数，也可以理解为步进电机中线圈的组数，其中两相步进电机步距角为 1.8°，三相的步进电机步距角为 1.5°，相数越多的步进电机，其步距角就越小。</p>
<p>• <code>拍数</code>：完成一个磁场周期性变化所需脉冲数或导电状态用 n 表示，或指电机转过一个齿距角所需脉冲数，以四相电机为例，有四相四拍运行方式即 AB-BC-CD-DA-AB，四相八拍运行方式即 A-AB-B-BC-C-CD-D-DA-A。</p>
<p>• <code>步距角</code>：一个脉冲信号所对应的电机转动的角度，可以简单理解为一个脉冲信号驱动的角度，电机上都有写，一般 42 步进电机的步距角为 1.8°</p>
<p>• <code>定位转矩</code>：电机在不通电状态下，电机转子自身的锁定力矩（由磁场齿形 的谐波以及机械误差造成的）</p>
<p>• <code>静转矩</code>：电机在额定静态电压作用下，电机不作旋转运动时，电机转轴的锁定力矩。此力矩是衡量电机体积的标准，与驱动电压及驱动电源等无关</p>
<p><strong>（2）动态技术指标</strong></p>
<p>• <code>步距角精度</code>：步进电机转动一个步距角度的理论值与实际值的误差。用百分比表示：误差/步距角 *100%。</p>
<p>• <code>失步</code>：电机运转时运转的步数，不等于理论上的步数。也可以叫做丢步， 一般都是因负载太大或者是频率过快。</p>
<p>• <code>失调角</code>：转子齿轴线偏移定子齿轴线的角度，电机运转必存在失调角，由失调角产生的误差，采用细分驱动是不能解决的。</p>
<p>• <code>最大空载起动频率</code>：在不加负载的情况下，能够直接起动的最大频率。</p>
<p>• <code>最大空载的运行频率</code>：电机不带负载的最高转速频率。</p>
<p>• <code>运行转矩特性</code>：电机的动态力矩取决于电机运行时的平均电流（而非静态电流），平均电流越大，电机输出力矩越大，即电机的频率特性越硬</p>
<p>• <code>电机正反转控制</code>：通过改变通电顺序而改变电机的正反转</p>
<h3 id="28BYJ-48-步进电机简介">28BYJ-48 步进电机简介</h3>
<p>28BYJ48 步进电机自带减速器，为<code>四相无线步进电机</code>，直径为 28mm，实物如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/890d1c9dc9fc495cbf6e63768a8a5614.webp" style="zoom:33%;" />
<p>28BYJ48 电机内部结构等效图如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f7d81929dbca43caa29fe7b4869e7056.webp" style="zoom:50%;" />
<p>28BYJ48 步进电机旋转驱动方式如下表：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/d995fb7eb6844daebb2ccfbb01e41065.webp" style="zoom:50%;" />
<blockquote>
<p><code>28BYJ48步进电机本来为低电平驱动，但是使用的这个开发板是用ULN2003芯片控制步进电机管脚，相当于非门，所以得高电平才能驱动28BYJ48步进电机</code></p>
</blockquote>
<p>28BYJ48 步进电机主要参数如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b2ba3d61d5fa4114aad4dac518f7b002.webp" style="zoom:50%;" />
<p>在上图中 28BYJ48 步进电机主要参数中可以看到有一个减速比：1:64，步进角为 5.625/64 度，如果需要转动一圈，那么需要 360/5.625*64<code>4096</code> 个脉冲信号</p>
<p>28BYJ48 步进电机实际上是：<code>减速齿轮+步进电机</code>组成</p>
<h3 id="步进电机原理图">步进电机原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1af01face24742a68d577a58ed8304eb.webp" style="zoom:40%;" />
<h3 id="按键控制步进电机驱动实验">按键控制步进电机驱动实验</h3>
<blockquote>
<p>实验名称：步进电机实验<br>
实验现象：下载程序后，当按下 KEY1 键可调节电电机旋转方向;当按下 KEY2 键，电机加速;当按下 KEY3 键，电机减速</p>
</blockquote>
<p><code>step_motor.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : step_motor_28BYJ48_send_pulse</span></span><br><span class="line"><span class="comment">* 函数功能 : 输出一个数据给 ULN2003 从而实现向步进电机发送一个脉冲</span></span><br><span class="line"><span class="comment">* 输 入 : step：指定步进序号，可选值 0~7</span></span><br><span class="line"><span class="comment">          dir：方向选择,1：逆时针, 0：顺时针</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">step_motor_28BYJ48_send_pluse</span><span class="params">(u8 step, u8 dir)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 temp = step;</span><br><span class="line">    <span class="keyword">if</span>(dir == <span class="number">0</span>)            <span class="comment">//如果为顺时针旋转</span></span><br><span class="line">        temp = <span class="number">7</span> - step;    <span class="comment">//调换节拍信号</span></span><br><span class="line">  <span class="keyword">switch</span>(temp)              <span class="comment">//8 个节拍控制：D-&gt;DC-&gt;C-&gt;CB-&gt;B-&gt;BA-&gt;A-&gt;DA(高电平驱动)</span></span><br><span class="line">    &#123;      <span class="comment">//步进电机为低电平驱动，但是这个开发板用ULN2003芯片控制步进电机管脚,相当于非门，所以得高电平才能驱动步进电机</span></span><br><span class="line">                              </span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: IN4_A = <span class="number">0</span>;IN3_B = <span class="number">0</span>;IN2_C = <span class="number">0</span>;IN1_D = <span class="number">1</span>; <span class="keyword">break</span>; <span class="comment">//D</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: IN4_A = <span class="number">0</span>;IN3_B = <span class="number">0</span>;IN2_C = <span class="number">1</span>;IN1_D = <span class="number">1</span>; <span class="keyword">break</span>; <span class="comment">//DC</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: IN4_A = <span class="number">0</span>;IN3_B = <span class="number">0</span>;IN2_C = <span class="number">1</span>;IN1_D = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">//C</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: IN4_A = <span class="number">0</span>;IN3_B = <span class="number">1</span>;IN2_C = <span class="number">1</span>;IN1_D = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">//CB</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: IN4_A = <span class="number">0</span>;IN3_B = <span class="number">1</span>;IN2_C = <span class="number">0</span>;IN1_D = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">//B</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: IN4_A = <span class="number">1</span>;IN3_B = <span class="number">1</span>;IN2_C = <span class="number">0</span>;IN1_D = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">//BA</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: IN4_A = <span class="number">1</span>;IN3_B = <span class="number">0</span>;IN2_C = <span class="number">0</span>;IN1_D = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">//A</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>: IN4_A = <span class="number">1</span>;IN3_B = <span class="number">0</span>;IN2_C = <span class="number">0</span>;IN1_D = <span class="number">1</span>; <span class="keyword">break</span>; <span class="comment">//DA</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>step_motor.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _STEP_MOTOR_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _STEP_MOTOR_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义 ULN2003 控制步进电机管脚</span></span><br><span class="line">sbit IN1_D = P1^<span class="number">0</span>;</span><br><span class="line">sbit IN2_C = P1^<span class="number">1</span>;</span><br><span class="line">sbit IN3_B = P1^<span class="number">2</span>;</span><br><span class="line">sbit IN4_A = P1^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义步进电机速度（速度范围为1到5），值越小，速度越快(因为时间越短，速度越快)</span></span><br><span class="line"><span class="comment">// 最小不能小于1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEPMOTOR_MAXSPEED  1  <span class="comment">//最大速度所用时间</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEPMOTOR_MINSPEED  5  <span class="comment">//最小速度所用时间</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">step_motor_28BYJ48_send_pluse</span><span class="params">(u8 step, u8 dir)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果mode=1则表示连续扫描按键 如果mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key = <span class="number">0</span>;</span><br><span class="line">    u8 step = <span class="number">0</span>;</span><br><span class="line">    u8 dir = <span class="number">0</span>;  <span class="comment">//默认顺时针方向</span></span><br><span class="line">    u8 speed = STEPMOTOR_MAXSPEED; <span class="comment">//默认最大速度旋转</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(key == KEY1_PRESS)  <span class="comment">//按键1换向</span></span><br><span class="line">            dir = !dir;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY2_PRESS)  <span class="comment">//按键2加速</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(speed &gt; STEPMOTOR_MAXSPEED) <span class="comment">//如果该速度所用时间大于最大速度所用时间</span></span><br><span class="line">                speed -= <span class="number">1</span>;                    <span class="comment">//让速度所用时间-1，使其加速</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY3_PRESS)  <span class="comment">//按键3减速</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(speed &lt; STEPMOTOR_MINSPEED) <span class="comment">//如果该速度所用时间小于最大速度所用时间</span></span><br><span class="line">                speed += <span class="number">1</span>;                  <span class="comment">//让速度所用时间+1，使其减速</span></span><br><span class="line">        &#125;</span><br><span class="line">        step_motor_28BYJ48_send_pluse(step++,dir);</span><br><span class="line">        <span class="keyword">if</span>(step == <span class="number">8</span>)</span><br><span class="line">            step = <span class="number">0</span>;</span><br><span class="line">        Delay1ms(speed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;step_motor.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>注意：将步进电机红色线对接“步进电机模块” 输出端子 J47 的 5V 上，其它相序依次接入。 </code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e5468e5492fd4ba5998d1df24ebf6b72.webp" style="zoom: 33%;" />
<h2 id="中断">中断</h2>
<h3 id="中断概念">中断概念</h3>
<p>中断是为使单片机具有对外部或内部随机发生的事件实时处理而设置的， 中断功能的存在，很大程度上提高了单片机处理外部或内部事件的能力。对于单片机来讲，<code>中断是指 CPU 在处理某一事件 A 时，发生了另一事件 B， 请求 CPU 迅速去处理(中断发生)；CPU 暂时停止当前的工作(中断响应)， 转去处理事件 B(中断服务)；待 CPU 将事件 B 处理完毕后，再回到原来事件 A 被中断的地方继续处理事件 A(中断返回)</code>，这一过程称为中断。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/9c2562e62936441092e66ef8c5496eb5.webp" style="zoom:50%;" />
<p>单片机在执行程序时其程序流程图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/316f45862e5f451c92e0c28a49143ede.webp" style="zoom:50%;" />
<p>引起 CPU 中断的根源称为<code>中断源</code>。中断源向 CPU 提出中断请求，CPU 暂时中断原来的事务 A，转去处理事件 B，对事件 B 处理完毕后，再回到原来被中断的地方(即断点)，称为中断返回。实现上述中断功能的部件称为<code>中断系统</code>(中断机构)。</p>
<p>CPU总是先响应<code>优先级别最高</code>的中断请求。如果 CPU 能够暂停对原来中断源的服务程序，转而去处理优先级更高的中断请求源，处理完以后，再回到原低级中断服务程序，这样的过程称为 <code>中断嵌套</code>。这样的中断系统称为 <code>多级中断系统</code>，没有中断嵌套功能的中断系统称为<code>单级中断系统</code>。</p>
<p><code>中断优点：</code></p>
<p><strong>1、分时操作</strong><br>
CPU 可以分时为多个I/O 设备服务，提高了计算机的利用率;</p>
<p><strong>2、实时响应</strong><br>
CPU 能够及时处理应用系统的随机事件，系统的实时性大大增强;</p>
<p><strong>3、可靠性高</strong><br>
CPU具有处理设备故障及掉电等突发性事件能力，从而使系统可靠性提高</p>
<h3 id="中断结构">中断结构</h3>
<p>STC89C5X 系列单片机提供了 8 个中断请求源，它们分别是：<code>外部中断 0(INT0)、外部中断 1(INT1)、外部中断 2(INT2)、外部中断 3(INT3)、定时器 0 中断、定时器 1 中断、定时器 2 中断、串口(UART)中断</code>。</p>
<p>注意：51 系列单片机一定有基本的 5 个中断，但不全有 8 个中断，需要查看芯片手册，通常我们使用的都是基本的 5 个中断：<code>INT0、INT1、定时器 0/1，串口中断</code>。所有的中断都具有四个中断优先级（基本型只有两个）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">高优先级的中断请求可以打断低优先级的中断，反之，低优先级的中断请求不可以打断高优先级及同优先级的中断。</span><br><span class="line">当两个相同优先级的中断同时产生时，将由查询次序来决定系统先响应哪个中断。</span><br><span class="line">中断查询次序即为中断号，这个中断号在编程时非常重要，当中断来临时，只有中断号正确才能进入中断。</span><br></pre></td></tr></table></figure>
<p>STC89C5X 系列单片机的各个中断查询次序表如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/36dab1667f8d46f88828ce9c834ce12a.webp" style="zoom:40%;" />
<p>下面是51单片机均有的5个基本中断：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1605ecbc927f44d9b5570deb7f43b446.webp" style="zoom:40%;" />
<p>①<code>INT0</code> 对应的是 <code>P3.2</code> 口的附加功能，可由 <code>IT0</code>(TCON.0)选择其为<code>低电平有效还是下降沿有效</code>。当 CPU 检测到 <code>P3.2</code> 引脚上出现<code>有效的中断信号</code>时，中断标志<code>IE0(TCON.1)置 1</code>，向 CPU 申请中断。</p>
<p>②<code>INT1</code> 对应的是 <code>P3.3</code> 口的附加功能，可由 <code>IT1</code>(TCON.2)选择其为<code>低电平有效还是下降沿有效</code>。当 CPU 检测到 <code>P3.3</code> 引脚上出现<code>有效的中断信号</code>时，中断标志 <code>IE1(TCON.3)置 1</code>,向 CPU 申请中断。</p>
<p>③<code>T0</code> 对应的是 <code>P3.4</code> 口的附加功能，<code>TF0</code>（TCON.5）,片内<code>定时/计数器 T0 溢出中断请求标志</code>。当定时/计数器 <code>T0 发生溢出</code>时，<code>置位 TF0</code>，并向 CPU 申请中断。</p>
<p>④<code>T1</code> 对应的是 <code>P3.5</code> 口的附加功能，<code>TF1</code>（TCON.7），片内<code>定时/计数器 T1 溢出中断请求标志</code>。当定时/计数器 <code>T1 发生溢出</code>时，<code>置位 TF1</code>，并向 CPU 申请中断。</p>
<p>⑤<code>RXD 和 TXD</code> 对应的是 <code>P3.0 和 P3.1</code> 口的附加功能，<code>RI</code>（SCON.0）或 <code>TI</code> （SCON.1），<code>串行口中断请求标志</code>。当串行口<code>接收</code>完一帧串行数据时<code>置位 RI</code> 或当串行口<code>发送</code>完一帧串行数据时<code>置位 TI</code>，向 CPU 申请中断。</p>
<h3 id="中断相关寄存器">中断相关寄存器</h3>
<h4 id="中断允许控制">中断允许控制</h4>
<p>CPU 对中断系统所有中断以及某个中断源的开放和屏蔽是由<code>中断允许寄存器 IE</code> 控制的。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1d7123008257414596c7d8446488be4a.webp" style="zoom: 33%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EX0(IE.0)：外部中断 0 允许位； </span><br><span class="line">ET0(IE.1)：定时/计数器 T0 中断允许位； </span><br><span class="line">EX1(IE.2)：外部中断 1 允许位； </span><br><span class="line">ET1(IE.3)：定时/计数器 T1 中断允许位； </span><br><span class="line">ES（IE.4)：串行口中断允许位； </span><br><span class="line">EA (IE.7)：CPU 中断允许（总允许）位。</span><br></pre></td></tr></table></figure>
<h4 id="中断请求标志-TCON">中断请求标志 TCON</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/df5b77b6551c4296a21effebcfd29e1d.webp" style="zoom: 33%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IT0（TCON.0），外部中断 0 触发方式控制位。 当 IT0=0 时，为电平触发方式。 当 IT0=1 时，为边沿触发方式（下降沿有效）。 </span><br><span class="line">IE0（TCON.1），外部中断 0 中断请求标志位。 </span><br><span class="line">IT1（TCON.2），外部中断 1 触发方式控制位。 </span><br><span class="line">IE1（TCON.3），外部中断 1 中断请求标志位。 </span><br><span class="line">TF0（TCON.5），定时/计数器 T0 溢出中断请求标志位。 </span><br><span class="line">TF1（TCON.7），定时/计数器 T1 溢出中断请求标志位。</span><br></pre></td></tr></table></figure>
<h4 id="中断优先级">中断优先级</h4>
<p>同一优先级中的中断申请不止一个时，则有中断优先权排队问题。同一优先级的中断优先权排队，由中断系统硬件确定的自然优先级形成，其排列如所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e057d83d053f4ec89faec54d843cf66f.webp" style="zoom: 33%;" />
<h4 id="中断号">中断号</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/893408ff7c3145bd81e9ab5c4660791b.webp" style="zoom:50%;" />
<h4 id="中断响应条件">中断响应条件</h4>
<p>①中断源有中断请求；<br>
②此中断源的中断允许位为 1；<br>
③CPU 开中断（即 EA=1）。<br>
以上三条同时满足时，CPU 才有可能响应中断。</p>
<p><strong>在使用中断时我们需要做什么呢？</strong></p>
<p>①你想使用的中断是哪个？选择相应的中断号；<br>
②你所希望的触发条件是什么？<br>
③你希望在中断之后干什么？</p>
<h3 id="外部中断配置">外部中断配置</h3>
<p>以外部中断 0 为例，如下：</p>
<p>主程序中需要有以下代码</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/35cf194db4594c2a93ed46b48f4dbd14.webp" style="zoom:50%;" />
<p>如果要配置的是<code>外部中断 1</code>，只需将 <code>EX0</code> 改为 <code>EX1</code>，<code>IT0</code> 改为 <code>IT1</code>，通常使用外部中断都是配置为<code>下降沿触发</code>，即 IT0=1</p>
<p>当触发中断后即会进入<code>中断服务函数</code>，外部中断 0 中断服务函数如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/3e5f950116a846f5934f389134371781.png" style="zoom:50%;" />
<p>在中断函数中 exti0 是函数名，可自定义，但必须符合 C 语言标识符定义规则，<code>interrupt 是一个关键字</code>，表示 51 单片机中断。后面的 <code>0 是中断号</code>，外部中断 0 中断号为 0，如果是外部中断 1，则中断号为 2</p>
<blockquote>
<h3 id="程序–外部中断K3控制LED亮灭实验">程序–外部中断K3控制LED亮灭实验</h3>
</blockquote>
<p><code>EXTI.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  EXTI0_Init</span></span><br><span class="line"><span class="comment">  * @功能 : 外部中断0初始化</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI0_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IT0 = <span class="number">1</span>; <span class="comment">//跳变沿触发方式（下降沿）</span></span><br><span class="line">    EX0 = <span class="number">1</span>; <span class="comment">//打开 INT0 的中断允许</span></span><br><span class="line">    EA = <span class="number">1</span>;  <span class="comment">//打开总中断</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EXTI.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EXTI_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EXTI_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI0_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    EXTI0_Init(); <span class="comment">//进入外部中断函数</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @功能 : 外部中断0服务函数</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI0</span><span class="params">()</span> interrupt 0  <span class="comment">//外部中断0中断函数</span></span><br><span class="line">&#123;</span><br><span class="line">    Delay1ms(<span class="number">10</span>);   <span class="comment">//消抖</span></span><br><span class="line">    <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)   <span class="comment">//再次判断 K3 键是否按下</span></span><br><span class="line">        LED1 = !LED1; <span class="comment">//LED1状态翻转</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EXTI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>注意:由于红外接收传感器与 K3 共用 P3.2 口，因因此在做外部中断0实验时， 将红外接收传感器从开发板取下，防止干扰</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1bb5c9fa756543008bfdae5f806bf0ac.webp" style="zoom:50%;" />
<h2 id="定时器">定时器</h2>
<h3 id="CPU-时序">CPU 时序</h3>
<p>①振荡周期：为单片机提供定时信号的振荡源的周期（晶振周期或外加振荡周期）。</p>
<p>②状态周期：<code>2 个振荡周期为 1 个状态周期</code>，用 S 表示。振荡周期又称 S 周期或时钟周期。</p>
<p>③机器周期：<code>1 个机器周期含 6 个状态周期，12 个振荡周期</code>。</p>
<p>④指令周期：完成 1 条指令所占用的全部时间，它以机器周期为单位。</p>
<p>例如：外接晶振为 12MHz 时，51 单片机相关周期的具体值为：</p>
<p>振荡周期=1/12us;<br>
状态周期=1/6us;<br>
机器周期=1us;<br>
指令周期=1~4us</p>
<h3 id="定时器介绍">定时器介绍</h3>
<p>①51 单片机有两组定时器/计数器，因为<code>既可以定时，又可以计数</code>，故称之为定时器/计数器。<br>
②定时器/计数器和单片机的 CPU 是<code>相互独立</code>的。定时器/计数器工作的过程是自动完成的，<code>不需要 CPU 的参与</code>。<br>
③51 单片机中的定时器/计数器是根据机器内部的时钟或者是外部的脉冲信号对寄存器中的数据加 1。<br>
有了定时器/计数器之后，可以增加单片机的效率，一些简单的重复加 1 的 工作可以交给定时器/计数器处理。CPU 转而处理一些复杂的事情。同时可以实现精确定时作用。</p>
<h3 id="定时器原理">定时器原理</h3>
<p>STC89C5X 单片机内有两个可编程的定时/计数器 <code>T0、T1</code> 和一个特殊功能定时器 <code>T2</code>。定时/计数器的实质是加 1 计数器（16 位），<code>由高 8 位和低 8 位两个寄存器 THx 和 TLx 组成</code>。它随着计数器的输入脉冲进行<code>自加 1</code>，也就是每来一个脉冲，计数器就自动加 1，当加到计数器为全 1 时，再输入一个脉冲就使计数器回零，且<code>计数器的溢出使相应的中断标志位置 1</code>，向 CPU 发出中断请求（定时 /计数器中断允许时）。如果定时/计数器工作于<code>定时模式</code>，则表示<code>定时时间已到</code>； 如果工作于<code>计数模式</code>，则表示<code>计数值已满</code>。可见，由溢出时计数器的值减去计数初值才是加 1 计数器的计数值。</p>
<p><strong>51 单片机定时器/计数器内部结构图：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/fb0cd3e8d3a94f9a9ab09347715105a3.webp" style="zoom:40%;" />
<p>上图中的 <code>T0 和 T1</code> 引脚对应的是单片机 <code>P3.4 和 P3.5</code> 管脚</p>
<p><strong>计数器的工作由两个特殊功能寄存器控制</strong></p>
<p><strong>TMOD</strong> 是定时/计数器的<code>工作方式寄存器</code>，确定<code>工作方式和功能</code>；<br>
<strong>TCON</strong> 是<code>控制寄存器</code>，控制 <code>T0、T1</code> 的<code>启动</code>和<code>停止</code>及设置<code>溢出标志</code></p>
<h3 id="定时计数器寄存器">定时计数器寄存器</h3>
<h4 id="工作方式寄存器-TMOD">工作方式寄存器 TMOD</h4>
<p>工作方式寄存器 <code>TMOD</code> 用于设置定时/计数器的<code>工作方式</code>，<code>低四位用于 T0，高四位用于 T1</code>。</p>
<p>其格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/bad22bf466c545af8d2eb9d6e977b683.webp" style="zoom: 40%;" />
<p>GATE 是门控位, <code>GATE=0</code> 时，用于控制定时器的启动是否受外部中断源信号的影响。只要用软件使 <code>TCON 中的 TR0 或 TR1 为 1</code>，就可以启动定时/计数器工作；</p>
<p><strong>GATE＝1</strong> 时，要用软件使 <code>TR0 或 TR1 为 1</code>，<code>同时外部中断引脚 INT0/1 也为高电平</code>时，才能启动定时/计数器工作。即此时定时器的启动条件，加上了 INT0/1 引脚为高电平这一条件。</p>
<p>C/T ：定时/计数模式选择位。<code>C/T ＝0 为定时模式;C/T =1 为计数模式</code>。</p>
<p>M1M0：工作方式设置位。定时/计数器有<code>四种</code>工作方式。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f3041f95b92f45feb455a46a17682209.webp" style="zoom:40%;" />
<h4 id="控制寄存器-TCON">控制寄存器 TCON</h4>
<p>TCON 的<code>低 4 位用于控制外部中断</code>。TCON 的<code>高 4 位用于控制定时/计数器的启动和中断申请</code>。</p>
<p>其格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1c5374397e7b4c6d876b5019c2615205.webp" style="zoom:40%;" />
<p>TF1（TCON.7）：<code>T1 溢出中断请求标志位</code>。T1 计数溢出时由硬件自动置 TF1 为 1。CPU 响应中断后 TF1 由硬件自动清 0。T1 工作时，CPU 可随时查询 TF1 的状态。所以，TF1 可用作查询测试的标志。TF1 也可以用软件置 1 或清 0，同硬件置 1 或清 0 的效果一样。</p>
<p>TR1（TCON.6）：<code>T1 运行控制位</code>。TR1 置 1 时，T1 开始工作；TR1 置 0 时， T1 停止工作。TR1 由软件置 1 或清 0。所以，用软件可控制定时/计数器的启动与停止。</p>
<p>TF0（TCON.5）：<code>T0 溢出中断请求标志位</code>，其功能与 TF1 类同。</p>
<p>TR0（TCON.4）：<code>T0 运行控制位</code>，其功能与 TR1 类同。</p>
<h3 id="定时-计数器的工作方式">定时/计数器的工作方式</h3>
<p><strong>（1）方式 0</strong></p>
<p>方式 0 为 <code>13 位计数</code>，由 TL0 的低 5 位（高 3 位未用）和 TH0 的 8 位组成。 TL0 的低 5 位溢出时向 TH0 进位，<code>TH0 溢出</code>时，<code>置位</code> TCON 中的 <code>TF0</code> 标志</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/84729d51b33f49749d78a5b7ec7d9517.webp" style="zoom:37%;" />
<p>门控位 GATE 具有特殊的作用。当 <code>GATE=0</code> 时，经<code>反相</code>后使或门<code>输出为 1</code>，此时仅由 TR0 控制与门的开启，与门输出 1 时，控制开关接通，计数开始；</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/afc3484e045f49f39ac3ba1eb16b2c30.webp" style="zoom:40%;" />
<p>当<code>GATE=1</code> 时，由外中断引脚信号控制或门的输出，此时<code>控制与门的开启由外部中断引脚信号和 TR0 共同控制</code>。当 <code>TR0=1</code> 时，外部中断引脚信号引脚的<code>高电平启动计数</code>，外部中断引脚信号引脚的<code>低电平停止计数</code>。这种方式常用来测量外中断引脚上正脉冲的宽度。计数模式时，计数脉冲是 T0 引脚上的外部脉冲。</p>
<p>当 <code>GATE =  0</code> 时，经过 &quot;<code>非门</code>&quot;变成 1，然后再到 “<code>或门</code>”(只要一个为真，都为真)，这时候不管 INTO 引脚是否为真，然后来到 “与门”，这时候取决于 TR0,当 TR0 为1(真) 开关才会闭合工作。计数初值与计数个数的关系为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><msup><mn>2</mn><mn>13</mn></msup><mo>−</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">X=2^{13}-N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></p>
<p><strong>（2）方式 1</strong></p>
<p>方式 1 的计数位数是 <code>16 位</code>，由 <code>TL0 作为低 8 位，TH0 作为高 8 位</code>，组成了 16 位加 1 计数器</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/626289c8ef6045489409f9e52e1b1dc6.webp" style="zoom:40%;" />
<p>原理跟方式 0 差不多唯一不同的就是计数方式不同， 计数初值与计数个数的关系为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><msup><mn>2</mn><mn>16</mn></msup><mo>−</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">X=2^{16}-N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">16</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></p>
<p><strong>（3）方式 2</strong></p>
<p>方式 2 为自动重装初值的 <code>8 位</code>计数方式。工作方式 2 特别适合于用作较精确的脉冲信号发生器</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/3f5f24a5a236470387e536ed931e6950.webp" style="zoom:36%;" />
<p>计数初值与计数个数的关系为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><msup><mn>2</mn><mn>8</mn></msup><mo>−</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">X=2^8-N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></p>
<p><strong>（4）方式 3</strong></p>
<p>方式 3 只适用于<code>定时/计数器 T0</code>，定时器 T1 处于方式 3 时相当于 TR1=0， 停止计数。工作方式 3 将 T0 分成为两个独立的 8 位计数器 TL0 和 TH0。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/dcabfeb938774517bc5816db315b6200.png" style="zoom:40%;" />
<p>这几种工作方式中应用较多的是<code>方式 1 和方式 2</code>。<code>定时器</code>中通常使用定时器<code>方式 1</code>，<code>串口通信</code>中通常使用<code>方式 2</code></p>
<h3 id="定时器配置">定时器配置</h3>
<p>在使用定时器时，应该如何配置使其工作？其步骤如下（各步骤顺序可任意）：</p>
<p>①对 TMOD 赋值，以确定 T0 和 T1 的工作方式，如果使用定时器 0 即对 T0 配 置，如果使用定时器 1 即对 T1 配置。<br>
②根据所要定时的时间计算初值,并将其写入 TH0、TL0 或 TH1、TL1。<br>
③如果使用中断，则对 EA 赋值，开放定时器中断。<br>
④使 TR0 或 TR1 置位，启动定时/计数器定时或计数</p>
<p><strong>计算定时/计数器初值</strong></p>
<p>12MHz晶振情况下，1个机器周期=1us，假如需要定时1ms则</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1</mn><mi>m</mi><mi>s</mi><mi mathvariant="normal">/</mi><mn>1</mn><mi>u</mi><mi>s</mi><mo>=</mo><mn>1000</mn><mtext>次</mtext></mrow><annotation encoding="application/x-tex">1ms/1us=1000\text{次}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord">/1</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">1000</span><span class="mord text"><span class="mord cjk_fallback">次</span></span></span></span></span></span></p>
<p>溢出是65536，则用</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>65536</mn><mo>−</mo><mn>1000</mn><mo>=</mo><mn>64536</mn><mo>=</mo><mi>F</mi><mi>C</mi><mn>18</mn><mi>H</mi></mrow><annotation encoding="application/x-tex">65536-1000=64536=FC18H
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">65536</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1000</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">64536</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">FC</span><span class="mord">18</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span></span></p>
<p>所以初值为  <code>THx=0XFC，TLx=0X18</code>  或者使用小工具进行换算不用手动算。</p>
<p>开发板上使用的外部晶振不同，换算的初值是不一样的</p>
<p><strong>小工具</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/72d9b4a4851f443bb4f9dde0978e6f2a.webp" style="zoom:33%;" />
<p><strong>也可以使用STC-ISP里面的定时器计算器</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b51de9b5ea7647c199769bb9987671c8.webp" style="zoom: 50%;" />
<p>如果要实现很长时间的定时，比如定时 1 秒钟。可以通过初值设置定时 1ms，每当定时 1ms 结束后又重新赋初值，并且设定一个全局变量累计定时 1ms 的次数，当累计到 1000 次，表示已经定时 1 秒了。需要其他定时时间类似操作，这样我们就可以使用定时器来实现精确延时来替代之前的 delay 函数。</p>
<p><code>以定时器 0 为例介绍配置定时器工作方式 1、设定 1ms 初值，开启定时器计数功能以及总中断，如下</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">time0_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">TMOD|=<span class="number">0X01</span>;<span class="comment">//选择为定时器0模式，工作方式1(为了不干扰T1定时器所以用|);如果是定时器1则把0x01改成0x10</span></span><br><span class="line">TH0=<span class="number">0XFC</span>;  <span class="comment">//给定时器赋初值，定时 1ms;如果是定时器1则把TH0改成TH1</span></span><br><span class="line">TL0=<span class="number">0X18</span>;  <span class="comment">//如果是定时器1则把TL0改成TL1</span></span><br><span class="line">ET0=<span class="number">1</span>;     <span class="comment">//打开定时器 0 中断允许</span></span><br><span class="line">EA=<span class="number">1</span>;      <span class="comment">//打开总中断</span></span><br><span class="line">TR0=<span class="number">1</span>;     <span class="comment">//打开定时器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h3 id="程序–定时器0控制LED1秒闪烁">程序–定时器0控制LED1秒闪烁</h3>
</blockquote>
<p><code>time.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  Time0_Init</span></span><br><span class="line"><span class="comment">  * @功能 : 定时器0中断配置函数，通过设置 TH 和 TL 即可确定定时时间(使用工具可确定TH 与TL的值)</span></span><br><span class="line"><span class="comment">  * @返回值: 无                                                   晶振频率为11.0592</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMOD |= <span class="number">0x01</span>; <span class="comment">//选择为定时器0模式，工作方式1(为了不干扰T1定时器所以用|);如果是定时器1则把0x01改成0x10</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>; <span class="comment">//给定时器赋初值，定时1ms;如果是定时器1则把TH0改成TH1</span></span><br><span class="line">    TL0 = <span class="number">0X66</span>; <span class="comment">//如果是定时器1则把TL0改成TL1</span></span><br><span class="line">    ET0 = <span class="number">1</span>;    <span class="comment">//打开定时器0中断允许</span></span><br><span class="line">    EA = <span class="number">1</span>;     <span class="comment">//打开总中断</span></span><br><span class="line">    TR0 = <span class="number">1</span>;    <span class="comment">//打开定时器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>time.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EXTI_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EXTI_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    Time0_Init();   <span class="comment">//定时器0中断配置</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @功能 : 定时器0中断服务函数</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line">    </span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0</span><span class="params">()</span> interrupt 1 <span class="comment">//定时器0中断号为1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u16 count = <span class="number">0</span>; <span class="comment">//定义静态变量count</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>;           <span class="comment">//给定时器赋初值，定时1ms</span></span><br><span class="line">    TL0 = <span class="number">0X66</span>;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">if</span>(count == <span class="number">1000</span>)     <span class="comment">//1000ms=1s</span></span><br><span class="line">    &#123;</span><br><span class="line">        count = <span class="number">0</span>;          <span class="comment">//溢出然后重新赋0</span></span><br><span class="line">        LED1 = !LED1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="串口通信">串口通信</h2>
<h3 id="串口通信相关术语">串口通信相关术语</h3>
<p>通信的方式可以分为多种，按照数据<code>传送方式</code>可分为<code>串行通信</code>和<code>并行通信</code>。按照通信的数据<code>同步方式</code>，可分为<code>异同通信</code>和<code>同步通信</code>。按照数据的<code>传输方向</code>又可分为<code>单工</code>、<code>半双工</code>和<code>全双工通信</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">全双工：通信双方可以在同一时刻互相传输数据 </span><br><span class="line">半双工：通信双方可以互相传输数据，但必须分时复用一根数据线</span><br><span class="line">单工：通信只能有一方发送到另一方，不能反向传输 </span><br><span class="line">异步：通信双方各自约定通信速率 </span><br><span class="line">同步：通信双方靠一根时钟线来约定通信速率 </span><br><span class="line">总线：连接各个设备的数据传输线路(类似于一条马路，把路边各住户连接起来，使住户可以相互交流)</span><br></pre></td></tr></table></figure>
<p><strong>（1）串行通信</strong></p>
<p>串行通信是指<code>使用一条数据线，将数据一位一位地依次传输</code>，每一位数据占据一个固定的时间长度。其只需要少数几条线就可以在系统间交换信息，特别适用于计算机与计算机、计算机与外设之间的远距离通信。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/12589b57cc2a47c1affdd41ecc0572d6.webp" style="zoom:50%;" />
<p>串行通信的特点：传输线少，长距离传送时成本低，且可以利用电话网等现成的设备，但数据的传送控制比并行通信复杂。</p>
<p><strong>（2）并行通信</strong></p>
<p>并行通信通常是将数据字节的各位用<code>多条数据线同时进行传送</code>，通常是 8 位、16 位、32 位等数据一起传输。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/eb76b85de109425f89a0022265d39d70.webp" style="zoom:50%;" />
<p>并行通信的特点：控制简单、传输速度快；由于传输线较多，长距离传送时成本高且接收方的各位同时接收存在困难，抗干扰能力差。</p>
<p><strong>（3）异步通信</strong></p>
<p>异步通信是指<code>通信的发送与接收设备使用各自的时钟控制数据的发送和接收过程</code>。为使双方的收发协调，要求发送和接收设备的<code>时钟尽可能一致</code>。</p>
<p>异步通信是以<code>字符</code>（构成的帧）为单位进行传输，字符与字符之间的间隙（时间间隔）是任意的，但每个字符中的各位是以固定的时间传送的，即字符之间不 一定有“位间隔”的整数倍的关系，但同一字符内的各位之间的距离均为“ 位间隔”的整数倍。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/fc5638ed2f844a328d7f9072915d1992.webp" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/38440152295143bea5f60f3f1e33e727.webp" style="zoom:48%;" />
<p>异步通信的特点：不要求收发双方时钟的严格一致，实现容易，设备开销较小，但每个字符要附加 2～3 位用于起止位，各帧之间还有间隔，因此传输效率不高。</p>
<p><strong>（4）同步通信</strong></p>
<p>同步通信时要建立发送方时钟对接收方时钟的直接控制，使双方达到<code>完全同步</code>。此时，传输数据的位之间的距离均为“位间隔”的整数倍，同时传送的字符间不留间隙，即保持位同步关系，也保持字符同步关系。发送方对接收方的同步可以通过两种方法实现。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/8bc79b08ff0e4acbbe1bde31d7962602.webp" style="zoom:40%;" />
<p><strong>（5）单工通信</strong></p>
<p>单工是指数据传输仅能沿一个方向，不能实现反向传输。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/582511011b1b4a33b377a525926f366d.webp" style="zoom: 60%;" />
<p><strong>（6）半双工通信</strong></p>
<p>半双工是指数据传输可以沿两个方向，但需要分时进行。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/340c7cf2e06d4dc781916f3ac5f9c8b0.webp" style="zoom: 50%;" />
<p><strong>（7）全双工通信</strong></p>
<p>全双工是指数据可以同时进行双向传输。如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/942ed54e1b9d4c4f91630b3eb4c13d5c.webp" style="zoom: 50%;" />
<p><strong>（8）通信速率</strong></p>
<p>比特率是 <code>每秒钟传输二进制代码的位数</code>，单位是：<code>位／秒</code>（ bps）。如每秒钟传送 240 个字符，而每个字符格式包含 10 位(1 个起始位、1 个停止位、8 个数据位)，这时的比特率为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>10</mn><mtext>位</mtext><mo>×</mo><mn>240</mn><mtext>个/秒</mtext><mo>=</mo><mn>2400</mn><mi>b</mi><mi>p</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">10 \text{位} ×240 \text{个/秒} = 2400 bps
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord">10</span><span class="mord text"><span class="mord cjk_fallback">位</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">240</span><span class="mord text"><span class="mord cjk_fallback">个</span><span class="mord">/</span><span class="mord cjk_fallback">秒</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">2400</span><span class="mord mathnormal">b</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span></span></span></span></span></p>
<p>波特率： 它<code>表示每秒钟传输了多少个码元</code>。通信中常用时间间隔相同的符号来表示一个二进制数字，这样的信号称为码元。用 <code>0V 表示数字 0，5V 表示数字 1</code>，那么 <code>一个码元可以表示两种状态 0 和 1</code>，所以一个码元等于一个二进制比特位，此时波特率的大小与比特率一致；如果在通信传输中，有 0V、 2V、4V 以及 6V 分别表示二进制数 00、 01、 10、 11，那么每个码元可以表示四种状态，即两个二进制比特位，所以码元数是二进制比特位数的一半，这个时候的波特率为比特率的一半。由于很多常见的通信中一个码元都是表示两种状态，所以我们常常直接以 <code>波特率来表示比特率</code>。</p>
<h3 id="单片机串口介绍">单片机串口介绍</h3>
<p><strong>串口通信简介</strong></p>
<p>串口通信(Serial Communication)，是指外设和计算机间通过数据信号线、 地线等按位进行传输数据的一种通信方式，属于<code>串行通信方式</code>。串口是一种接口标准，它规定了接口的电气标准，没有规定接口插件电缆以及使用的协议。</p>
<p><strong>（1）接口标准</strong></p>
<p>串口通信的接口标准有很多，有 <code>RS-232C、 RS-232、 RS-422A、 RS-485</code> 等。常用的是 <code>RS-232</code> 和 <code>RS-485</code>。RS-232 其实是 RS-232C 的改进，原理是一样的。</p>
<p>RS-232C 接口规定使用 25 针连接器，简称 <code>DB25</code>，连接器的尺寸及每个插 针的排列位置都有明确的定义，如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/a411beda27bc4f4b83476d24130d25dc.webp" style="zoom:33%;" />
<p>RS-232C 还有一种 9 针的非标准连接器接口，简称 <code>DB9</code>。串口通信使用的大多都是 DB9 接口。DB25 和 DB9 接头有公头和母头之分，其中带针状的接头是公头，而带孔状的接头是母头。9 针串口线的外观图如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f090bc2db98a4124940dd32d27cbdc57.webp" style="zoom:50%;" />
<p>9 针串口和 25 针串口常用管脚的功能说明如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/2c322425649a462e95f6ffde5fbab684.webp" style="zoom:40%;" />
<p>在串口通信中，通常我们只使用 2、3、5 三个管脚，即 <code>TXD、RXD、SGND</code>。</p>
<p>RS-232C 是用<code>正负电压</code>来表示逻辑状态；与晶体管-晶体管逻辑集成电路（TTL）以高低电平表示逻辑状态的规定正好相反。而我们 51 单片机使用的就是 TTL 电平，所以要实现 51 单片机与计算机的串口通信，需要进行 TTL 与 RS-232C 电平转换，通常使用的电平转换芯片是 <code>MAX232</code>。</p>
<p>在串口通信中通常 <code>PC 机的 DB9 为公头</code>，单片机上使用的<code>串口 DB9 为母头</code>， 通过一根直通串口线进行相连。</p>
<p>串口通信中还需要注意的是，串口数据收发线要<code>交叉连接</code>，计算机的 TXD 要对应单片机的 RXD，计算机的 RXD 要对应单片机的 TXD，并且共 GND，如下图：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6ff4cd56f14244288541c8caed2780db.webp" style="zoom:50%;" />
<p><strong>（2）通信协议</strong></p>
<p><code>RS232 的通信协议比较简单，通常遵循 96-N-8-1 格式</code></p>
<p><code>“96”表示的是通信波特率为 9600</code></p>
<p>串口通信中通常使用的是 <code>异步串口通信</code>，即没有时钟线，所以两个设备要通信，必须要保持一致的波特率，当然，波特率常用值还有 4800、 115200 等。</p>
<p><code>“N”表示的是无校验位</code></p>
<p>由于串口通信相对更容易受到外部干扰导致传输数据出现偏差，可以在传输过程加上校验位来解决这个问题。校验方法有 <code>奇校验(odd)、偶校验(even)、0 校验(space)、1 校验(mark)以及无校验(noparity)</code>。</p>
<p><code>“8”表示的是数据位数为 8 位</code></p>
<p>当然数据位数还可以为 5、6、7 位长度</p>
<p><code>“1”表示的是 1 位停止位</code></p>
<p>串口通讯的一个数据包从起始信号开始，直到停止信号结束<code>。数据包的起始信号由 </code>一个逻辑 0<code>的数据位表示，而数据包的停止信号可由</code>0.5、1、1.5 或 2``` 个逻辑 1 的数据位表示，只要双方约定一致即可。</p>
<p><strong>（3）串口内部结构</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/22f6e2eed47a463f9a1eec0b64ab89a4.webp" style="zoom:40%;" />
<p>上图中右边的 <code>TXD</code> 和 <code>RXD</code> 为单片机 IO 口，<code>TXD</code> 对应的是 <code>P3.1</code> 管脚，<code>RXD</code> 对 应的是 <code>P3.0</code> 管脚。<code>SBUF 是存放数据</code>的，读取也是从这里读。</p>
<p>SBUF：<code>串口数据缓存寄存器</code>，物理上是两个独立的寄存器，但占用相同的地址。<code>写操作</code>时，写入的是<code>发送寄存器</code>，<code>读操作</code>时，读出的是<code>接收寄存器</code>。</p>
<h3 id="串口相关寄存器">串口相关寄存器</h3>
<h4 id="串口控制寄存器-SCON">串口控制寄存器 SCON</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/23e02182609a4ef99be73518dc8d9b1c.webp" style="zoom:40%;" />
<p>SM0 和 SM1 为工作方式选择位：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/d364ee2949db449393a4204dbe16648b.webp" style="zoom:38%;" />
<p><strong>SM2</strong>：<code>多机通信控制位，主要用于方式 2 和方式 3</code>。当 SM2=1 时可以利用收到的 RB8 来控制是否激活 RI（RB8＝0 时不激活 RI，收到的信息丢弃；RB8＝1 时收到的数据进入 SBUF，并激活 RI，进而在中断服务中将数据从 SBUF 读走）。当 SM2=0 时，不论收到的 RB8 为 0 和 1，均可以使收到的数据进入 SBUF，并激活 RI （即此时 RB8 不具有控制 RI 激活的功能）。通过控制 SM2，可以实现多机通信。</p>
<p><strong>REN</strong>：<code>允许串行接收位</code>。由软件置 REN=1，则启动串行口接收数据；若软件置REN=0，则禁止接收。</p>
<p><strong>TB8</strong>：在方式 2 或方式 3 中，是发送数据的第 9 位，可以用软件规定其作用。 可以用作数据的奇偶校验位，或在多机通信中，作为地址帧/数据帧的标志位。 在<code>方式 0 和方式 1</code> 中，该位未用到。</p>
<p><strong>RB8</strong>：在方式 2 或方式 3 中，是接收到数据的第 9 位，作为奇偶校验位或地址帧/数据帧的标志位。在<code>方式 1 时，若 SM2=0，则 RB8 是接收到的停止位</code>。</p>
<p><strong>TI</strong>：<code>发送中断标志位</code>。在方式 0 时，当串行发送第 8 位数据结束时，或在其它方式，串行发送停止位的开始时，由内部硬件使 TI 置 1，向 CPU 发中断申请。 在<code>中断服务程序</code>中，必须用<code>软件将其清 0</code>，取消此中断申请。</p>
<p><strong>RI</strong>：<code>接收中断标志位</code>。在方式 0 时，当串行接收第 8 位数据结束时，或在其它方式，串行接收停止位的中间时，由内部硬件使 RI 置 1，向 CPU 发中断申请。 也必须在<code>中断服务程序</code>中，用<code>软件将其清 0</code>，取消此中断申请。</p>
<h4 id="电源控制寄存器-PCON">电源控制寄存器 PCON</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/600fe4f75bde490a8b4213b260988a50.webp" style="zoom:40%;" />
<p><strong>SMOD</strong>：<code>波特率倍增位</code>。在串口方式 1、方式 2、方式 3 时，波特率与 SMOD 有 关，当 SMOD=1 时，波特率提高一倍。复位时，SMOD=0。</p>
<h3 id="串口工作方式">串口工作方式</h3>
<p><strong>（1）方式 0</strong></p>
<p>方式 0 时，串行口为同步移位寄存器的输入输出方式。主要用于扩展并行输 入或输出口。数据由 RXD（P3.0）引脚输入或输出，同步移位脉冲由 TXD（P3.1） 引脚输出。发送和接收均为 8 位数据，低位在先，高位在后。波特率固定为  <code>fosc/12</code>。</p>
<p>对应的输入输出时序图如下所示：</p>
<p><code>①方式 0 输出</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/4540685547c64ff8ac6bbd85a3486d11.webp" style="zoom:40%;" />
<p><code>②方式 0 输入</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/851068913ad44f7fa0378a7d93410d87.webp" style="zoom:40%;" />
<p><strong>（2）方式 1</strong></p>
<p>方式 1 是 <code>10 位</code>数据的异步通信口。<code>TXD 为数据发送引脚，RXD 为数据接收引脚</code>，传送一帧数据的格式如下所示。其中 1 位起始位，8 位数据位，1 位停止位。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/9139465b882e4533a2a7a21c029f2525.webp" style="zoom:40%;" />
<p>对应的输入输出时序图如下所示：</p>
<p><code>①方式 1 输出</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e3c16961f9c540a0a8dff85619dcde2f.webp" style="zoom:40%;" />
<p><code>②方式 1 输入</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/3c2c088a17484939a966da9c88d6c198.webp" style="zoom:40%;" />
<p>用软件置 <code>REN 为 1</code> 时，接收器以所选择波特率的 16 倍速率采样 RXD 引脚电平，检测到 RXD 引脚输入电平发生负跳变时，则说明起始位有效，将其<code>移入输入移位寄存器</code>，并开始接收这一帧信息的其余位。接收过程中，<code>数据从输入移位寄存器右边移入</code>，起始位移至输入移位寄存器最左边时，控制电路进行最后一次移 位。当 <code>RI=0，且 SM2=0</code>（或接收到的停止位为 1）时，将接收到的 9 位数据的前 <code>8 位数据装入接收 SBUF</code>，第 9 位（停止位）进入 RB8，并置 RI=1，向 CPU 请求中断。</p>
<p><strong>（3）方式2和方式3</strong></p>
<p>方式 2 或方式 3 时为 <code>11 位数据的异步通信</code>口。TXD 为数据发送引脚，RXD 为 数据接收引脚。其数据格式如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/0720f50bb03d4212a0a1be653a00431e.webp" style="zoom:40%;" />
<p>对应的输入输出时序图如下所示：</p>
<p><code>①方式 2、方式 3 输出</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6fd8289a630b4b429ce3b28c6fd59acf.webp" style="zoom:40%;" />
<p>发送开始时，先把起始位 0 输出到 TXD 引脚，然后发送移位寄存器的输出位 （D0）到 TXD 引脚。每一个移位脉冲都使输出移位寄存器的各位右移一位，并由 TXD 引脚输出。第一次移位时，停止位“1”移入输出移位寄存器的第 9 位上， 以后每次移位，左边都移入 0。当停止位移至输出位时，左边其余位全为 0，检测电路检测到这一条件时，使控制电路进行最后一次移位，并置 <code>TI=1</code>，向 CPU 请求中断。</p>
<p><code>②方式 2、方式 3 输入</code></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/186561b3330d44b784e78d8db356a0dc.webp" style="zoom:40%;" />
<p>接收时，数据从右边移入输入移位寄存器，在起始位 0 移到最左边时，控制电路进行最后一次移位。当 RI=0，且 SM2=0（或接收到的第 9 位数据为 1）时， 接收到的数据装入接收缓冲器 SBUF 和 RB8（接收数据的第 9 位），置 RI=1，向 CPU 请求中断。如果条件不满足，则数据丢失，且不置位 RI，继续搜索 RXD 引脚 的负跳变。</p>
<h3 id="串口的使用方法">串口的使用方法</h3>
<p><strong>计算波特率</strong></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>方式0的波特率</mtext><mo>=</mo><mi>f</mi><mi>o</mi><mi>s</mi><mi>c</mi><mi mathvariant="normal">/</mi><mn>12</mn></mrow><annotation encoding="application/x-tex">\text{方式0的波特率} = fosc/12
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord cjk_fallback">方式</span><span class="mord">0</span><span class="mord cjk_fallback">的波特率</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">osc</span><span class="mord">/12</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>方式2的波特率</mtext><mo>=</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow><mi>S</mi><mi>M</mi><mi>O</mi><mi>D</mi></mrow></msup><mi mathvariant="normal">/</mi><mn>64</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>o</mi><mi>s</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">\text{方式2的波特率} =(2^{SMOD}/64)\times fosc
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord cjk_fallback">方式</span><span class="mord">2</span><span class="mord cjk_fallback">的波特率</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">SMO</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span><span class="mord">/64</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">osc</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>方式1的波特率</mtext><mo>=</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow><mi>S</mi><mi>M</mi><mi>O</mi><mi>D</mi></mrow></msup><mi mathvariant="normal">/</mi><mn>32</mn><mo stretchy="false">)</mo><mo>×</mo><mtext>(T1 溢出率)</mtext></mrow><annotation encoding="application/x-tex">\text{方式1的波特率} =(2^{SMOD}/32)\times\text{(T1 溢出率)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord cjk_fallback">方式</span><span class="mord">1</span><span class="mord cjk_fallback">的波特率</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">SMO</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span><span class="mord">/32</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(T1 </span><span class="mord cjk_fallback">溢出率</span><span class="mord">)</span></span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>方式3的波特率</mtext><mo>=</mo><mo stretchy="false">(</mo><msup><mn>2</mn><mrow><mi>S</mi><mi>M</mi><mi>O</mi><mi>D</mi></mrow></msup><mi mathvariant="normal">/</mi><mn>32</mn><mo stretchy="false">)</mo><mo>×</mo><mtext>(T1 溢出率)</mtext></mrow><annotation encoding="application/x-tex">\text{方式3的波特率} =(2^{SMOD}/32)\times\text{(T1 溢出率)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord cjk_fallback">方式</span><span class="mord">3</span><span class="mord cjk_fallback">的波特率</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">SMO</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span><span class="mord">/32</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(T1 </span><span class="mord cjk_fallback">溢出率</span><span class="mord">)</span></span></span></span></span></span></p>
<p>其中 T1 溢出率 =</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mi>o</mi><mi>s</mi><mi>c</mi><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>12</mn><mo>×</mo><mo stretchy="false">(</mo><mn>256</mn><mo>−</mo><mo stretchy="false">(</mo><mi>T</mi><mi>H</mi><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">fosc /(12×(256 - (TH1)))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">osc</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">12</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">256</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord">1</span><span class="mclose">)))</span></span></span></span></span></p>
<blockquote>
<p>也可以用小工具自动生成波特率。在做串口通信实验时， 一定要确认外部晶振是否是 11.0592M。因为当使用12M 晶振时，波特率误差有 6.98%，会导致通信过程中出现乱码等错误信息</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e9203f479c0141a792d1d2e4c503eb22.webp" style="zoom:30%;" />
<h3 id="串口初始化步骤">串口初始化步骤</h3>
<p>如何使用串口，大家可以按照以下几个步骤配置</p>
<blockquote>
<p>①确定 T1 的工作方式（TMOD 寄存器）；<br>
②确定串口工作方式（SCON 寄存器）；<br>
③计算 T1 的初值（设定波特率），装载 TH1、TL1；<br>
④启动 T1（TCON 中的 TR1 位）；<br>
⑤如果使用中断，需开启串口中断控制位（IE 寄存器）。</p>
</blockquote>
<p>例如：设置串口为工作方式 1、波特率为 9600、波特率加倍、使用中断。其配置程序如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : uart_init</span></span><br><span class="line"><span class="comment">* 函数功能 : 串口通信中断配置函数，通过设置 TH 和 TL 即可确定定时时间</span></span><br><span class="line"><span class="comment">* 输 入 : baud：波特率对应的 TH、TL 装载值</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(u8 baud)</span></span><br><span class="line">&#123;</span><br><span class="line">TMOD|= <span class="number">0X20</span>;  <span class="comment">//设置计数器工作方式 2</span></span><br><span class="line">SCON = <span class="number">0X50</span>;  <span class="comment">//设置为工作方式 1</span></span><br><span class="line">PCON = <span class="number">0X80</span>;  <span class="comment">//波特率加倍</span></span><br><span class="line">TH1 = baud;   <span class="comment">//计数器初始值设置</span></span><br><span class="line">TL1 = baud;</span><br><span class="line">ES = <span class="number">1</span>;   <span class="comment">//打开接收中断</span></span><br><span class="line">EA = <span class="number">1</span>;   <span class="comment">//打开总中断</span></span><br><span class="line">TR1 = <span class="number">1</span>;  <span class="comment">//打开计数器</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在主函数中调用该函数并传入0XFA 值即可</span></span><br><span class="line">uart_init(<span class="number">0XFA</span>);<span class="comment">//波特率为 9600</span></span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/88ee872e113c42ac8b20cf7931edcb5c.png" style="zoom: 33%;" />
<h3 id="串口通信原理图">串口通信原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/90fabb5c708b4361ac67ee6dc165e159.png" style="zoom:30%;" />
<h3 id="串口通信实验">串口通信实验</h3>
<p><code>注意事项：使用黄色跳线帽将 CH340 旁的 P5 端子的 UTX 和 P30 短接，URX 和 P31 短接，出厂默认已短接好</code></p>
<blockquote>
<h4 id="串口助手发送数据给单片机，单片机原封不动转发给串口助手">串口助手发送数据给单片机，单片机原封不动转发给串口助手</h4>
</blockquote>
<p><code>Uart.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : uart_init</span></span><br><span class="line"><span class="comment">* 函数功能 : 串口通信中断配置函数，通过设置 TH 和 TL 即可确定定时时间</span></span><br><span class="line"><span class="comment">* 输 入 : baud：波特率对应的 TH、TL 装载值</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_Init</span><span class="params">(u8 baud)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMOD |= <span class="number">0X20</span>;  <span class="comment">//设置计数器工作方式 2  0010 0000 --&gt; 0x20</span></span><br><span class="line">    SCON = <span class="number">0X50</span>;   <span class="comment">//设置为工作方式 1      0101 0000 --&gt; 0x50</span></span><br><span class="line">    PCON = <span class="number">0X80</span>;   <span class="comment">//波特率加倍           1000 0000 --&gt; 0x80</span></span><br><span class="line">    TH1 = baud;    <span class="comment">//计数器初始值设置(使用小工具)</span></span><br><span class="line">    TH1 = baud;</span><br><span class="line">    ES = <span class="number">1</span>;        <span class="comment">//打开接收中断</span></span><br><span class="line">    EA = <span class="number">1</span>;        <span class="comment">//打开总中断</span></span><br><span class="line">    TR1 = <span class="number">1</span>;       <span class="comment">//打开计数器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Uart.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _UART_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _UART_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_Init</span><span class="params">(u8 baud)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    UART_Init(<span class="number">0xFA</span>);  <span class="comment">//波特率为 9600(使用串口小工具计算)</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart</span><span class="params">()</span> interrupt 4  <span class="comment">//串口通信中断服务函数</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 rec_data; </span><br><span class="line">    RI = <span class="number">0</span>;     <span class="comment">//串行接收停止位的中间时，内部硬件会将RI置1，要清除接收中断标志位，需要清0，取消此中断申请</span></span><br><span class="line">    rec_data = SBUF;    <span class="comment">//存储接收到的数据</span></span><br><span class="line">    SBUF = rec_data;    <span class="comment">//将接收到的数据放入到发送寄存器</span></span><br><span class="line">    <span class="keyword">while</span>(!TI);         <span class="comment">//等待发送数据完成(发送完成 TI 会自动置 1，!1为 0 则跳出循环)</span></span><br><span class="line">    TI = <span class="number">0</span>;     <span class="comment">//串行发送停止位的开始时，内部硬件会将TI置 1，要清除发送完成标志位，需要清0，取消此中断申请</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uart.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1e273603f99e435f8482430b45ddbc86.png" style="zoom: 30%;" />
<h4 id="串口控制led灯">串口控制led灯</h4>
<p><code>Uart.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : uart_init</span></span><br><span class="line"><span class="comment">* 函数功能 : 串口通信中断配置函数，通过设置 TH 和 TL 即可确定定时时间</span></span><br><span class="line"><span class="comment">* 输 入 : baud：波特率对应的 TH、TL 装载值</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_Init</span><span class="params">(u8 baud)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMOD |= <span class="number">0X20</span>;  <span class="comment">//设置计数器工作方式 2  0010 0000 --&gt; 0x20</span></span><br><span class="line">    SCON = <span class="number">0X50</span>;   <span class="comment">//设置为工作方式 1      0101 0000 --&gt; 0x50</span></span><br><span class="line">    PCON = <span class="number">0X80</span>;   <span class="comment">//波特率加倍           1000 0000 --&gt; 0x80</span></span><br><span class="line">    TH1 = baud;    <span class="comment">//计数器初始值设置(使用小工具)</span></span><br><span class="line">    TH1 = baud;</span><br><span class="line">    ES = <span class="number">1</span>;        <span class="comment">//打开接收中断</span></span><br><span class="line">    EA = <span class="number">1</span>;        <span class="comment">//打开总中断</span></span><br><span class="line">    TR1 = <span class="number">1</span>;       <span class="comment">//打开计数器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_SendByte</span><span class="params">(u8 Byte)</span>  <span class="comment">//写数据到SBUF </span></span><br><span class="line">&#123;</span><br><span class="line">    SBUF = Byte;  <span class="comment">//将数据写入串口数据缓存寄存器</span></span><br><span class="line">    <span class="keyword">while</span>(!TI);   <span class="comment">//等待发送数据完成 TI=1即为发送完成 (发送完成 TI 会自动置1，!1为 0 则跳出循环)</span></span><br><span class="line">    TI = <span class="number">0</span>;    <span class="comment">//串行发送停止位的开始时，内部硬件会将TI置1，要清除发送完成标志位，需要清0，取消此中断申请</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Uart.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _UART_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _UART_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_Init</span><span class="params">(u8 baud)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_SendByte</span><span class="params">(u8 Byte)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_PORT    P2 <span class="comment">//宏定义P2端口</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    UART_Init(<span class="number">0xFA</span>);  <span class="comment">//波特率为 9600(使用串口小工具计算)</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart</span><span class="params">()</span> interrupt 4  <span class="comment">//串口通信中断服务函数 (接收数据需要使用中断)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(RI == <span class="number">1</span>)      <span class="comment">//如果接收标志位为1，接收到了数据</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">//当接收到数据的时候，让控制led的P2端口等于串口数据缓冲寄存器中的值，从而实现串口控制led灯</span></span><br><span class="line">        LED_PORT = ~SBUF;    <span class="comment">//因为低电平 0 让灯亮，所以要取反</span></span><br><span class="line">        UART_SendByte(SBUF); <span class="comment">//将收到的数据发回串口</span></span><br><span class="line">        RI = <span class="number">0</span>;   <span class="comment">//串行接收停止位的中间时，内部硬件会将RI置1，要清除接收中断标志位，需要清0，取消此中断申请</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uart.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong>PC端发送数据</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b06e42dfc092439486b949e338a6ed94.webp" style="zoom: 40%;" />
<p><strong>现象</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1c35646f4fb64663a30abbff5a8458cd.webp" style="zoom: 40%;" />
<h2 id="I2C-EEPROM">I2C-EEPROM</h2>
<h3 id="存储器介绍">存储器介绍</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/7dd7b5016735405c8af1b5f91a14fe43.webp" style="zoom: 30%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/9e43d916547c43bf83cc582ad6a0a112.webp" style="zoom:22%;" />
<h3 id="I2C介绍">I2C介绍</h3>
<p>I2C是微电子通信控制领域广泛采用的一种总线标准。它是<code>同步通信</code>的一种特殊形式，具有接口线少，控制方式简单， 器件封装形式小，通信速率较高等优点。</p>
<p>I2C 总线只有两根双向信号线。一根是<code>数据线 SDA</code>，另一根是<code>时钟线 SCL</code>。由于其管脚少，硬件实现简单，可扩展性强等特点，因此被广泛的使用在各大集成芯片内。</p>
<p>I2C 通信设备常用的连接方式如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/07125cfa52364da4b525bd1aafb36aa5.webp" style="zoom:40%;" />
<p>它的物理层有如下特点：</p>
<p>（1）它是一个支持多设备的总线。“总线”指多个设备共用的信号线。在 一个 I2C 通讯总线中，可连接多个 I2C 通讯设备，支持多个通讯主机及多个通讯从机。</p>
<p>（2）一个 I2C 总线只使用两条总线线路，一条双向串行数据线(SDA)，一 条串行时钟线(SCL)。数据线即用来表示数据，时钟线用于数据收发同步。</p>
<p>（3）每个连接到总线的设备都有一个独立的地址，主机可以利用这个地址进行不同设备之间的访问。</p>
<p>（4）总线通过上拉电阻接到电源。当 I2C 设备空闲时，会输出高阻态，而当所有设备都空闲，都输出高阻态时，由上拉电阻把总线拉成高电平。</p>
<p>（5）多个主机同时使用总线时，为了防止数据冲突，会利用仲裁方式决定由哪个设备占用总线。</p>
<p>（6）具有三种传输模式：标准模式传输速率为 100kbit/s，快速模式为 400kbit/s，高速模式下可达 3.4Mbit/s，但目前大多 I2C 设备尚不支持高速模式。</p>
<p>（7）连接到相同总线的 IC 数量受到总线的最大电容 400pF 限制。</p>
<p><strong>I2C 总线常用的一些术语</strong></p>
<p>主机：启动数据传送并产生时钟信号的设备；</p>
<p>从机：被主机寻址的器件；</p>
<p>多主机：同时有多于一个主机尝试控制总线但不破坏传输；</p>
<p>主模式：用 I2CNDAT 支持自动字节计数的模式； 位 I2CRM,I2CSTT,I2CSTP 控制数据的接收和发送；</p>
<p>从模式：发送和接收操作都是由 I2C 模块自动控制的；</p>
<p>仲裁：是一个在有多个主机同时尝试控制总线但只允许其中一个控制总线并使传输不被破坏的过程；</p>
<p>同步：两个或多个器件同步时钟信号的过程；</p>
<p>发送器：发送数据到总线的器件；</p>
<p>接收器：从总线接收数据的器件。</p>
<h3 id="I2C-协议">I2C 协议</h3>
<p>I2C 的协议定义了<code>通信的起始和停止信号、数据有效性、响应、仲裁、时钟同步和地址广播</code>等环节。</p>
<p><strong>（1）数据有效性规定</strong></p>
<p>I2C 总线进行数据传送时，<code>时钟信号为高电平期间，数据线上的数据必须保持稳定</code>，只有在<code>时钟线</code>上的<code>信号为低电平</code>期间，<code>数据线</code>上的高电平或低电平状态才<code>允许变化</code>。每次数据传输都以<code>字节</code>为单位，每次传输的字节数不受限制。如下图：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/25f747bf1fa3423fb4f0ab045629a7e9.webp" style="zoom: 40%;" />
<p><strong>（2）起始和停止信号</strong></p>
<p>SCL 线为<code>高电平</code>期间，<code>SDA 线由高电平向低电平的变化表示起始信号</code>；<code>SCL</code> 线为<code>高电平</code>期间，<code>SDA 线由低电平向高电平的变化表示终止信号</code>。起始和终止信号都是由<code>主机</code>发出的，在起始信号产生后，总线就处于被占用的状态；在终止信号产生后，总线就处于空闲状态。如下图：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/56143584cafb4e4989d05bd05ef5a3eb.webp" style="zoom:40%;" />
<blockquote>
<p><strong>起始条件</strong>：SCL高电平期间，SDA从高电平切换到低电平<br>
<strong>终止条件</strong>：SCL高电平期间，SDA从低电平切换到高电平</p>
</blockquote>
<p><strong>（3）应答响应</strong></p>
<p>每当发送器件传输完一个<code>字节</code>的数据后，后面必须紧跟一个校验位，这个校验位是接收端通过控制 <code>SDA</code>（数据线）来实现的，以提醒发送端数据我这边已经接收完成，数据传送可以继续进行。这个校验位其实就是数据或地址传输过程中的响应。响应包括“<code>应答(ACK)”和“非应答(NACK)</code>”两种信号。作为数据接收端时，当设备(无论主从机)接收到 I2C 传输的一个字节数据或地址后，若希望对方继续发送数据，则需要向对方发送“应答(ACK)”信号即特定的低电平脉冲， 发送方会继续发送下一个数据；若接收端希望结束数据传输，则向对方发送“非应答(NACK)”信号即特定的高电平脉冲，发送方接收到该信号后会产生一个停止信号，结束信号传输。应答响应时序图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/183438e594b8460780b55facd4dd00b9.webp" style="zoom:40%;" />
<p>每一个字节必须保证 <code>8 位</code>长度。数据传送时，先<code>传送最高位</code>（MSB），每 一个被传送的字节后面都必须<code>跟随一位应答位</code>（即一帧共有 9 位）。这些信号中，<code>起始信号是必需的，结束信号和应答信号都可以不要</code>。</p>
<blockquote>
<p><code>发送应答</code>：在<code>接收</code>完一个字节之后，主机在下一个时钟发送一位数据，<code>数据0表示应答，数据1表示非应答</code><br>
<code>接收应答</code>：在<code>发送</code>完一个字节之后，<code>主机</code>在下一个时钟接收一位数据，判断从机是否应答，<code>数据0表示应答，数据1表示非应答(主机在接收之前，需要释放SDA)</code></p>
</blockquote>
<p><strong>（4）总线的寻址方式</strong></p>
<p>I2C 总线寻址按照从机地址位数可分为两种，<code>一种是 7 位，另一种是 10 位</code>。采用 7 位的寻址字节（寻址字节是起始信号后的第一个字节）的位定义如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/33393f28ff184d1187c74acbe0c2e342.webp" style="zoom:50%;" />
<p>D7～D1 位组成从机的<code>地址</code>。D0 位是数据传送方向位，为“ <code>0</code>”时表示<code>主机向从机写数据</code>，为“<code>1</code>”时表示<code>主机由从机读数据</code>。在一个系统中可能希望接入多个相同的从机，从机地址中可编程部分决定了可接入总线该类器件的最大数目。如一个从机的 <code>7 位寻址位有 4 位是固定位，3 位是可编程位</code>，这时仅能寻址 8 个同样的器件，即可以有 8 个同样的器件接入到该 I2C 总线系统中。</p>
<p><strong>（5）数据传输</strong></p>
<p>I2C 总线上传送的数据信号是广义的，既包括地址信号，又包括真正的数据信号。在起始信号后必须传送一个从机的地址（7 位），第 8 位是数据的传送方向位（R/W），<code>用“ 0”表示主机发送（写）数据（W），“ 1”表示主机接收数据（R)</code>。每次数据传送总是由主机产生的终止信号结束。但是，若主机希望继续占用总线进行新的数据传送，则可以不产生终止信号，马上再次发出起始信号对另一从机进行寻址。</p>
<p>AT24C02的固定地址为<code>1010</code>，可配置地址本开发板上为<code>000</code>，所以addr + W为<code>0xA0</code>，addr + R为<code>0xA1</code>。</p>
<p>在总线的一次数据传送过程中，可以有以下几种组合方式：</p>
<p><strong>a、主机向从机发送数据，数据传送方向在整个传送过程中不变</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/ea985b6707c4464bace1b99f5147c7f4.webp" style="zoom:50%;" />
<blockquote>
<p>注意：有<code>阴影部分</code>表示数据由<code>主机向从机传送</code>，<code>无阴影部分</code>则表示数据由<code>从机向主机传送</code>。A 表示应答，A 非表示非应答（高电平）。S 表示起始信号，P 表示终止信号。</p>
</blockquote>
<p><strong>b、主机在第一个字节后，立即从从机读数据</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/81ccd6e1aab94baab9b15eac069f5fbd.webp" style="zoom:55%;" />
<p><strong>c、在传送过程中，当需要改变传送方向时，起始信号和从机地址都被重复产生一次，但两次读/写方向位正好相反</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6f63a77db5de4cf494a5863783726abe.webp" style="zoom:50%;" />
<blockquote>
<p><strong>发送一个字节</strong>：SCL低电平期间，主机将数据位依次放到SDA线上(高位在前)，然后拉高SCL，从机将在SCL高电平期间读取数据位，所以SCL高电平期间SDA不允许有数据变化，依次循环上述过程8次，即可发送一个字节。<br>
<strong>接收一个字节</strong>：SCL低电平期间，从机将数据位依次放到SDA线上(高位在前)，然后拉高SCL，主机将在SCL高电平期间读取数据位，所以SCL高电平期间SDA不允许有数据变化，依次循环上述过程8次，即可接收一个字节(主机在接收之前，需要释放SDA)。</p>
</blockquote>
<h3 id="AT24C02-介绍（EEPROM">AT24C02 介绍（EEPROM)</h3>
<blockquote>
<p>AT24C02是一种可以实现<code>掉电不丢失的存储器</code>，可用于保存单片机运行时想要永久保存的数据信息<br>
存储介质:<code>E2PROM</code><br>
通讯接口:<code>I2C</code><br>
总线容量:256字节</p>
</blockquote>
<p>AT24C01/02/04/08/16…是一个 1K/2K/4K/8K/16K 位串行 CMOS，内部含有128/256/512/1024/2048 个 8 位字节，<code>AT24C01</code> 有一个 <code>8 字节页写缓冲器</code>， <code>AT24C02/04/08/16</code> 有一个 <code>16 字节页写缓冲器</code>。该器件通过 <code>I2C 总线</code>接口进行操作，它有一个专门的写保护功能。我们开发板上使用的是 <code>AT24C02（EEPROM） 芯片</code>，此芯片具有 I2C 通信接口，芯片内保存的数据在掉电情况下都不丢失， 所以通常用于存放一些比较重要的数据等。AT24C02 芯片管脚及外观图如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/2a96ae58e1664232ad761d9feae90f86.webp" style="zoom:50%;" />
<p>芯片管脚说明如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5424b3f1f2ab4e2381d9a195a3c99b3e.webp" style="zoom:40%;" />
<p>AT24C02 器件地址为<code>7 位</code>，<code>高 4 位固定为 1010，低 3 位由 A0/A1/A2 信号线的电平决定</code>。 因为传输地址或数据是以<code>字节</code>为单位传送的，当传送地址时， 器件地址占 7 位，还有最后一位（最低位 R/W）用来选择读写方向，它与地址无关。其格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/88146c448b6e4436a252385427cb3c64.webp" style="zoom:50%;" />
<p>开发板已经将芯片的 <code>A0/A1/A2 连接到 GND</code>，所以器件地址为 1010000，即 <code>0x50</code>（未计算最低位）。如果要对芯片进行<code>写操作</code>时，R/W 即为 0， 写器件地址即为 <code>0XA0</code>；如果要对芯片进行<code>读操作</code>时，R/W 即为 1，此时读器件地址为 <code>0XA1</code>。</p>
<p>I2C 总线时序如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1b615de834414362ac4e636fc90d9e95.png" style="zoom:40%;" />
<h3 id="EEPROM原理图">EEPROM原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/826ef87e7e504f6e8ce9c6dac8ee38fe.webp" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/424bbfb71f5d43f6b5361476f1a60861.webp" style="zoom:45%;" />
<h3 id="I2C-EEPROM实验">I2C-EEPROM实验</h3>
<blockquote>
<h4 id="下载程序后，数码管右-4-位显示-0，按-K1-键将将数据写入到-EEPROM-内保存，按-K2-键读取-EEPROM-内保存的数据，按-K3-键显示数据加-1，按-K4-键显示数据清零，最大能写入的数据是-255">下载程序后，数码管右 4 位显示 0，按 K1 键将将数据写入到 EEPROM 内保存，按 K2 键读取 EEPROM 内保存的数据，按 K3 键显示数据加 1，按 K4 键显示数据清零，最大能写入的数据是 255</h4>
</blockquote>
<p><strong>第一种写法</strong></p>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果 mode=1则表示连续扫描按键 如果 mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,</span><br><span class="line">                            <span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 dat[])</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 pos_temp = location - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = pos_temp;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = gsmg_code[dat[i-pos_temp]]; <span class="comment">//传输段选数据</span></span><br><span class="line">        Delay1ms(<span class="number">1</span>);                  <span class="comment">//延时1毫秒左右，等待显示稳定</span></span><br><span class="line">        SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 dat[])</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>IIC.c(第一种写法)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_start</span></span><br><span class="line"><span class="comment">* 函数功能 : 产生 IIC 起始信号</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SCL = <span class="number">1</span>;</span><br><span class="line">    IIC_SDA = <span class="number">1</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SDA = <span class="number">0</span>;   <span class="comment">//当SCL为高电平时，SDA由高变为低</span></span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;   <span class="comment">//钳住I2C总线，准备发送或接收数据(SCL为低电平时数据可以改变)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_stop</span></span><br><span class="line"><span class="comment">* 函数功能 : 产生 IIC 停止信号</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SCL = <span class="number">1</span>;</span><br><span class="line">    IIC_SDA = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SDA = <span class="number">1</span>;    <span class="comment">//当SCL为高电平时，SDA由低变为高</span></span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_ack</span></span><br><span class="line"><span class="comment">* 函数功能 : 产生 ACK 应答</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_ack</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;</span><br><span class="line">    IIC_SDA = <span class="number">0</span>;   <span class="comment">//SDA为低电平</span></span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SCL = <span class="number">1</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_nack</span></span><br><span class="line"><span class="comment">* 函数功能 : 产生 NACK 非应答</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_nack</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;</span><br><span class="line">    IIC_SDA = <span class="number">1</span>;   <span class="comment">//SDA为高电平</span></span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SCL = <span class="number">1</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_wait_ack</span></span><br><span class="line"><span class="comment">* 函数功能 : 等待应答信号到来</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 1，接收应答失败</span></span><br><span class="line"><span class="comment">          0，接收应答成功</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">iic_wait_ack</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 time_temp = <span class="number">0</span>; <span class="comment">//计时变量</span></span><br><span class="line">    IIC_SCL = <span class="number">1</span>;</span><br><span class="line">    delay_10us(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span>(IIC_SDA)  <span class="comment">//等待SDA为低电平(SDA为1进入循环，为0则跳出循环)</span></span><br><span class="line">    &#123;</span><br><span class="line">        time_temp++;</span><br><span class="line">        <span class="keyword">if</span>(time_temp &gt; <span class="number">100</span>)  <span class="comment">//超时则强制结束IIC通信</span></span><br><span class="line">        &#123;</span><br><span class="line">            iic_stop();        <span class="comment">//强制结束IIC通信</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;          <span class="comment">//返回1(接收应答失败)</span></span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;              <span class="comment">//返回0(接收应答成功)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_write_byte</span></span><br><span class="line"><span class="comment">* 函数功能 : IIC 发送一个字节</span></span><br><span class="line"><span class="comment">* 输 入 : dat：发送一个字节</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_write_byte</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    IIC_SCL = <span class="number">0</span>;  <span class="comment">//为0数据才可以改变</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((dat &amp; <span class="number">0x80</span>) &gt; <span class="number">0</span>) <span class="comment">//比较最高位 (如1011 0100 &amp; 1000 0000 --&gt; 1000 0000 最高位等于1 大于0)</span></span><br><span class="line">            IIC_SDA = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            IIC_SDA = <span class="number">0</span>;</span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;     <span class="comment">//左移一位(将次高位移到最高位)</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">        IIC_SCL = <span class="number">1</span>;  <span class="comment">//为1数据稳定等待下一次传输</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">        IIC_SCL = <span class="number">0</span>;  <span class="comment">//数据传输完毕，让SCL为0，使下一次数据可以改变并进行传输</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : iic_read_byte</span></span><br><span class="line"><span class="comment">* 函数功能 : IIC 读一个字节</span></span><br><span class="line"><span class="comment">* 输 入 : ack=1 时，发送 ACK，ack=0，发送 nACK</span></span><br><span class="line"><span class="comment">* 输 出 : 应答或非应答</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">iic_read_byte</span><span class="params">(u8 ack)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 receive = <span class="number">0</span>;  <span class="comment">//保存读取的数据</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)  <span class="comment">//循环8次将一个字节读出，先读高位再传低位</span></span><br><span class="line">    &#123;</span><br><span class="line">        IIC_SCL = <span class="number">0</span>;</span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">        IIC_SCL = <span class="number">1</span>;   <span class="comment">//SCL为1时数据稳定，可以传输数据</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">        receive &lt;&lt;= <span class="number">1</span>; <span class="comment">//将接收到的数据向左移动一位 (假设要传输 1001 1000，则先接收到高位1，则SDA为1，</span></span><br><span class="line">        <span class="keyword">if</span>(IIC_SDA)    <span class="comment">//如果SDA为1                receive加1，则receive为 0000 0001，之后将receive</span></span><br><span class="line">            receive++;   <span class="comment">//则接收到的数据加1        向左移动一位，则receive为 0000 0010,接着传输第二位0，</span></span><br><span class="line">        delay_10us(<span class="number">1</span>);                      <span class="comment">//     则SDA为0，不进入if语句，receive接收到0，则receive   </span></span><br><span class="line">                                              <span class="comment">//   为 0000 0010，之后将receive向左移动一位，则receive为   </span></span><br><span class="line">  &#125;                                           <span class="comment">//   0000 0100 以此类推接收数据，直到数据传输完成则跳出循环)</span></span><br><span class="line">    <span class="keyword">if</span>(!ack)</span><br><span class="line">        iic_nack();     <span class="comment">//非应答</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        iic_ack();      <span class="comment">//应答</span></span><br><span class="line">    <span class="keyword">return</span> receive;   <span class="comment">//返回出去</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IIC.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _IIC_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IIC_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit IIC_SCL = P2^<span class="number">1</span>;</span><br><span class="line">sbit IIC_SDA = P2^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_start</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_stop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_ack</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_nack</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">iic_wait_ack</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iic_write_byte</span><span class="params">(u8 dat)</span>;</span><br><span class="line">u8 <span class="title function_">iic_read_byte</span><span class="params">(u8 ack)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>EEPROM.c（对应IIC第一种第一种写法）</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : EEPROM_write_one_byte</span></span><br><span class="line"><span class="comment">* 函数功能 : 在 EEPROM 指定地址写入一个数据</span></span><br><span class="line"><span class="comment">* 输 入 : addr:写入数据的目的地址</span></span><br><span class="line"><span class="comment">          dat:要写入的数据</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_write_one_byte</span><span class="params">(u8 addr,u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    iic_start();</span><br><span class="line">    iic_write_byte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(前面4位固定，后面三位接gnd所以是0)</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    iic_write_byte(addr);  <span class="comment">//发送写地址</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    iic_write_byte(dat);   <span class="comment">//发送字节</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    iic_stop();            <span class="comment">//产生一个停止条件</span></span><br><span class="line">    Delay1ms(<span class="number">10</span>);</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : EEPROM_read_one_byte</span></span><br><span class="line"><span class="comment">* 函数功能 : 在 EEPROM 指定地址读出一个数据</span></span><br><span class="line"><span class="comment">* 输 入 : addr:开始读数的地址</span></span><br><span class="line"><span class="comment">* 输 出 : 读到的数据</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">EEPROM_read_one_byte</span><span class="params">(u8 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 receive = <span class="number">0</span>;</span><br><span class="line">    iic_start();</span><br><span class="line">    iic_write_byte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(寻找从机) 最后一位为0表示主机向从机写数据</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    iic_write_byte(addr);  <span class="comment">//在EEPROM指定一个地址(将要接收的数据存放到这个地址)</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    iic_start();           <span class="comment">//再次启动总线</span></span><br><span class="line">    iic_write_byte(<span class="number">0xA1</span>);  <span class="comment">//进入接收模式   最后一位为1表示主机由从机读数据</span></span><br><span class="line">    iic_wait_ack();</span><br><span class="line">    receive = iic_read_byte(addr);  <span class="comment">//读取字节</span></span><br><span class="line">    iic_stop();            <span class="comment">//产生一个停止条件</span></span><br><span class="line">    <span class="keyword">return</span> receive;        <span class="comment">//返回读取的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EEPROM.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EEPROM_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EEPROM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_write_one_byte</span><span class="params">(u8 addr,u8 dat)</span>;</span><br><span class="line">u8 <span class="title function_">EEPROM_read_one_byte</span><span class="params">(u8 addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EEPROM_ADDRESS  0   <span class="comment">//定义数据存入 EEPROM 的起始地址</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key = <span class="number">0</span>;</span><br><span class="line">    u8 save_value = <span class="number">0</span>;</span><br><span class="line">    u8 save_buf[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(key == KEY1_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            EEPROM_write_one_byte(EEPROM_ADDRESS,save_value); <span class="comment">//按K1键将数据写入到EEPROM内保存</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY2_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            save_value = EEPROM_read_one_byte(EEPROM_ADDRESS);<span class="comment">//按K2键读取EEPROM内保存的数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY3_PRESS)  </span><br><span class="line">        &#123;</span><br><span class="line">            save_value++;          <span class="comment">//按K3键显示数据加1</span></span><br><span class="line">            <span class="keyword">if</span>(save_value == <span class="number">255</span>)</span><br><span class="line">                save_value = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY4_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            save_value = <span class="number">0</span>;    <span class="comment">//按 K4 键显示数据清零，最大能写入的数据是255</span></span><br><span class="line">        &#125;</span><br><span class="line">        save_buf[<span class="number">0</span>] = save_value / <span class="number">100</span>;       <span class="comment">//百位</span></span><br><span class="line">        save_buf[<span class="number">1</span>] = save_value % <span class="number">100</span> / <span class="number">10</span>;  <span class="comment">//十位</span></span><br><span class="line">        save_buf[<span class="number">2</span>] = save_value % <span class="number">100</span> % <span class="number">10</span>;  <span class="comment">//个位</span></span><br><span class="line">        smg_display(<span class="number">6</span>,save_buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EXTI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EEPROM.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong>第二种写法，区别在IIC那里的写法不同，第二种写法开发板会比较灵敏一点</strong></p>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : key_scan</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测独立按键是否按下，按下则返回对应键值</span></span><br><span class="line"><span class="comment">* 输 入    : mode=0：单次扫描按键</span></span><br><span class="line"><span class="comment">             mode=1：连续扫描按键</span></span><br><span class="line"><span class="comment">* 输 出 :    KEY1_PRESS：K1 按下</span></span><br><span class="line"><span class="comment">             KEY2_PRESS：K2 按下</span></span><br><span class="line"><span class="comment">             KEY3_PRESS：K3 按下</span></span><br><span class="line"><span class="comment">             KEY4_PRESS：K4 按下</span></span><br><span class="line"><span class="comment">             KEY_UNPRESS：未有按键按下</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 key = <span class="number">1</span>; <span class="comment">//定义一个静态变量</span></span><br><span class="line">    <span class="keyword">if</span>(mode) key = <span class="number">1</span>; <span class="comment">//如果mode=1则表示连续扫描按键 如果mode=0则忽略这句话</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span> &amp;&amp; (KEY1 == <span class="number">0</span> || KEY2 == <span class="number">0</span> || KEY3 == <span class="number">0</span> || KEY4 == <span class="number">0</span> )) <span class="comment">//任意按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delay1ms(<span class="number">10</span>);  <span class="comment">//消抖</span></span><br><span class="line">        key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)         <span class="comment">//如果按键仍然处于被按下状态则表明按键真的被按下了</span></span><br><span class="line">            <span class="keyword">return</span> KEY1_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY2_PRESS; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY3_PRESS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> KEY4_PRESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(KEY1 == <span class="number">1</span> &amp;&amp; KEY2 == <span class="number">1</span> &amp;&amp; KEY3 == <span class="number">1</span> &amp;&amp; KEY4 == <span class="number">1</span> )  <span class="comment">//无按键按下</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KEY_UNPRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_MATRIX_PORT  P1  <span class="comment">//使用宏定义矩阵按键控制管脚</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">key_scan</span><span class="params">(u8 mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gsmg_code[<span class="number">17</span>] = &#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,</span><br><span class="line">                            <span class="number">0x6f</span>,<span class="number">0x77</span>,<span class="number">0x7c</span>,<span class="number">0x39</span>,<span class="number">0x5e</span>,<span class="number">0x79</span>,<span class="number">0x71</span>&#125;; <span class="comment">//定义数组存放0-F段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 dat[])</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 pos_temp = location - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = pos_temp;i &lt; <span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = gsmg_code[dat[i-pos_temp]]; <span class="comment">//传输段选数据</span></span><br><span class="line">        Delay1ms(<span class="number">1</span>);                  <span class="comment">//延时1毫秒左右，等待显示稳定</span></span><br><span class="line">        SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 dat[])</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>IIC.c（第二种写法）</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief    I2C开始 产生 IIC 起始信号</span></span><br><span class="line"><span class="comment">  * @param    无</span></span><br><span class="line"><span class="comment">  * @retval   无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;  <span class="comment">//先确保SDA为1</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;  <span class="comment">//再把SCL拉高</span></span><br><span class="line">    I2C_SDA=<span class="number">0</span>;  <span class="comment">//当SCL为高电平时，SDA由高变为低</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;  <span class="comment">//钳住I2C总线，准备发送或接收数据(SCL为低电平时数据可以改变)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C停止 产生IIC停止信号</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=<span class="number">0</span>;  <span class="comment">//先把SDA拉低</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;  <span class="comment">//再把SCL拉高</span></span><br><span class="line">    I2C_SDA=<span class="number">1</span>;  <span class="comment">//当SCL为高电平时，SDA由低变为高</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C发送一个字节</span></span><br><span class="line"><span class="comment">  * @param  Byte 要发送的字节</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(u8 Byte)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">    &#123;                         <span class="comment">//先传高位再传低位</span></span><br><span class="line">        I2C_SDA=Byte&amp;(<span class="number">0x80</span>&gt;&gt;i); <span class="comment">//取出最高位把值赋给SDA，接着再右移一位再取出来赋给SDA，以此类推循环八次</span></span><br><span class="line">        I2C_SCL=<span class="number">1</span>;  <span class="comment">//为1数据稳定等待下一次传输</span></span><br><span class="line">        I2C_SCL=<span class="number">0</span>;  <span class="comment">//数据传输完毕，让SCL为0，使下一次数据可以改变并进行传输</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C接收一个字节</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 接收到的一个字节数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">I2C_ReceiveByte</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i,Byte=<span class="number">0x00</span>;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        I2C_SCL=<span class="number">1</span>;    <span class="comment">//SCL为1时数据稳定，可以传输数据</span></span><br><span class="line">        <span class="keyword">if</span>(I2C_SDA)   <span class="comment">//如果SDA为1</span></span><br><span class="line">        &#123;</span><br><span class="line">            Byte|=(<span class="number">0x80</span>&gt;&gt;i); <span class="comment">//进入该循环表示Byte接收到1，如果SDA等于0，则默认Byte接收到0，不进入循环</span></span><br><span class="line">        &#125;</span><br><span class="line">        I2C_SCL=<span class="number">0</span>;    <span class="comment">//数据传输完毕，让SCL为0，使下一次数据可以改变并进行传输</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C发送应答</span></span><br><span class="line"><span class="comment">  * @param  AckBit 应答位，0为应答，1为非应答</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendAck</span><span class="params">(u8 AckBit)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=AckBit; <span class="comment">//应答位赋给SDA</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;      <span class="comment">//把SCL拉高</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;      <span class="comment">//再把SCL拉低</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C接收应答位</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 接收到的应答位，0为应答，1为非应答</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">I2C_ReceiveAck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 AckBit;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;</span><br><span class="line">    I2C_SCL=<span class="number">1</span>;</span><br><span class="line">    AckBit=I2C_SDA; <span class="comment">//SDA为0接收应答，为0为非应答</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> AckBit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IIC.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _IIC_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IIC_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit I2C_SCL = P2^<span class="number">1</span>;</span><br><span class="line">sbit I2C_SDA = P2^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(u8 Byte)</span>;</span><br><span class="line">u8 <span class="title function_">I2C_ReceiveByte</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendAck</span><span class="params">(u8 AckBit)</span>;</span><br><span class="line">u8 <span class="title function_">I2C_ReceiveAck</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>EEPROM.c（对应IIC第二种写法）</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  AT24C02写入一个字节</span></span><br><span class="line"><span class="comment">  * @param  addr 要写入字节的地址</span></span><br><span class="line"><span class="comment">  * @param  Data 要写入的数据</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_WriteByte</span><span class="params">(u8 addr,u8 Data)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(前面4位固定，后面三位接gnd所以是0)</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(addr);  <span class="comment">//发送写地址</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(Data);  <span class="comment">//发送字节</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_Stop();          <span class="comment">//产生一个停止条件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  AT24C02读取一个字节</span></span><br><span class="line"><span class="comment">  * @param  addr 要读出字节的地址</span></span><br><span class="line"><span class="comment">  * @retval 读出的数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">EEPROM_ReadByte</span><span class="params">(u8 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 Data;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(寻找从机) 最后一位为0表示主机向从机写数据</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(addr);  <span class="comment">//在EEPROM指定一个地址(将要接收的数据存放到这个地址)</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_Start();         <span class="comment">//再次启动总线</span></span><br><span class="line">    I2C_SendByte(<span class="number">0xA1</span>);  <span class="comment">//进入接收模式   最后一位为1表示主机由从机读数据</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    Data=I2C_ReceiveByte();  <span class="comment">//读取字节</span></span><br><span class="line">    I2C_SendAck(<span class="number">1</span>);</span><br><span class="line">    I2C_Stop();          <span class="comment">//产生一个停止条件</span></span><br><span class="line">    <span class="keyword">return</span> Data;         <span class="comment">//返回读取的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EEPROM.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EEPROM_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EEPROM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_WriteByte</span><span class="params">(u8 addr,u8 Data)</span>;</span><br><span class="line">u8 <span class="title function_">EEPROM_ReadByte</span><span class="params">(u8 addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EEPROM_ADDRESS  0   <span class="comment">//定义数据存入 EEPROM 的起始地址</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 key = <span class="number">0</span>;</span><br><span class="line">    u8 save_value = <span class="number">0</span>;</span><br><span class="line">    u8 save_buf[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key = key_scan(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(key == KEY1_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            EEPROM_WriteByte(EEPROM_ADDRESS,save_value); <span class="comment">//按K1键将数据写入到EEPROM内保存</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY2_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            save_value = EEPROM_ReadByte(EEPROM_ADDRESS);<span class="comment">//按K2键读取EEPROM内保存的数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY3_PRESS)  </span><br><span class="line">        &#123;</span><br><span class="line">            save_value++;          <span class="comment">//按K3键显示数据加1</span></span><br><span class="line">            <span class="keyword">if</span>(save_value == <span class="number">255</span>)</span><br><span class="line">                save_value = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(key == KEY4_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            save_value = <span class="number">0</span>;    <span class="comment">//按 K4 键显示数据清零，最大能写入的数据是255</span></span><br><span class="line">        &#125;</span><br><span class="line">        save_buf[<span class="number">0</span>] = save_value / <span class="number">100</span>;       <span class="comment">//百位</span></span><br><span class="line">        save_buf[<span class="number">1</span>] = save_value % <span class="number">100</span> / <span class="number">10</span>;  <span class="comment">//十位</span></span><br><span class="line">        save_buf[<span class="number">2</span>] = save_value % <span class="number">100</span> % <span class="number">10</span>;  <span class="comment">//个位</span></span><br><span class="line">        smg_display(<span class="number">6</span>,save_buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EXTI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EEPROM.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="按键1控制秒表启动与暂停，按键2使秒表清0，按键3将秒表数据存储到EEPROM-按键4读取EEPROM中存储的数据">按键1控制秒表启动与暂停，按键2使秒表清0，按键3将秒表数据存储到EEPROM,按键4读取EEPROM中存储的数据</h4>
</blockquote>
<p>这个是一种新的思路，把按键和数码管的驱动函数放到定时器中断服务函数这里来，让定时器可以实现多个模块进行计时，实现更高效率的计时</p>
<p><code>Key.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 key_ketNumber = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  获取按键键码</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 按下按键的键码，范围：0,1~4,0表示无按键按下</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">key</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 temp;</span><br><span class="line">    temp = key_ketNumber;</span><br><span class="line">    key_ketNumber = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  获取当前按键的状态，无消抖及松手检测</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 按下按键的键码，范围：0,1~4,0表示无按键按下</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">Key_GetState</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 KeyNumber = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(KEY1 == <span class="number">0</span>)             <span class="comment">//如果按键1按下</span></span><br><span class="line">        KeyNumber = KEY1_PRESS; <span class="comment">// 按键值1</span></span><br><span class="line">    <span class="keyword">if</span>(KEY2 == <span class="number">0</span>)             <span class="comment">//如果按键2按下</span></span><br><span class="line">        KeyNumber = KEY2_PRESS; <span class="comment">// 按键值2</span></span><br><span class="line">    <span class="keyword">if</span>(KEY3 == <span class="number">0</span>)             <span class="comment">//如果按键3按下</span></span><br><span class="line">        KeyNumber = KEY3_PRESS; <span class="comment">// 按键值3</span></span><br><span class="line">    <span class="keyword">if</span>(KEY4 == <span class="number">0</span>)             <span class="comment">//如果按键4按下</span></span><br><span class="line">        KeyNumber = KEY4_PRESS; <span class="comment">// 按键值4</span></span><br><span class="line">    <span class="keyword">return</span> KeyNumber;         <span class="comment">//返回按键值</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  按键驱动函数，在中断中调用</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Key_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 NowState,LastState;</span><br><span class="line">    LastState = NowState;      <span class="comment">//按键状态更新</span></span><br><span class="line">    NowState = Key_GetState(); <span class="comment">//获取当前按键状态</span></span><br><span class="line">    <span class="comment">//如果上个时间点按键按下，这个时间点未按下，则是松手瞬间，以此避免消抖和松手检测</span></span><br><span class="line">    <span class="keyword">if</span>(LastState == KEY1_PRESS &amp;&amp; NowState == KEY_UNPRESS)</span><br><span class="line">        key_ketNumber = KEY1_PRESS;</span><br><span class="line">    <span class="keyword">if</span>(LastState == KEY2_PRESS &amp;&amp; NowState == KEY_UNPRESS)</span><br><span class="line">        key_ketNumber = KEY2_PRESS;</span><br><span class="line">    <span class="keyword">if</span>(LastState == KEY3_PRESS &amp;&amp; NowState == KEY_UNPRESS)</span><br><span class="line">        key_ketNumber = KEY3_PRESS;</span><br><span class="line">    <span class="keyword">if</span>(LastState == KEY4_PRESS &amp;&amp; NowState == KEY_UNPRESS)</span><br><span class="line">        key_ketNumber = KEY4_PRESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _KEY_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KEY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义4个独立按键控制管脚</span></span><br><span class="line">sbit KEY1 = P3^<span class="number">1</span>;</span><br><span class="line">sbit KEY2 = P3^<span class="number">0</span>;</span><br><span class="line">sbit KEY3 = P3^<span class="number">2</span>;</span><br><span class="line">sbit KEY4 = P3^<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用宏定义独立按键按下的键值（如果按下则返回）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRESS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRESS  2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY3_PRESS  3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY4_PRESS  4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//没按下</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_UNPRESS 0</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">Key_GetState</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">key</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Key_loop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//数码管显示缓存区</span></span><br><span class="line">u8 smg_Buf[<span class="number">9</span>] = &#123;<span class="number">0</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数码管段码表</span></span><br><span class="line">u8 gsmg_code[]=&#123;<span class="number">0x3F</span>,<span class="number">0x06</span>,<span class="number">0x5B</span>,<span class="number">0x4F</span>,<span class="number">0x66</span>,<span class="number">0x6D</span>,<span class="number">0x7D</span>,<span class="number">0x07</span>,<span class="number">0x7F</span>,<span class="number">0x6F</span>,<span class="number">0x00</span>,<span class="number">0x40</span>&#125;; </span><br><span class="line">                                    <span class="comment">//定义数组存放0-10段码,gsmg中g代表全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  设置显示缓存区</span></span><br><span class="line"><span class="comment">  * @param  Location 要设置的位置，范围：1~8</span></span><br><span class="line"><span class="comment">  * @param  Number 要设置的数字，范围：段码表索引范围</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_SetBuf</span><span class="params">(u8 location,u8 number)</span></span><br><span class="line">&#123;</span><br><span class="line">    smg_Buf[location] = number; <span class="comment">//将某个位置的数码管改成某个数字</span></span><br><span class="line">&#125;</span><br><span class="line">                            </span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能 : 动态数码管显示</span></span><br><span class="line"><span class="comment">*********************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span></span><br><span class="line">&#123;</span><br><span class="line">      SMG_A_DP_PORT = <span class="number">0x00</span>;         <span class="comment">//消影</span></span><br><span class="line">        <span class="keyword">switch</span>(location)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = gsmg_code[number]; <span class="comment">//传输段选数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  数码管驱动函数，在中断中调用</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u8 i = <span class="number">1</span>;</span><br><span class="line">    smg_display(i,smg_Buf[i]);</span><br><span class="line">    i++;</span><br><span class="line">    <span class="keyword">if</span>(i &gt; <span class="number">8</span>)</span><br><span class="line">        i = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 location,u8 number)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_loop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_SetBuf</span><span class="params">(u8 location,u8 number)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>EXTI.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  Time0_Init</span></span><br><span class="line"><span class="comment">  * @功能 : 定时器0中断配置函数，通过设置 TH 和 TL 即可确定定时时间(使用工具可确定TH 与TL的值)</span></span><br><span class="line"><span class="comment">  * @返回值: 无                                                   晶振频率为11.0592</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMOD |= <span class="number">0x01</span>; <span class="comment">//选择为定时器0模式，工作方式1(为了不干扰T1定时器所以用|);如果是定时器1则把0x01改成0x10</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>; <span class="comment">//给定时器赋初值，定时1ms;如果是定时器1则把TH0改成TH1</span></span><br><span class="line">    TL0 = <span class="number">0X66</span>; <span class="comment">//如果是定时器1则把TL0改成TL1</span></span><br><span class="line">    ET0 = <span class="number">1</span>;    <span class="comment">//打开定时器0中断允许</span></span><br><span class="line">    EA = <span class="number">1</span>;     <span class="comment">//打开总中断</span></span><br><span class="line">    TR0 = <span class="number">1</span>;    <span class="comment">//打开定时器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EXTI.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EXTI_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EXTI_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>IIC.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief    I2C开始 产生 IIC 起始信号</span></span><br><span class="line"><span class="comment">  * @param    无</span></span><br><span class="line"><span class="comment">  * @retval   无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;  <span class="comment">//先确保SDA为1</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;  <span class="comment">//再把SCL拉高</span></span><br><span class="line">    I2C_SDA=<span class="number">0</span>;  <span class="comment">//当SCL为高电平时，SDA由高变为低</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;  <span class="comment">//钳住I2C总线，准备发送或接收数据(SCL为低电平时数据可以改变)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C停止 产生IIC停止信号</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=<span class="number">0</span>;  <span class="comment">//先把SDA拉低</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;  <span class="comment">//再把SCL拉高</span></span><br><span class="line">    I2C_SDA=<span class="number">1</span>;  <span class="comment">//当SCL为高电平时，SDA由低变为高</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C发送一个字节</span></span><br><span class="line"><span class="comment">  * @param  Byte 要发送的字节</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(u8 Byte)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">    &#123;                         <span class="comment">//先传高位再传低位</span></span><br><span class="line">        I2C_SDA=Byte&amp;(<span class="number">0x80</span>&gt;&gt;i); <span class="comment">//取出最高位把值赋给SDA，接着再右移一位再取出来赋给SDA，以此类推循环八次</span></span><br><span class="line">        I2C_SCL=<span class="number">1</span>;  <span class="comment">//为1数据稳定等待下一次传输</span></span><br><span class="line">        I2C_SCL=<span class="number">0</span>;  <span class="comment">//数据传输完毕，让SCL为0，使下一次数据可以改变并进行传输</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C接收一个字节</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 接收到的一个字节数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">I2C_ReceiveByte</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i,Byte=<span class="number">0x00</span>;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        I2C_SCL=<span class="number">1</span>;    <span class="comment">//SCL为1时数据稳定，可以传输数据</span></span><br><span class="line">        <span class="keyword">if</span>(I2C_SDA)   <span class="comment">//如果SDA为1</span></span><br><span class="line">        &#123;</span><br><span class="line">            Byte|=(<span class="number">0x80</span>&gt;&gt;i); <span class="comment">//进入该循环表示Byte接收到1，如果SDA等于0，则默认Byte接收到0，不进入循环</span></span><br><span class="line">        &#125;</span><br><span class="line">        I2C_SCL=<span class="number">0</span>;    <span class="comment">//数据传输完毕，让SCL为0，使下一次数据可以改变并进行传输</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C发送应答</span></span><br><span class="line"><span class="comment">  * @param  AckBit 应答位，0为应答，1为非应答</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendAck</span><span class="params">(u8 AckBit)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_SDA=AckBit; <span class="comment">//应答位赋给SDA</span></span><br><span class="line">    I2C_SCL=<span class="number">1</span>;      <span class="comment">//把SCL拉高</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;      <span class="comment">//再把SCL拉低</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  I2C接收应答位</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 接收到的应答位，0为应答，1为非应答</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">I2C_ReceiveAck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 AckBit;</span><br><span class="line">    I2C_SDA=<span class="number">1</span>;</span><br><span class="line">    I2C_SCL=<span class="number">1</span>;</span><br><span class="line">    AckBit=I2C_SDA; <span class="comment">//SDA为0接收应答，为0为非应答</span></span><br><span class="line">    I2C_SCL=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> AckBit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IIC.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _IIC_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IIC_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit I2C_SCL = P2^<span class="number">1</span>;</span><br><span class="line">sbit I2C_SDA = P2^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Start</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Stop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendByte</span><span class="params">(u8 Byte)</span>;</span><br><span class="line">u8 <span class="title function_">I2C_ReceiveByte</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SendAck</span><span class="params">(u8 AckBit)</span>;</span><br><span class="line">u8 <span class="title function_">I2C_ReceiveAck</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>EEPROM.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  AT24C02写入一个字节</span></span><br><span class="line"><span class="comment">  * @param  WordAddress 要写入字节的地址</span></span><br><span class="line"><span class="comment">  * @param  Data 要写入的数据</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_WriteByte</span><span class="params">(u8 addr,u8 Data)</span></span><br><span class="line">&#123;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(前面4位固定，后面三位接gnd所以是0)</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(addr);  <span class="comment">//发送写地址</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(Data);  <span class="comment">//发送字节</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_Stop();          <span class="comment">//产生一个停止条件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  AT24C02读取一个字节</span></span><br><span class="line"><span class="comment">  * @param  WordAddress 要读出字节的地址</span></span><br><span class="line"><span class="comment">  * @retval 读出的数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">u8 <span class="title function_">EEPROM_ReadByte</span><span class="params">(u8 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 Data;</span><br><span class="line">    I2C_Start();</span><br><span class="line">    I2C_SendByte(<span class="number">0xA0</span>);  <span class="comment">//发送写命令(寻找从机) 最后一位为0表示主机向从机写数据</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_SendByte(addr);  <span class="comment">//在EEPROM指定一个地址(将要接收的数据存放到这个地址)</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    I2C_Start();         <span class="comment">//再次启动总线</span></span><br><span class="line">    I2C_SendByte(<span class="number">0xA1</span>);  <span class="comment">//进入接收模式   最后一位为1表示主机由从机读数据</span></span><br><span class="line">    I2C_ReceiveAck();</span><br><span class="line">    Data=I2C_ReceiveByte();  <span class="comment">//读取字节</span></span><br><span class="line">    I2C_SendAck(<span class="number">1</span>);</span><br><span class="line">    I2C_Stop();          <span class="comment">//产生一个停止条件</span></span><br><span class="line">    <span class="keyword">return</span> Data;         <span class="comment">//返回读取的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EEPROM.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _EEPROM_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _EEPROM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EEPROM_WriteByte</span><span class="params">(u8 addr,u8 Data)</span>;</span><br><span class="line">u8 <span class="title function_">EEPROM_ReadByte</span><span class="params">(u8 addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @从STC-ISP生成复制延时函数</span></span><br><span class="line"><span class="comment">  * @函数名:  Delay1ms</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少毫秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>     <span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line">  <span class="keyword">while</span>(xms)</span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">2</span>;</span><br><span class="line">        j = <span class="number">239</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--j);</span><br><span class="line">        &#125; <span class="keyword">while</span> (--i);</span><br><span class="line">        xms--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay1ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> xms)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 key_Number = <span class="number">0</span>;</span><br><span class="line">u8 Min,Sec,MinSec; <span class="comment">//定义 分钟，秒钟，MinSce为秒钟后面计数的，每100个MinSec秒钟就加1</span></span><br><span class="line">u8 RunFlag; <span class="comment">//标志位</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">  Time0_Init();</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123; </span><br><span class="line">        key_Number = key();</span><br><span class="line">        <span class="keyword">if</span>(key_Number == KEY1_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            RunFlag = !RunFlag;   <span class="comment">//标志位翻转(控制秒表启动与暂停)</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(key_Number == KEY2_PRESS) <span class="comment">//按键2按下秒表清0</span></span><br><span class="line">        &#123;</span><br><span class="line">            Min = <span class="number">0</span>;                   <span class="comment">//分秒清0</span></span><br><span class="line">            Sec = <span class="number">0</span>;</span><br><span class="line">            MinSec = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(key_Number == KEY3_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            EEPROM_WriteByte(<span class="number">0</span>,Min);  <span class="comment">//将分秒写入EEPROM</span></span><br><span class="line">            Delay1ms(<span class="number">5</span>);</span><br><span class="line">            EEPROM_WriteByte(<span class="number">1</span>,Sec);</span><br><span class="line">            Delay1ms(<span class="number">5</span>);</span><br><span class="line">            EEPROM_WriteByte(<span class="number">2</span>,MinSec);</span><br><span class="line">            Delay1ms(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(key_Number == KEY4_PRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            Min = EEPROM_ReadByte(<span class="number">0</span>);  <span class="comment">//读取EEPROM中的数据</span></span><br><span class="line">            Sec = EEPROM_ReadByte(<span class="number">1</span>);</span><br><span class="line">            MinSec = EEPROM_ReadByte(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        smg_SetBuf(<span class="number">1</span>,Min/<span class="number">10</span>);   <span class="comment">//显示分第一位 </span></span><br><span class="line">        smg_SetBuf(<span class="number">2</span>,Min%<span class="number">10</span>);   <span class="comment">//显示分第二位</span></span><br><span class="line">        smg_SetBuf(<span class="number">3</span>,<span class="number">11</span>);       <span class="comment">//显示横杠</span></span><br><span class="line">        smg_SetBuf(<span class="number">4</span>,Sec/<span class="number">10</span>);   <span class="comment">//显示秒第一位</span></span><br><span class="line">        smg_SetBuf(<span class="number">5</span>,Sec%<span class="number">10</span>);   <span class="comment">//显示秒第一位</span></span><br><span class="line">        smg_SetBuf(<span class="number">6</span>,<span class="number">11</span>);       <span class="comment">//显示横杠</span></span><br><span class="line">        smg_SetBuf(<span class="number">7</span>,MinSec/<span class="number">10</span>);</span><br><span class="line">        smg_SetBuf(<span class="number">8</span>,MinSec%<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief  秒表驱动函数，在中断中调用</span></span><br><span class="line"><span class="comment">  * @param  无</span></span><br><span class="line"><span class="comment">  * @retval 无</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Sec_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(RunFlag) <span class="comment">//如果中断标志位为1，则启动计时</span></span><br><span class="line">    &#123;</span><br><span class="line">        MinSec++;</span><br><span class="line">        <span class="keyword">if</span>(MinSec &gt;= <span class="number">100</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            MinSec = <span class="number">0</span>;</span><br><span class="line">            Sec++;</span><br><span class="line">            <span class="keyword">if</span>(Sec &gt;= <span class="number">60</span>) <span class="comment">//如果秒钟加到 60</span></span><br><span class="line">            &#123;</span><br><span class="line">                Sec = <span class="number">0</span>; <span class="comment">//秒钟清 0</span></span><br><span class="line">                Min++;   <span class="comment">//分钟加 1</span></span><br><span class="line">                <span class="keyword">if</span>(Min &gt;= <span class="number">60</span>)  <span class="comment">//如果分钟加到 60</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Min = <span class="number">0</span>; <span class="comment">//分钟清 0</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @功能 : 定时器0中断服务函数</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Time0</span><span class="params">()</span> interrupt 1 <span class="comment">//定时器0中断号为1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> u16 count1 = <span class="number">0</span>,count2 = <span class="number">0</span>,count3 = <span class="number">0</span>; <span class="comment">//定义静态变量count</span></span><br><span class="line">    TH0 = <span class="number">0xFC</span>;           <span class="comment">//给定时器赋初值，定时1ms</span></span><br><span class="line">    TL0 = <span class="number">0X66</span>;</span><br><span class="line">    count1++;</span><br><span class="line">    <span class="keyword">if</span>(count1 == <span class="number">20</span>)     <span class="comment">//20ms</span></span><br><span class="line">    &#123;</span><br><span class="line">        count1 = <span class="number">0</span>;          <span class="comment">//溢出然后重新赋0</span></span><br><span class="line">        Key_loop(); <span class="comment">//每 20 毫秒进入按键驱动函数，相当于每 20 毫秒扫描一次按键，用这个方法就不需要进行消抖操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    count2++;</span><br><span class="line">    <span class="keyword">if</span>(count2 == <span class="number">2</span>)     <span class="comment">//2ms</span></span><br><span class="line">    &#123;</span><br><span class="line">        count2 = <span class="number">0</span>;          <span class="comment">//溢出然后重新赋0</span></span><br><span class="line">        smg_loop(); <span class="comment">//每 2 毫秒进入数码管驱动函数，相当于每 2 毫秒扫描一次数码管</span></span><br><span class="line">    &#125;</span><br><span class="line">    count3++;</span><br><span class="line">    <span class="keyword">if</span>(count3 == <span class="number">10</span>)     <span class="comment">//10 ms</span></span><br><span class="line">    &#123;</span><br><span class="line">        count3 = <span class="number">0</span>;          <span class="comment">//溢出然后重新赋0</span></span><br><span class="line">        Sec_loop(); <span class="comment">//每 10 毫秒进入秒表驱动函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EXTI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EEPROM.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="DS18B20-温度传感器">DS18B20-温度传感器</h2>
<h3 id="DS18B20-介绍">DS18B20 介绍</h3>
<p>DS18B20 是一种“ <code>一线总线（单总线）</code>”接口的<code>温度传感器</code>。它是一种新型的体积小、适用电压宽、与微处理器接口简单的数字化温度传感器。</p>
<p><strong>DS18B20 温度传感器的特点：</strong></p>
<blockquote>
<p>1、<code>适应电压范围更宽，电压范围：3.0～5.5V</code>，在寄生电源方式下可由数据线供电。<br>
2、独特的单线接口方式，DS18B20 在与微处理器连接时<code>仅需要一条口线</code>即可实现微处理器与 DS18B20 的双向通讯。<br>
3、DS18B20 <code>支持多点组网功能</code>，多个 DS18B20 可以并联在唯一的三线上，实现组网多点测温。<br>
4、DS18B20 在使用中<code>不需要任何外围元件</code>，全部传感元件及转换电路集成在形如一只三极管的集成电路内。<br>
5、温度范围 <code>－55℃～+125℃</code>，在-10～+85℃时精度为±0.5℃<br>
6、可编程的分辨率为 9～12 位，对应的可分辨温度分别为 0.5℃、0.25℃、0.125℃ 和 0.0625℃，可<code>实现高精度测温</code>。<br>
7、在 9 位分辨率时最多在 93.75ms 内把温度转换为数字，12 位分辨率时最多在 750ms 内把温度值转换为数字，速度更快。<br>
8、测量结果<code>直接输出数字温度信号</code>，以&quot;一根总线&quot;串行传送给 CPU，同时可传送 CRC 校验码，具有极强的抗干扰纠错能力。<br>
9、负压特性：<code>电源极性接反时，芯片不会因发热而烧毁，但不能正常工作</code>。</p>
</blockquote>
<p>DS18B20 外观实物如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/48c020ec51024c0fae0f0e781c4a8817.webp" style="zoom:40%;" />
<p>从 DS18B20 外观图可以看到，当我们<code>正对传感器切面</code>（传感器型号字符那一面）时，<code>传感器的管脚顺序是从左到右排列</code>。<code>管脚 1 为 GND，管脚 2 为数据DQ，管脚 3 为 VDD</code>。<code>如果把传感器插反，那么电源将短路，传感器就会发烫</code>，很容易损坏，所以一定要<code>注意传感器方向</code>，通常在开发板上都会标出传感器的凸起出，所以只需要把传感器凸起的方向对着开发板凸起方向插入即可。</p>
<p><strong>DS18B20 内部结构如下图所示：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/7801fb03019c4b3abfadd7c013f6ced0.webp" style="zoom:40%;" />
<p>ROM 中的 64 位序列号是出厂前被光刻好的，它可以看作是该 DS18B20 的地址序列号。光刻 ROM 的作用是使每一个 DS18B20 都各不相同，这样就可以实现<code>一根总线上挂接多个 DS18B20</code> 的目的。</p>
<p>DS18B20 温度传感器的内部存储器包括一个<code>高速的暂存器 RAM</code> 和一个<code>非易失性的可电擦除的 EEPROM</code>,后者存放<code>高温度和低温度触发器 TH、TL 和配置寄存器</code>。</p>
<p>配置寄存器是配置不同的位数来确定温度和数字的转化，配置寄存器结构如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/aabf06109b264bdb8a8d4a397a6f08c5.webp" style="zoom: 67%;" />
<p>低五位一直都是&quot;<code>1</code>&quot;，<code>TM</code> 是<code>测试模式位</code>，用于设置 DS18B20 在<code>工作模式</code>还是在<code>测试模式</code>。在 DS18B20 出厂时该位被设置为 <code>0</code>，因此 DS18B20 在<code>工作模式</code>。<code>R1 和R0</code> 用来设置 DS18B20 的<code>精度</code>（分辨率），可设置为 9，10，11 或 12 位，对应的分辨率温度是 0.5℃，0.25℃，0.125℃和 0.0625℃。R0 和 R1 配置如下图：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/790abd7bc4e744ec93bb48ff222ca085.webp" style="zoom:50%;" />
<p>在初始状态下默认的精度是 12 位，即 <code>R0=1、R1=1</code>。高速暂存存储器由 9 个字节组成，其分配如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/3b1cf2a47b0b404c8153fb5a9f79d879.webp" style="zoom:40%;" />
<p>当温度转换命令（44H）发布后，经转换所得的温度值以<code>二字节补码</code>形式存放在<code>高速暂存存储器的第 0 和第 1 个字节</code>。存储的两个字节，高字节的前 5 位是符号位<code>S</code>，单片机可通过单线接口读到该数据，读取时<code>低位在前，高位在后</code>，数据格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/e1d8a0c846f84b318607511826ea152b.webp" style="zoom:40%;" />
<p>如果测得的温度<code>大于 0</code>，这 <code>5 位符号位S为‘ 0’</code>，只要将测到的数值<code>乘以 0.0625</code>（默认精度是 12 位）即可得到<code>实际温度</code>；如果<code>温度小于 0</code>，这 <code>5 位符号位S为‘ 1’</code>，测到的数值需要<code>取反加 1 再乘以 0.0625</code> 即可得到<code>实际温度</code>。温度与数据对应关系如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/84e4f2fe1bb440838683f8b2f6bbbe20.webp" style="zoom:35%;" />
<p>比如要计算 <code>+85 度</code>，数据输出<code>十六进制是 0X0550</code>，因为要计算的<code>温度大于0</code>，所以高字节的高 5位为 0，<code>十六进制0X0550 对应的二进制为 0000 0101 0101 0000</code>，<code>该二进制对应的十进制为 1360</code>，将这个值<code>乘以 12 位精度 0.0625</code>，所以可以得到+85 度。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6e3f530e87d349ccb34f7253205dbc38.webp" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/6dba2f7009284d67a219b577f0d4643b.webp" style="zoom: 130%;" />
<p>又比如要计算 <code>-0.5 度</code>，数据输出<code>十六进制是 FFF8</code>，因为要计算的<code>温度小于0</code>，所以高字节的高 5位为 1，<code>十六进制 FFF8 对应的二进制为 1111 1111 1111 1000</code>，先对这个二进制数进行<code>取反</code>为 0000 0000 0000 0111，再进行<code>加 1</code> ，则对应的<code>十六进制为0x08</code>， <code>十六进制 0x08 对应的十进制为 8</code>，将这个值<code>乘以 12 位精度 0.0625</code>，算出来的值为 0.5，因为该温度小于 0 ，所以可以得到 -0.5 度。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1145b1251ab54ca5b414eaaa6140f927.webp" style="zoom:150%;" />
<h3 id="读取温度数据">读取温度数据</h3>
<p>由于 DS18B20是<code>单总线器件</code>，所有的单总线器件都要求采用严格的信号时序，以保数据的完整性。DS18B20 时序包括如下几种：<code>初始化时序、写（0 和 1）时序、 读（0和 1）时序</code>。 DS18B20 发送所有的命令和数据都是<code>字节的低位在前</code>。这里我们简单介绍这几个信号的时序：</p>
<h4 id="初始化时序">初始化时序</h4>
<p>单总线上的所有通信都是<code>以初始化序列开始</code>。<code>主机输出低电平</code>，保持低电平时间<code>至少 480us</code>（该时间的时间范围可以从 480 到 960 微秒），以产生复位脉冲。接着<code>主机释放总线</code>，外部的上拉电阻将单总线拉高，<code>延时 15～60 us</code>，并<code>进入接收模式</code>。接着 DS18B20 <code>拉低总线 60~240 us</code>，以产生<code>低电平应答脉冲</code>，若为低电平，还要做延时，其延时的时间从外部上拉电阻将单总线拉高算起最少要480 微妙。初始化时序图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/2f018d03e5614bfab1f7f1623d10997e.webp" style="zoom: 30%;" />
<h4 id="写时序">写时序</h4>
<p>写时序包括<code>写 0 时序和写 1 时序</code>。所有写时序至少需要 60us，且在 2 次独立的写时序之间至少需要 1us 的恢复时间，两种写时序均<code>起始于主机拉低总线</code>。写 <code>1 时序</code>：主机输出低电平，<code>延时 2us</code>，然后释放总线，<code>延时 60us</code>。写 <code>0时序</code>：主机输出低电平，<code>延时 60us</code>，然后释放总线，<code>延时 2us</code>。写时序图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/644c6fe2fc5841028f1d6bd3c60ea47f.webp" style="zoom: 38%;" />
<h4 id="读时序">读时序</h4>
<p>单总线器件仅<code>在主机发出读时序</code>时，才<code>向主机传输数据</code>，所以，<code>在主机发出读数据命令后，必须马上产生读时序，以便从机能够传输数据</code>。所有读时序至少需要 60us，且在 2 次独立的读时序之间至少需要 1us 的恢复时间。每个<code>读时序都由主机发起</code>，至少拉低总线 1us。<code>主机在读时序期间必须释放总线</code>，并且在时序起始后的 15us 之内采样总线状态。读时序图如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f12a0bf9e5454952b91aa75e7c586751.png" style="zoom:41%;" />
<p>典型的读时序过程为：主机输出低电平延时 2us，然后主机转入输入模式延时 2us，然后读取单总线当前的电平，然后延时 50us。</p>
<p>DS18B20 的典型温度读取过程为：<code>复位→发 SKIP ROM 命令（0XCC）→ 发开始转换命令（0X44）(启动温度转换) → 延时 → 复位 → 发送 SKIP ROM 命令（0XCC）→ 发读存储器命令（0XBE）→ 连续读出两个字节数据(即温度) → 结束</code></p>
<h3 id="DS18B20-模块电路原理图">DS18B20 模块电路原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/84d03e6d1a0b47dabf7d3daf94760523.webp" style="zoom:40%;" />
<p>传感器接口的单总线管脚接至单片机 <code>P3.7</code> IO 口上</p>
<h3 id="DS18B20-实验">DS18B20 实验</h3>
<blockquote>
<p><strong>插上 DS18B20 温度传感器，数码管显示检测的温度值</strong></p>
</blockquote>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能		 : 动态数码管显示</span></span><br><span class="line"><span class="comment">* 输    入       : dat：要显示的数据</span></span><br><span class="line"><span class="comment">				 location：从左开始第几个位置开始显示，范围1-8</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 location_temp = location - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = location_temp; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(i)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = dat[i - location_temp]; <span class="comment">//传送段选数据</span></span><br><span class="line">        delay_10us(<span class="number">100</span>);<span class="comment">//延时一段时间，等待显示稳定</span></span><br><span class="line">        SMG_A_DP_PORT = <span class="number">0x00</span>; <span class="comment">//消音</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>]; <span class="comment">//允许外部进行调用就得用extern</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>ds18b20.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : ds18b20_reset</span></span><br><span class="line"><span class="comment">* 函数功能 : 复位 DS18B20</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_reset</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    DS18B20_PORT = <span class="number">0</span>; <span class="comment">//拉低 DQ</span></span><br><span class="line">    delay_10us(<span class="number">75</span>);   <span class="comment">//延时750微秒</span></span><br><span class="line">    DS18B20_PORT = <span class="number">1</span>; <span class="comment">//拉高DQ DQ = 1</span></span><br><span class="line">    delay_10us(<span class="number">2</span>);    <span class="comment">//延时20微秒</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : ds18b20_check</span></span><br><span class="line"><span class="comment">* 函数功能 : 检测 DS18B20 是否存在</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 1:未检测到 DS18B20 的存在，0:存在</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds18b20_check</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 time_temp = <span class="number">0</span>;  <span class="comment">//设置时间变量原因是如果DQ一直为高电平的话不能一直在这里死循环，如果等待一会DQ还是高电平的话则强制退出</span></span><br><span class="line">    <span class="keyword">while</span>(DS18B20_PORT &amp;&amp; time_temp &lt; <span class="number">20</span>) <span class="comment">//等待DQ为低电平(如果DQ为1且时间变量小于20则进入循环，如果为低电平0则跳出循环)</span></span><br><span class="line">    &#123;</span><br><span class="line">        time_temp++;</span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(time_temp &gt;= <span class="number">20</span>) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">//如果超时则强制返回 1，证明DS18B20不存在</span></span><br><span class="line">    <span class="keyword">else</span>  time_temp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((!DS18B20_PORT) &amp;&amp; time_temp &lt; <span class="number">20</span>) <span class="comment">//等待DQ为高电平(如果DQ为0且时间变量小于20则进入循环，如果为高电平1则跳出循环)</span></span><br><span class="line">    &#123;</span><br><span class="line">        time_temp++;</span><br><span class="line">        delay_10us(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(time_temp &gt;= <span class="number">20</span>) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">//如果超时则强制返回 1，证明DS18B20不存在</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//证明DS18B20存在</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名 : ds18b20_init</span></span><br><span class="line"><span class="comment">* 函数功能 : 初始化 DS18B20 的 IO 口 DQ, 同时检测 DS 的存在</span></span><br><span class="line"><span class="comment">* 输 入 : 无</span></span><br><span class="line"><span class="comment">* 输 出 : 1:不存在，0:存在</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds18b20_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ds18b20_reset();</span><br><span class="line">    <span class="keyword">return</span> ds18b20_check();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ds18b20_write_byte</span></span><br><span class="line"><span class="comment">* 函数功能		   : 写一个字节到DS18B20</span></span><br><span class="line"><span class="comment">* 输    入         : dat：要写入的字节</span></span><br><span class="line"><span class="comment">* 输    出         : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_write_byte</span><span class="params">(u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 temp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次，每次写一位，且先写低位再写高位</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//例如data为 0101 1011</span></span><br><span class="line">        temp = dat &amp; <span class="number">0x01</span>; <span class="comment">//选择低位准备写入(则temp为0000 0001 )</span></span><br><span class="line">        dat &gt;&gt;= <span class="number">1</span>;         <span class="comment">//将次低位移到最低位，例如一开始dat为0101 1011 向右移动一位则变成 0010 1101</span></span><br><span class="line">        <span class="keyword">if</span>(temp)           <span class="comment">//如果写 1 时序</span></span><br><span class="line">        &#123;</span><br><span class="line">            DS18B20_PORT = <span class="number">0</span>;<span class="comment">//主机拉低总线</span></span><br><span class="line">            _nop_();</span><br><span class="line">            _nop_(); <span class="comment">//延时两毫秒(该函数为头文件intrins.h里的函数，一个_nop_()表示延时 1 毫秒)</span></span><br><span class="line">            DS18B20_PORT = <span class="number">1</span>;<span class="comment">//释放总线</span></span><br><span class="line">            delay_10us(<span class="number">6</span>);   <span class="comment">//延时 60 us</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>               <span class="comment">//写入 0 时序</span></span><br><span class="line">        &#123;</span><br><span class="line">            DS18B20_PORT = <span class="number">0</span>;<span class="comment">//主机拉低总线</span></span><br><span class="line">            delay_10us(<span class="number">6</span>);   <span class="comment">//延时 60 us</span></span><br><span class="line">            DS18B20_PORT = <span class="number">1</span>;<span class="comment">//释放总线</span></span><br><span class="line">            _nop_();</span><br><span class="line">            _nop_(); <span class="comment">//延时两毫秒(该函数为头文件intrins.h里的函数，一个_nop_()表示延时 1 微秒)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ds18b20_read_bit</span></span><br><span class="line"><span class="comment">* 函数功能		   : 从DS18B20读取一个位</span></span><br><span class="line"><span class="comment">* 输    入         : 无</span></span><br><span class="line"><span class="comment">* 输    出         : 1/0</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds18b20_read_bit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 dat = <span class="number">0</span>;</span><br><span class="line">    DS18B20_PORT = <span class="number">0</span>;</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();</span><br><span class="line">    DS18B20_PORT = <span class="number">1</span>;</span><br><span class="line">    _nop_();</span><br><span class="line">    _nop_();  <span class="comment">//该段时间不能过长，必须在15us内读取数据</span></span><br><span class="line">    <span class="keyword">if</span>(DS18B20_PORT)</span><br><span class="line">        dat = <span class="number">1</span>;        <span class="comment">//如果总线上为1则数据dat为1，否则为0</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dat = <span class="number">0</span>;</span><br><span class="line">    delay_10us(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> dat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ds18b20_read_byte</span></span><br><span class="line"><span class="comment">* 函数功能		   : 从DS18B20读取一个字节</span></span><br><span class="line"><span class="comment">* 输    入         : 无</span></span><br><span class="line"><span class="comment">* 输    出         : 一个字节数据</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds18b20_read_byte</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 dat = <span class="number">0</span>;</span><br><span class="line">    u8 temp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) <span class="comment">//循环8次，每次读取一位，且先读低位再读高位</span></span><br><span class="line">    &#123;</span><br><span class="line">        temp = ds18b20_read_bit(); <span class="comment">//将接收到的位赋给temp 例如temp接收到1</span></span><br><span class="line">        dat = (temp &lt;&lt; <span class="number">7</span>) | (dat &gt;&gt; <span class="number">1</span>); <span class="comment">//dat向右移动一位，将最高位移到次高位,temp向左移动7位将最低位移到最高位</span></span><br><span class="line">        <span class="comment">// 0000 0001 &lt;&lt; 7 --&gt; 1000 0000 ,接着两个进行或运算的结果赋给dat，此目的是为了保留dat的值</span></span><br><span class="line">        <span class="comment">//接着将dat向右移动1位到次高位与重新接收到的temp向左移动7位来进行或运算，以此类推进行八次循环</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ds18b20_start</span></span><br><span class="line"><span class="comment">* 函数功能		   : 开始温度转换</span></span><br><span class="line"><span class="comment">* 输    入         : 无</span></span><br><span class="line"><span class="comment">* 输    出         : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_start</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ds18b20_reset();          <span class="comment">//复位</span></span><br><span class="line">    ds18b20_check();          <span class="comment">//检查DS18B20是否存在</span></span><br><span class="line">    ds18b20_write_byte(<span class="number">0xCC</span>); <span class="comment">//发SKIP ROM 命令</span></span><br><span class="line">    ds18b20_write_byte(<span class="number">0x44</span>); <span class="comment">//发开始转换命令</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ds18b20_read_temperture(温度读取函数)</span></span><br><span class="line"><span class="comment">* 函数功能		   : 从ds18b20得到温度值</span></span><br><span class="line"><span class="comment">* 输    入         : 无</span></span><br><span class="line"><span class="comment">* 输    出         : 温度数据</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds18b20_read_temperture</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 dath = <span class="number">0</span>;</span><br><span class="line">    u8 datl = <span class="number">0</span>;</span><br><span class="line">    u16 value = <span class="number">0</span>;</span><br><span class="line">    <span class="type">float</span> temp;</span><br><span class="line"></span><br><span class="line">    ds18b20_start();</span><br><span class="line">    ds18b20_reset();          <span class="comment">//复位</span></span><br><span class="line">    ds18b20_check();          <span class="comment">//检查DS18B20是否存在</span></span><br><span class="line">    ds18b20_write_byte(<span class="number">0xCC</span>); <span class="comment">//发SKIP ROM 命令</span></span><br><span class="line">    ds18b20_write_byte(<span class="number">0xBE</span>); <span class="comment">//读存储器</span></span><br><span class="line"></span><br><span class="line">    datl = ds18b20_read_byte(); <span class="comment">//低八位字节数据</span></span><br><span class="line">    dath = ds18b20_read_byte(); <span class="comment">//高八位字节数据</span></span><br><span class="line">    value = (dath &lt;&lt; <span class="number">8</span>) + datl;<span class="comment">//合并为16位的数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(value &amp;&amp; <span class="number">0xF800</span> == <span class="number">0xf800</span>) <span class="comment">//判断符号位，负温度(如果该16位数据中前五位为 1 则表示温度小于0 )</span></span><br><span class="line">    &#123;</span><br><span class="line">        value = (~value) + <span class="number">1</span>;     <span class="comment">//读取到的数据取反再加1</span></span><br><span class="line">        temp = value * (<span class="number">-0.0625</span>);	<span class="comment">//乘以精度</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>   <span class="comment">//如果该16位数据中前五位为 0 则表示温度大于0</span></span><br><span class="line">        temp = value * <span class="number">0.0625</span>; <span class="comment">//读取到的数据直接乘以精度得出温度</span></span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ds18b20.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DS18B20_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DS18B20_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit DS18B20_PORT = P3^<span class="number">7</span>; <span class="comment">//定义ds18b20 DQ的管脚</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_reset</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">ds18b20_check</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">ds18b20_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_write_byte</span><span class="params">(u8 dat)</span>;</span><br><span class="line">u8 <span class="title function_">ds18b20_read_bit</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_write_byte</span><span class="params">(u8 dat)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ds18b20_start</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">ds18b20_read_temperture</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<blockquote>
<p>主函数代码很简单，在 while循环中间隔一定时间读取温度数据，并将温度值保留小数点后一位，然后将读取的温度数据转换为数码管可显示的段码，最后调用数码管显示函数</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> temp_value;</span><br><span class="line">    u8 temp_buf[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    ds18b20_init();  <span class="comment">//初始化DS18B20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">50</span> == <span class="number">0</span>) <span class="comment">//间隔一段时间读取温度值，间隔时间要大于温度传感器转换温度时间</span></span><br><span class="line">            temp_value = ds18b20_read_temperture() * <span class="number">10</span>; <span class="comment">//保留温度值小数后一位(乘以10保留最后一位小数) 如温度123.5乘以10为1235</span></span><br><span class="line">        <span class="keyword">if</span>(temp_value &lt; <span class="number">0</span>) <span class="comment">//负温度</span></span><br><span class="line">        &#123;</span><br><span class="line">            temp_value = -temp_value; <span class="comment">//显示负号</span></span><br><span class="line">            temp_buf[<span class="number">0</span>] = <span class="number">0x40</span>; <span class="comment">// 0x40为数码管那个负号</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            temp_buf[<span class="number">0</span>] = <span class="number">0x00</span>; <span class="comment">//不显示</span></span><br><span class="line">        &#125;</span><br><span class="line">        temp_buf[<span class="number">1</span>] = gsmg_code[temp_value / <span class="number">1000</span>]; <span class="comment">//百位 因为温度乘以10，所以该数值有四位数，要取出第一位得 /1000</span></span><br><span class="line">        temp_buf[<span class="number">2</span>] = gsmg_code[temp_value % <span class="number">1000</span> / <span class="number">100</span>]; <span class="comment">//十位</span></span><br><span class="line">        temp_buf[<span class="number">3</span>] = gsmg_code[temp_value % <span class="number">1000</span> % <span class="number">100</span> / <span class="number">10</span>] | <span class="number">0x80</span>; <span class="comment">//个位+小数点</span></span><br><span class="line">        temp_buf[<span class="number">4</span>] = gsmg_code[temp_value % <span class="number">1000</span> % <span class="number">100</span> % <span class="number">10</span>];  <span class="comment">//小数点后一位</span></span><br><span class="line">        smg_display(temp_buf, <span class="number">4</span>); <span class="comment">//在第四个数码管开始显示数据</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span>  <span class="comment">//库函数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds18b20.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>一定要注意温度传感器的方向，在接口处我们已经用丝印画了一个凸起，所以只需要将温度传感器对应插入即可</code></p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/407eeb0bee2e4a75bf4ab53da5205f42.webp" style="zoom:40%;" />
<h2 id="DS1302-时钟">DS1302 时钟</h2>
<h3 id="DS1302-时钟芯片简介">DS1302 时钟芯片简介</h3>
<p>DS1302 是 一种<code>涓流充电时钟芯片</code>，内含有一个<code>实时时钟/日历</code>和 31 字节<code>静态 RAM</code>，通过简单的<code>串行接口</code>与单片机进行通信。<code>实时时钟/日历电路提供秒、分、时、日、周、月、年</code>的信息，每月的天数和闰年的天数可自动调整。时钟操作可通过 AM/PM 指示决定采用 <code>24 或 12</code> 小时格式。</p>
<p>DS1302 与单片机之间能简单地采用<code>同步串行</code>的方式进行通信，仅需用到三根通信线：<code>①RES复位 ②I/O 数据线 ③SCLK 串行时钟</code>。时钟/RAM 的读/写数据以一个字节或多达31 个字节的字符组方式通信。DS1302 工作时功耗很低保持数据和时钟信息时功率小于 1mW。</p>
<p>DS1302 由 DS1202 改进而来增加了以下的特性：<code>双电源管脚用于主电源和备份电源供应</code>，<code>Vcc1 为可编程涓流充电电源</code>，附加七个字节存储器。它广泛应用于电话、传真、便携式仪器以及电池供电的仪器仪表等产品领域下面。</p>
<p><strong>主要的性能指标：</strong></p>
<blockquote>
<p>实时时钟具有能计算 <code>2100 年之前</code>的秒、分、时、日、星期、月、年的能力，还有闰年调整的能力；<br>
31 个 8 位暂存数据存储 RAM；<br>
串行 I/O 口方式使得管脚数量最少；<br>
宽范围工作电压 2.0 - 5.5V；<br>
工作在 2.0V 时，电流小于 300nA；<br>
读/写时钟或 RAM 数据时有两种传送方式<code>单字节传送</code>和<code>多字节传送字符组</code>方式；<br>
8 脚 DIP 封装或可选的 8 脚 SOIC 封装根据表面装配；<br>
简单 3 线接口；<br>
与 TTL 兼容 Vcc=5V；<br>
可选工业级温度范围-40~+85</p>
</blockquote>
<p><strong>DS1302 芯片的管脚及功能</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/ea301ae157784841a6d82ac946e4926a.webp" style="zoom:50%;" />
<blockquote>
<p>1、<code>VCC2</code>：主电源引脚<br>
2、<code>X1、X2</code>：DS1302 外部晶振引脚，通常需外接 <code>32.768K 晶振</code><br>
3、<code>GND</code>：电源地<br>
4、<code>CE</code>：使能引脚，也是复位引脚（新版本功能变）<br>
5、<code>I/O</code>：串行数据引脚，数据输出或者输入都从这个引脚<br>
6、<code>SCLK</code>：串行时钟引脚<br>
7、<code>VCC1</code>：备用电源</p>
</blockquote>
<h3 id="DS1302-使用">DS1302 使用</h3>
<p>操作 DS1302 的大致过程，就是将各种<code>数据写入 DS1302 的寄存器</code>，以设置它当前的时间的格式。然后<code>使 DS1302 开始运作</code>，DS1302 时钟会按照设置情况运转，再用<code>单片机将其寄存器内的数据读出</code>。再用<code>液晶显示</code>，就是我们常说的简易电子钟。所以总的来说 DS1302 的操作分 2 步（显示部分属于液晶显示的内容，不属于 DS1302 本身的内容）</p>
<p>DS1302 有一个控制寄存器、12 个日历、时钟寄存器和 31 个 RAM</p>
<h4 id="控制寄存器">控制寄存器</h4>
<p>控制寄存器用于存放 DS1302 的控制命令字，DS1302 的 <code>RST</code> 引脚回到<code>高电平</code>后写入的<code>第一个字节就为控制命令</code>。它用于<code>对 DS1302 读写过程进行控制</code>，格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/cfeba1df0ac74b1bad2c2863796fa3ab.webp" style="zoom:40%;" />
<p>1、第 7 位永远都是 1；<br>
2、第 6 位，<code>1 表示 RAM，寻址内部存储器地址；0 表示 CK，寻址内部寄存器</code>；<br>
3、第 5 到第 1 位，为 RAM 或者寄存器的<code>地址</code>；<br>
4、最低位，<code>高电平</code>表示 RD，即下一步操作将要“<code>读</code>”；<code>低电平</code>表示 W，即下一步操作将要“<code>写</code>”。（与 AT24C02 寄存器类似，0读1写）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/eb2b895ba5f44ef68e3596573a2f5d87.webp" style="zoom:40%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/c65ad7bab07548e3a528350b229e0682.webp" style="zoom:40%;" />
<p>比如要<code>读秒寄存器</code>则命令为 1000 0001，反之写为 1000 0000</p>
<h4 id="日历-时钟寄存器">日历/时钟寄存器</h4>
<p>DS1302 共有 12 个寄存器，其中有 7 个与日历、时钟相关，存放的数据为 <code>BCD码</code>形式。格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b79c113e146e440089dd0c3cbd16aa90.webp" style="zoom:40%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/1c54c6ec19324dcb98fb22f6b8df66e2.webp" style="zoom:40%;" />
<p><strong>秒寄存器</strong>：低四位为秒的个位，高的次三位为秒的十位。最高位<code>CH</code> 为DS1302 的<code>运行标志</code>，当 <code>CH=0</code> 时，DS1302 <code>内部时钟运行</code>，反之 CH=1 时停止。</p>
<p><strong>小时寄存器</strong>：<code>时寄存器</code>。<code>最高位为 12/24 小时的格式选择位</code>，该位为 <code>1</code> 时表示 <code>12 小时</code>格式。当设置为 12 小时显示格式时，<code>第 5 位的高电平表示下午（PM）</code>；而当设置为 24 小时格式时，第 5 位为具体的时间数据。</p>
<p><strong>写保护寄存器</strong>：当该寄存器最高位 <code>WP 为 1</code> 时，DS1302<code>只读不写</code>，所以要在往 <code>DS1302 写数据之前确保 WP 为 0</code>。</p>
<p><strong>慢充电寄存器（涓细电流充电）寄存器</strong>：当 DS1302 掉电时，可以马上调用外部电源保护时间数据。该寄存器就是配置备用电源的充电选项的。其中高四位（4 个 TCS）只有在 1010 的情况下才能使用充电选项；低四位的情况与 DS1302 内部电路有关。</p>
<p><strong>什么是BCD 码</strong></p>
<blockquote>
<p>BCD 码是<code>通过 4 位二进制码来表示 1 位十进制中的 0~9 这 10 个数码</code></p>
</blockquote>
<p>如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/b1af064f5a32430ca69ab77f2011df59.webp" style="zoom:50%;" />
<p>从 DS1302 中读取出来的时钟数据均为 BCD 码格式，需转换为我们习惯的 10 进制</p>
<h4 id="DS1302-的读写时序">DS1302 的读写时序</h4>
<p>在<code>控制指令字输入后的下一个 SCLK 时钟的上升沿</code>时，<code>数据被写入 DS1302</code>，数据输入从<code>低位</code>（位 0）开始。同样，在紧跟 8 位的控制指令字后的<code>下一个 SCLK脉冲的下降沿读出 DS1302 的数据</code>，读出数据时从低位 0 位到高位 7。其时序图如下所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/febc7480c6534db7b37910623293d6c6.webp" style="zoom: 33%;" />
<p>上图就是 DS1302 的三个时序：<code>复位时序，单字节写时序，单字节读时序</code>；</p>
<p><strong>CE（RST</strong>）：<code>复位时序</code>，即在 RST 引脚产生一个正脉冲，在<code>整个读写器件，RST 要保持高电平</code>，一次字节<code>读写完毕</code>之后，要注意把 RST 返回<code>低电平</code>准备下次读写周期；</p>
<p><strong>单字节读时序</strong>：注意读之前还是要<code>先对寄存器写命令</code>，前八个为控制寄存器地址，从<code>最低位</code>开始写；可以看到，<code>写数据</code>是在 SCLK 的<code>上升沿</code>实现，而<code>读数据</code>在 SCLK 的<code>下降沿</code>实现。所以，在单字节读时序中，写命令的<code>第八个上升沿结束后</code>紧接着的<code>第八个下降沿</code>就将要<code>读</code>寄存器的<code>第一位数据</code>读到数据线上了！这个就是 DS1302 操作中最特别的地方。当然读出来的数据也是<code>最低位</code>开始。</p>
<p><strong>单字节写时序</strong>：两个字节的数据配合 <code>16 个上升沿</code>将数据写入即可。</p>
<blockquote>
<p><strong>程序注意事项</strong>：<br>
★要记得在操作 DS1302 之前关闭写保护(即<code>确保 WP 为 0</code>)；<br>
★注意用<code>延时</code>来降低单片机的速度以配合器件时序；<br>
★DS1302 读出来的数据是 <code>BCD 码</code>形式，要转换成我们习惯的 10 进制；<br>
★读取字节之前，将 IO 设置为输入口，读取完之后，要将其改回输出口；<br>
★在写程序的时候，建议实现开辟数组（内存空间）来集中放置 DS1302 的一系列数据，方便以后扩展键盘输入。</p>
</blockquote>
<h3 id="DS1302时钟原理图">DS1302时钟原理图</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/432b5c326f674ecc9b7e2a1873e704df.jpg" style="zoom:40%;" />
<p>DS1302 芯片的控制管脚接至单片机 <code>P3.4-P3.6</code> 上，在芯片的<code>X1、X2 管脚</code>处外接了一个<code>32.768KHZ 晶振</code>，为<code>时钟运行提供一个稳定的时钟频率</code>，C2 和 C3 为旁路电容，目的是消除晶振起振时产生的电感干扰。如果需要备用电源可将外部备用电源接入第 8 脚 VCC1。</p>
<h3 id="DS1302时钟实验程序">DS1302时钟实验程序</h3>
<blockquote>
<h4 id="数码管上显示电子时钟时分秒，格式为“XX-XX-XX”"><strong>数码管上显示电子时钟时分秒，格式为“XX-XX-XX”</strong></h4>
</blockquote>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能		 : 动态数码管显示</span></span><br><span class="line"><span class="comment">* 输    入       : dat：要显示的数据</span></span><br><span class="line"><span class="comment">				 location：从左开始第几个位置开始显示，范围1-8</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 i = <span class="number">0</span>;</span><br><span class="line">	u8 location_temp = location - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = location_temp; i &lt; <span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">switch</span>(i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>: LSC = <span class="number">1</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>: LSC = <span class="number">1</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span>: LSC = <span class="number">0</span>;LSB = <span class="number">1</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">6</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">1</span>;<span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">7</span>: LSC = <span class="number">0</span>;LSB = <span class="number">0</span>;LSA = <span class="number">0</span>;<span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">		&#125;</span><br><span class="line">		SMG_A_DP_PORT = dat[i - location_temp]; <span class="comment">//传送段选数据</span></span><br><span class="line">		delay_10us(<span class="number">100</span>);<span class="comment">//延时一段时间，等待显示稳定</span></span><br><span class="line">		SMG_A_DP_PORT=<span class="number">0x00</span>;<span class="comment">//消音</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>]; <span class="comment">//允许外部进行调用就得用extern</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>ds1302.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//---DS1302写入和读取时分秒的地址命令---//</span></span><br><span class="line"><span class="comment">//---秒分时日月周年 最低位读写位;-------//</span></span><br><span class="line">u8 gWRITE_addr[<span class="number">7</span>] = &#123;<span class="number">0x80</span>,<span class="number">0x82</span>,<span class="number">0x84</span>,<span class="number">0x86</span>,<span class="number">0x88</span>,<span class="number">0x8a</span>,<span class="number">0x8c</span>&#125;;<span class="comment">//数据可查看各类寄存器</span></span><br><span class="line">u8 gRREAD_addr[<span class="number">7</span>] = &#123;<span class="number">0x81</span>,<span class="number">0x83</span>,<span class="number">0x85</span>,<span class="number">0x87</span>,<span class="number">0x89</span>,<span class="number">0x8b</span>,<span class="number">0x8d</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//---DS1302时钟初始化2023年8月8日星期二18点34分01秒。---//</span></span><br><span class="line"><span class="comment">//---存储顺序是秒分时日月周年,存储格式是用BCD码---//</span></span><br><span class="line">u8 gDS1302_TIME[<span class="number">7</span>] = &#123;<span class="number">0x01</span>,<span class="number">0x34</span>,<span class="number">0x18</span>,<span class="number">0x08</span>,<span class="number">0x08</span>,<span class="number">0x02</span>,<span class="number">0x23</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : ds1302_write_byte</span></span><br><span class="line"><span class="comment">* 函数功能		 : DS1302写单字节</span></span><br><span class="line"><span class="comment">* 输    入       : addr：地址/命令</span></span><br><span class="line"><span class="comment">				   dat：数据</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_write_byte</span><span class="params">(u8 addr,u8 dat)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 i = <span class="number">0</span>;</span><br><span class="line">	DS1302_CE = <span class="number">0</span>;    <span class="comment">//首先CE输出低电平</span></span><br><span class="line">	_nop_();          <span class="comment">//延时1us</span></span><br><span class="line">	DS1302_SCLK = <span class="number">0</span>;  <span class="comment">//SCLK也输出低电平</span></span><br><span class="line">	_nop_();</span><br><span class="line">	DS1302_CE = <span class="number">1</span>;    <span class="comment">//在读写过程，CE要保持高电平</span></span><br><span class="line">	_nop_();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)  <span class="comment">//循环8次，每次写1位，先写低位再写高位</span></span><br><span class="line">	&#123;</span><br><span class="line">		DS1302_IO = addr &amp; <span class="number">0x01</span>; <span class="comment">//取出控制寄存器地址的最低位赋给DS1302的IO口</span></span><br><span class="line">		addr &gt;&gt;= <span class="number">1</span>;              <span class="comment">//将控制寄存器地址的次低位移到最低位</span></span><br><span class="line">		DS1302_SCLK = <span class="number">1</span>;         <span class="comment">//SCLK由低到高产生一个上升沿，从而写入数据</span></span><br><span class="line">		_nop_();</span><br><span class="line">		DS1302_SCLK = <span class="number">0</span>;         <span class="comment">//SCLK先拉低，以便下一次上升沿</span></span><br><span class="line">		_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++) <span class="comment">//循环8次，每次写1位，先写低位再写高位</span></span><br><span class="line">	&#123;</span><br><span class="line">		DS1302_IO = dat &amp; <span class="number">0x01</span>; <span class="comment">//取出写入数据的最低位赋给DS1302的IO口</span></span><br><span class="line">		dat &gt;&gt;= <span class="number">1</span>;              <span class="comment">//将数据的次低位移到最低位</span></span><br><span class="line">		DS1302_SCLK = <span class="number">1</span>;        <span class="comment">//SCLK由低到高产生一个上升沿，从而写入数据</span></span><br><span class="line">		_nop_();                <span class="comment">//延时1us</span></span><br><span class="line">		DS1302_SCLK = <span class="number">0</span>;        <span class="comment">//SCLK先拉低，以便下一次上升沿</span></span><br><span class="line">		_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">	DS1302_CE = <span class="number">0</span>; <span class="comment">//RST拉低</span></span><br><span class="line">	_nop_();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : ds1302_read_byte</span></span><br><span class="line"><span class="comment">* 函数功能		 : DS1302读单字节</span></span><br><span class="line"><span class="comment">* 输    入       : addr：地址/命令</span></span><br><span class="line"><span class="comment">* 输    出    	 : 读取的数据</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line">u8 <span class="title function_">ds1302_read_byte</span><span class="params">(u8 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 i = <span class="number">0</span>;</span><br><span class="line">	u8 temp = <span class="number">0</span>; <span class="comment">//接收数据中一个位的变量</span></span><br><span class="line">	u8 dat = <span class="number">0</span>;  <span class="comment">//将接收到的数据存放到这个变量</span></span><br><span class="line">	</span><br><span class="line">	DS1302_CE = <span class="number">0</span>;    <span class="comment">//首先CE输出低电平</span></span><br><span class="line">	_nop_();          <span class="comment">//延时1us</span></span><br><span class="line">	DS1302_SCLK = <span class="number">0</span>;  <span class="comment">//SCLK也输出低电平</span></span><br><span class="line">	_nop_();</span><br><span class="line">	DS1302_CE = <span class="number">1</span>;    <span class="comment">//在读写过程，CE要保持高电平</span></span><br><span class="line">	_nop_();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)  <span class="comment">//循环8次，每次写1位，先写低位再写高位</span></span><br><span class="line">	&#123;</span><br><span class="line">		DS1302_IO = addr &amp; <span class="number">0x01</span>; <span class="comment">//取出控制寄存器地址的最低位赋给DS1302的IO口</span></span><br><span class="line">		addr &gt;&gt;= <span class="number">1</span>;              <span class="comment">//将控制寄存器地址的次低位移到最低位</span></span><br><span class="line">		DS1302_SCLK = <span class="number">1</span>;         <span class="comment">//SCLK由低到高产生一个上升沿，从而写入数据</span></span><br><span class="line">		_nop_();</span><br><span class="line">		DS1302_SCLK = <span class="number">0</span>;         <span class="comment">//SCLK先拉低，以便下一次上升沿</span></span><br><span class="line">		_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++) <span class="comment">//循环8次，每次读1位，先读低位再读高位</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp = DS1302_IO;  <span class="comment">//将在IO口接收到的数据中的一位存放到temp变量中</span></span><br><span class="line">		dat = (temp &lt;&lt; <span class="number">7</span>) | (dat &gt;&gt; <span class="number">1</span>); <span class="comment">//先将dat右移1位，然后temp左移7位，最后或运算(或运算中或符号后面的数据优先级比较高)</span></span><br><span class="line">		DS1302_SCLK = <span class="number">1</span>;         </span><br><span class="line">		_nop_();</span><br><span class="line">		DS1302_SCLK = <span class="number">0</span>;         <span class="comment">//SCLK由高到低产生一个下降沿，从而读入数据</span></span><br><span class="line">		_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">	DS1302_CE = <span class="number">0</span>; <span class="comment">//CE拉低</span></span><br><span class="line">	_nop_();</span><br><span class="line">	DS1302_SCLK = <span class="number">1</span>; <span class="comment">//对于实物中，P3.4口没有外接上拉电阻的，此处代码需要添加，使数据口有一个上升沿脉冲</span></span><br><span class="line">	_nop_();</span><br><span class="line">	DS1302_IO = <span class="number">0</span>;  </span><br><span class="line">	_nop_();</span><br><span class="line">	DS1302_IO = <span class="number">1</span>;  <span class="comment">//读取字节之前，将 IO 设置为输入口，读取完之后，要将其改回输出口</span></span><br><span class="line">	_nop_();</span><br><span class="line">	<span class="keyword">return</span> dat;  <span class="comment">//将读取到的数据返回出去</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : ds1302_init</span></span><br><span class="line"><span class="comment">* 函数功能		 : DS1302初始化时间</span></span><br><span class="line"><span class="comment">* 输    入       : 无</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 i = <span class="number">0</span>;</span><br><span class="line">	ds1302_write_byte(<span class="number">0x8E</span>,<span class="number">0X00</span>); <span class="comment">//关闭写保护(写保护寄存器的地址为0x8E,WP为其中的最高位，WP为0即为关闭写保护)</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">7</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		ds1302_write_byte(gWRITE_addr[i],gDS1302_TIME[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	ds1302_write_byte(<span class="number">0x8E</span>,<span class="number">0X80</span>); <span class="comment">//打开写保护，以防止意外修改DS1302内部寄存器(WP为1即为打开写保护)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : ds1302_read_time</span></span><br><span class="line"><span class="comment">* 函数功能		 : DS1302读取时间</span></span><br><span class="line"><span class="comment">* 输    入       : 无</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_read_time</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">7</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		gDS1302_TIME[i] = ds1302_read_byte(gRREAD_addr[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ds1302.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DS1302_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DS1302_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sbit DS1302_CE = P3^<span class="number">5</span>;   <span class="comment">//复位管脚</span></span><br><span class="line">sbit DS1302_IO = P3^<span class="number">4</span>;   <span class="comment">//数据管脚</span></span><br><span class="line">sbit DS1302_SCLK = P3^<span class="number">6</span>; <span class="comment">//时钟管脚</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_write_byte</span><span class="params">(u8 addr,u8 dat)</span>;</span><br><span class="line">u8 <span class="title function_">ds1302_read_byte</span><span class="params">(u8 addr)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ds1302_read_time</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gDS1302_TIME[<span class="number">7</span>];<span class="comment">//使用extern之后外部文件就可以调用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 time_buf[<span class="number">8</span>]; <span class="comment">//将读取的数据存储到一个缓存数组中，方便数据的处理与显示</span></span><br><span class="line">	ds1302_init(); <span class="comment">//初始化DS1302</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">			ds1302_read_time(); <span class="comment">//读取时间</span></span><br><span class="line">			<span class="comment">//时</span></span><br><span class="line">			time_buf[<span class="number">0</span>] = gsmg_code[gDS1302_TIME[<span class="number">2</span>] / <span class="number">16</span>]; <span class="comment">//取出小时的第一位，由于是BCD码格式，类似于十六进制的高四位和低四位，所以得 / 16</span></span><br><span class="line">			time_buf[<span class="number">1</span>] = gsmg_code[gDS1302_TIME[<span class="number">2</span>] % <span class="number">16</span>]; <span class="comment">//取出小时的第二位</span></span><br><span class="line">			time_buf[<span class="number">2</span>] = <span class="number">0x40</span>;                            <span class="comment">//在数码管中表示横杠</span></span><br><span class="line">			<span class="comment">//分</span></span><br><span class="line">			time_buf[<span class="number">3</span>] = gsmg_code[gDS1302_TIME[<span class="number">1</span>] / <span class="number">16</span>]; <span class="comment">//取出分的第一位</span></span><br><span class="line">			time_buf[<span class="number">4</span>] = gsmg_code[gDS1302_TIME[<span class="number">1</span>] % <span class="number">16</span>]; <span class="comment">//取出分的第二位</span></span><br><span class="line">			time_buf[<span class="number">5</span>] = <span class="number">0x40</span>;</span><br><span class="line">			<span class="comment">//秒</span></span><br><span class="line">			time_buf[<span class="number">6</span>] = gsmg_code[gDS1302_TIME[<span class="number">0</span>] / <span class="number">16</span>]; <span class="comment">//取出秒的第一位</span></span><br><span class="line">			time_buf[<span class="number">7</span>] = gsmg_code[gDS1302_TIME[<span class="number">0</span>] % <span class="number">16</span>]; <span class="comment">//取出秒的第二位</span></span><br><span class="line">			smg_display(time_buf,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主函数代码先初始化 DS1302 并设定好初始时间，进入 while 循环，读取 DS1302 时钟数据存储至全局变量数组gDS1302_TIME 中，最后将读取的数据转换为数码管可显示的段码数据并调用数码管显示函数显示时间。</p>
<blockquote>
<p>在处理 DS1302 读取的数据时，<code>取高低位是使用除16和取余16</code>，并非之前的除 10 和取余 10。这是因为写入进 DS1302 时是 <code>BCD 码</code>，读取出的数据也是 BCD 码，而 BCD 码即是 4 位表示一个十进制数，类似于一个字节的十六进制数据的高 4 位和低 4 位一样，所以这里是除 16 和取余 16</p>
</blockquote>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;intrins.h&quot;</span>  <span class="comment">//库函数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="红外遥控">红外遥控</h2>
<h3 id="红外遥控介绍">红外遥控介绍</h3>
<p><strong>（1） 红外线简介</strong></p>
<p>人的眼睛能看到的可见光按波长从长到短排列，依次为红、橙、黄、绿、青、蓝、紫。其中红光的波长范围为 0.62～0.76μm；紫光的波长范围为 0.38～0.46μm。比紫光波长还短的光叫<code>紫外线</code>，比红光波长还长的光叫<code>红外线</code>。红外线遥控就是利用波长为 0.76～1.5μm 之间的近红外线来传送控制信号的。</p>
<p><strong>（2） 红外遥控的原理</strong></p>
<p>红外遥控是一种<code>无线、非接触</code>控制技术，具有抗干扰能力强，信息传输可靠，功耗低，成本低，易实现等显著优点，被诸多电子设备特别是家用电器广泛采用，并越来越多的应用到计算机系统中。</p>
<p>红外遥控通信系统一般由<code>红外发射装置</code>和<code>红外接收设备</code>两大部分组成。</p>
<p><strong>1） 红外发射装置</strong></p>
<p>红外发射装置，也就是通常我们说的红外遥控器是由<code>键盘电路、红外编码电路、电源电路和红外发射电路</code>组成。红外发射电路的主要元件为<code>红外发光二极管</code>。它实际上是一只特殊的发光二极管；由于其内部材料不同于普通发光二极管，因而在其两端施加一定电压时，它便发出的是红外线而不是可见光。目前大量的使用的红外发光二极管发出的红外线波长为 940nm 左右，外形与普通发光二极管相同。红外发光二极管有透明的，还有不透明的。红外遥控器和红外发光二极管如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/5bbbed137a7b469da6c0b670f3f39bac.webp" style="zoom:30%;" />
<p>通常红外遥控为了提高抗干扰性能和降低电源消耗，红外遥控器常用载波的方式传送<code>二进制编码</code>，常用的载波频率为 38kHz，这是由发射端所使用的 455kHz晶振来决定的。在发射端要对晶振进行整数分频，分频系数一般取 12，所以455kHz÷12≈37.9kHz≈38kHz。也有一些遥控系统采用 36kHz、 40 kHz、 56 kHz等，一般由发射端晶振的振荡频率来决定。所以，通常的红外遥控器是<code>将遥控信号（二进制脉冲码）调制在 38KHz 的载波上，经缓冲放大后送至红外发光二极管，转化为红外信号发射出去的</code>。</p>
<p>二进制脉冲码的形式有多种，其中最为常用的是 <code>NEC Protocol 的 PWM码</code>(脉冲宽度调制)和 Philips RC-5 Protocol 的<code>PPM 码</code>脉冲位置调制码，脉冲串之间的时间间隔来实现信号调制)。如果要开发红外接收设备，一定要知道红外遥控器的<code>编码方式和载波频率</code>。开发板配套的红外遥控器使用的是 <code>NEC</code>协议，其特征如下：</p>
<blockquote>
<p>1、8 位地址和 8 位指令长度；<br>
2、地址和命令 2 次传输（确保可靠性）<br>
3、PWM 脉冲位置调制，以发射红外载波的占空比代表“0”和“1”；<br>
4、载波频率为 38Khz；<br>
5、位时间为 1.125ms 或 2.25ms</p>
</blockquote>
<p>NEC 码的位定义：一个脉冲对应 560us 的连续载波，一个逻辑 1 传输需要2.25ms（560us 脉冲+1680us 低电平），一个逻辑 0 的传输需要 1.125ms（560us脉冲+560us 低电平）。而红外接收头在收到脉冲的时候为低电平，在没有脉冲的时候为高电平，这样，我们在接收头端收到的信号为：<code>逻辑 1 应该是 560us 低+1680us 高，逻辑 0 应该是 560us 低+560us 高</code>。所以可以通过<code>计算高电平时间判断接收到的数据是 0 还是 1</code>。NEC 码位定义时序图如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f74c865950b74ebbb8c82974a8055cc8.webp" style="zoom:40%;" />
<p>NEC 遥控指令的数据格式为：<code>引导码、地址码、地址反码、控制码、控制反码</code>。引导码由一个 9ms 的低电平和一个 4.5ms 的高电平组成，地址码、地址反码、控制码、控制反码均是 <code>8 位数据</code>格式。按照<code>低位在前，高位在后</code>的顺序发送。采用反码是为了<code>增加传输的可靠性</code>（可用于校验）。数据格式如下：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/f09b2412150548bc8ab72ef50c196b71.webp" style="zoom:40%;" />
<p>NEC 码还规定了连发码(由 9ms 低电平+2.5m 高电平+0.56ms 低电平+97.94ms 高电平组成)，如果在一帧数据发送完毕之后，红外遥控器按键仍然没有放开，则发射连发码，可以通过统计连发码的次数来标记按键按下的长短或次数。</p>
<p><strong>2） 红外接收设备</strong></p>
<p>红外接收设备是由<code>红外接收电路、红外解码、电源和应用电路</code>组成。红外遥控接收器的主要作用是<code>将遥控发射器发来的红外光信好转换成电信号</code>，再放大、限幅、检波、整形，形成遥控指令脉冲，输出至遥控微处理器。成品红外接收头的封装大致有两种：一种采用铁皮屏蔽；一种是塑料封装。均有三只引脚，即<code>电源正（ VDD）、电源负（GND）和数据输出（VOUT）</code>。其外观实物图如下图所示：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/0441131bcfa54cc980f7154ab2e14330.webp" style="zoom:40%;" />
<p>正对接收头的凸起处看，从左至右，管脚依次是<code>1：VOUT，2：GND，3：VDD</code>。由于红外接收头在<code>没有脉冲</code>的时候为<code>高电平</code>，当<code>收到脉冲</code>的时候为<code>低电平</code>，所以可以通过<code>外部中断的下降沿</code>触发中断，在中断内通过计算<code>高电平时间</code>来判断接收到的数据是 <code>0 还是 1</code>。</p>
<h3 id="红外接收模块电路">红外接收模块电路</h3>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/51a7ac17d53045b1ba34b47c7b6ce774.webp" style="zoom:50%;" />
<p>从上图中可知，红外接收头的输出管脚接至单片机 <code>P3.2</code> 管脚上，为了保证红外接收头输出管脚默认为<code>高电平</code>，需外接一个 10K 上拉电阻。</p>
<h3 id="红外遥控实验">红外遥控实验</h3>
<blockquote>
<h4 id="数码管上显示红外解码遥控器键值"><strong>数码管上显示红外解码遥控器键值</strong></h4>
</blockquote>
<p><code>smg.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名       : smg_display</span></span><br><span class="line"><span class="comment">* 函数功能		     : 动态数码管显示</span></span><br><span class="line"><span class="comment">* 输    入       : dat：要显示的数据</span></span><br><span class="line"><span class="comment">				           location：从左开始第几个位置开始显示，范围1-8</span></span><br><span class="line"><span class="comment">* 输    出    	 : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 i = <span class="number">0</span>;</span><br><span class="line">    u8 location_temp = location - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = location_temp; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(i)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y7 LED8 板子从左边数第一个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y6 LED7 板子从左边数第二个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y5 LED6 板子从左边数第三个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            LSC = <span class="number">1</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y4 LED5 板子从左边数第四个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y3 LED4 板子从左边数第五个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">1</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y2 LED3 板子从左边数第六个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y1 LED2 板子从左边数第七个数码管</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            LSC = <span class="number">0</span>;</span><br><span class="line">            LSB = <span class="number">0</span>;</span><br><span class="line">            LSA = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">//Y0 LED1 板子从左边数第八个数码管</span></span><br><span class="line">        &#125;</span><br><span class="line">        SMG_A_DP_PORT = dat[i - location_temp]; <span class="comment">//传送段选数据</span></span><br><span class="line">        delay_10us(<span class="number">100</span>);<span class="comment">//延时一段时间，等待显示稳定</span></span><br><span class="line">        SMG_A_DP_PORT = <span class="number">0x00</span>; <span class="comment">//消影</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>smg.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SMG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SMG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SMG_A_DP_PORT P0  <span class="comment">//宏定义数码管P0端口</span></span></span><br><span class="line"></span><br><span class="line">sbit LSA = P2^<span class="number">2</span>; <span class="comment">//将P2.2管脚定义为LSA</span></span><br><span class="line">sbit LSB = P2^<span class="number">3</span>; <span class="comment">//将P2.3管脚定义为LSB</span></span><br><span class="line">sbit LSC = P2^<span class="number">4</span>; <span class="comment">//将P2.4管脚定义为LSC</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">smg_display</span><span class="params">(u8 dat[], u8 location)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 gsmg_code[<span class="number">17</span>]; <span class="comment">//允许外部进行调用就得用extern</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>ired.c</code></p>
<p>使用外部中断 0 来解码红外遥控数据，所以需初始化配置外部中断0。</p>
<p>初始化外部中断后，中断就已经开启了，当 P32 引脚来一个下降沿，就会触发一次中断，在中断内我们可以计算高电平时间，通过高电平时间判断是否进入引导码及数据 0 和 1。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 gired_data[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment">* 函 数 名         : ired_init</span></span><br><span class="line"><span class="comment">* 函数功能		   : 红外端口初始化函数，外部中断0配置</span></span><br><span class="line"><span class="comment">* 输    入         : 无</span></span><br><span class="line"><span class="comment">* 输    出         : 无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ired_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IT0 = <span class="number">1</span>;  <span class="comment">//下降沿触发</span></span><br><span class="line">    EX0 = <span class="number">1</span>;  <span class="comment">//打开中断0允许</span></span><br><span class="line">    EA = <span class="number">1</span>;   <span class="comment">//打开总中断</span></span><br><span class="line">    IRED = <span class="number">1</span>; <span class="comment">//初始化端口</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ired</span><span class="params">()</span> interrupt 0  <span class="comment">//外部中断0服务函数</span></span><br><span class="line">&#123;</span><br><span class="line">    u16 time_cnt = <span class="number">0</span>;</span><br><span class="line">    u8 i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    u8 ired_high_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(IRED == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        time_cnt = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">while</span>((!IRED) &amp;&amp; (time_cnt))  <span class="comment">//等待引导信号9ms低电平结束，若超过10ms强制退出,若高电平则跳出循环</span></span><br><span class="line">        &#123;</span><br><span class="line">            delay_10us(<span class="number">1</span>);  <span class="comment">//延时约10us 10us*1000 = 10000us --&gt; 10ms</span></span><br><span class="line">            time_cnt--;</span><br><span class="line">            <span class="keyword">if</span>(time_cnt == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(IRED)  <span class="comment">//引导信号9ms低电平已过，进入4.5ms高电平</span></span><br><span class="line">        &#123;</span><br><span class="line">            time_cnt = <span class="number">500</span>;</span><br><span class="line">            <span class="keyword">while</span>((IRED) &amp;&amp; (time_cnt)) <span class="comment">//等待引导信号4.5ms高电平结束，若超过5ms强制退出</span></span><br><span class="line">            &#123;</span><br><span class="line">                delay_10us(<span class="number">1</span>); <span class="comment">//延时约10us 10us*500 = 5000us --&gt; 5ms</span></span><br><span class="line">                time_cnt--;</span><br><span class="line">                <span class="keyword">if</span>(time_cnt == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) <span class="comment">//循环4次，读取4个字节数据(地址码、地址反码、控制码、控制反码)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) <span class="comment">//循环8次读取每位数据即一个字节</span></span><br><span class="line">                &#123;</span><br><span class="line">                    time_cnt = <span class="number">600</span>;</span><br><span class="line">                    <span class="keyword">while</span>((!IRED) &amp;&amp; (time_cnt)) <span class="comment">//等待数据1或0前面的0.56ms结束，若超过6ms强制退出</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        delay_10us(<span class="number">1</span>);  <span class="comment">//延时约10us 10us*600 = 6000us --&gt; 6ms</span></span><br><span class="line">                        time_cnt--;</span><br><span class="line">                        <span class="keyword">if</span>(time_cnt == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">while</span>(IRED)  <span class="comment">//等待数据1或0后面的高电平结束，若超过2ms强制退出</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        delay_10us(<span class="number">10</span>);  <span class="comment">//约0.1ms 100us*20 == 2000us --&gt; 2ms</span></span><br><span class="line">                        ired_high_time++;</span><br><span class="line">                        <span class="keyword">if</span>(ired_high_time &gt; <span class="number">20</span>) <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    gired_data[i] &gt;&gt;= <span class="number">1</span>; <span class="comment">//数据是先传低位再传高位，所以接收到的低位数据需要往右移一位</span></span><br><span class="line">                    <span class="keyword">if</span>(ired_high_time &gt;= <span class="number">8</span>) <span class="comment">//如果高电平时间大于0.8ms，数据则为1，否则为0</span></span><br><span class="line">                        gired_data[i] |= <span class="number">0x80</span>; <span class="comment">//如果高电平时间大于0.8ms则接收到的数据为1，或上0x80相当于取出最高位的数据</span></span><br><span class="line">                    <span class="comment">//接着向右移动一位</span></span><br><span class="line">                    ired_high_time = <span class="number">0</span>; <span class="comment">//重新清零，等待下一次计算时间</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(gired_data[<span class="number">2</span>] != ~gired_data[<span class="number">3</span>]) <span class="comment">//校验控制码与反码，错误则返回</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                gired_data[i] = <span class="number">0</span>; <span class="comment">//接收到的数据清0</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ired.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _IRED_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IRED_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//管脚定义</span></span><br><span class="line">sbit IRED = P3^<span class="number">2</span>; <span class="comment">//管脚定义</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明变量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ired_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="keyword">extern</span> u8 gired_data[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>Delay.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------------------------- begin  ------------------------------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @函数名:  delay_us</span></span><br><span class="line"><span class="comment">  * @参数1 : 需要延时多少微秒</span></span><br><span class="line"><span class="comment">  * @返回值: 无</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">/* -------------------------------- end -------------------------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span> <span class="comment">//当传入ten_us==1时，大约延时10us</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(ten_us--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delay.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;  <span class="comment">//对系统默认数据类型进行重命名</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_10us</span><span class="params">(u16 ten_us)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>
<p><code>main.c</code></p>
<p>主函数代码首先初始化红外，进入while 循环将红外解码数据转换为数码管段码数据，然后在数码管上显示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AllHead.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 ired_buf[<span class="number">3</span>];</span><br><span class="line">    ired_init();  <span class="comment">//红外初始化</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ired_buf[<span class="number">0</span>] = gsmg_code[gired_data[<span class="number">2</span>] / <span class="number">16</span> ]; <span class="comment">//将控制码高4位转换为数码管段码</span></span><br><span class="line">        ired_buf[<span class="number">1</span>] = gsmg_code[gired_data[<span class="number">2</span>] % <span class="number">16</span> ]; <span class="comment">//将控制码低4位转换为数码管段码</span></span><br><span class="line">        ired_buf[<span class="number">2</span>] = <span class="number">0x76</span>;  <span class="comment">//显示H的段码</span></span><br><span class="line">        smg_display(ired_buf, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AllHead.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ALLHEAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ALLHEAD_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;smg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ired.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：红外接收头的凸起位置需对到 PCB 板丝印凸出位置，否则功能无法正常实现。</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1320729634.cos.ap-guangzhou.myqcloud.com/image/c2eeb1286f7e4299bda1b80a980e475f.webp" style="zoom: 33%;" />
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/num1.webp" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LED"><span class="toc-number">2.</span> <span class="toc-text">LED</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">LED简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">2.2.</span> <span class="toc-text">LED原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.3.</span> <span class="toc-text">LED程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6LED%E9%97%AA%E7%83%81"><span class="toc-number">2.3.1.</span> <span class="toc-text">控制LED闪烁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LED%E6%B5%81%E6%B0%B4%E7%81%AF"><span class="toc-number">2.3.2.</span> <span class="toc-text">LED流水灯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E5%BA%93%E5%87%BD%E6%95%B0%E5%86%99LED%E7%81%AF%E5%B7%A6%E5%8F%B3%E6%9D%A5%E5%9B%9E%E6%B5%81%E6%B0%B4"><span class="toc-number">2.3.3.</span> <span class="toc-text">用库函数写LED灯左右来回流水</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%9C%82%E9%B8%A3%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">蜂鸣器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9C%82%E9%B8%A3%E5%99%A8%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">蜂鸣器简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9C%82%E9%B8%A3%E5%99%A8%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">3.2.</span> <span class="toc-text">蜂鸣器原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9C%82%E9%B8%A3%E5%99%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.3.</span> <span class="toc-text">蜂鸣器程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%9C%82%E9%B8%A3%E5%99%A8%E5%8F%91%E5%87%BA%E5%A3%B0%E9%9F%B3%EF%BC%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%E5%85%B3%E9%97%AD"><span class="toc-number">3.3.1.</span> <span class="toc-text">蜂鸣器发出声音，一段时间后关闭</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">数码管</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">数码管简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text">数码表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E9%98%B4%E6%95%B0%E7%A0%81%E7%AE%A1%E7%A0%81%E8%A1%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">共阴数码管码表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E9%98%B3%E6%95%B0%E7%A0%81%E7%AE%A1%E7%A0%81%E8%A1%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">共阳数码管码表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">4.3.</span> <span class="toc-text">原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E6%98%BE%E7%A4%BA"><span class="toc-number">4.4.</span> <span class="toc-text">数码管显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74HC245%E8%8A%AF%E7%89%87"><span class="toc-number">4.5.</span> <span class="toc-text">74HC245芯片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74HC138-%E8%8A%AF%E7%89%87"><span class="toc-number">4.6.</span> <span class="toc-text">74HC138 芯片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.7.</span> <span class="toc-text">数码管程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%95%B0%E7%A0%81%E7%AE%A1%E5%AE%9E%E9%AA%8C"><span class="toc-number">4.7.1.</span> <span class="toc-text">静态数码管实验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%95%B0%E7%A0%81%E7%AE%A1%E5%AE%9E%E9%AA%8C"><span class="toc-number">4.7.2.</span> <span class="toc-text">动态数码管实验</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E5%B7%A6%E5%88%B0%E5%8F%B3%E6%98%BE%E7%A4%BA%E6%95%B0%E5%AD%971%E5%88%B07"><span class="toc-number">4.7.2.1.</span> <span class="toc-text">从左到右显示数字1到7</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%95%B0%E7%A0%81%E7%AE%A1%E6%98%BE%E7%A4%BA%E6%97%A5%E6%9C%9F"><span class="toc-number">4.7.2.2.</span> <span class="toc-text">动态数码管显示日期</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%89%E9%94%AE"><span class="toc-number">5.</span> <span class="toc-text">按键</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">独立按键介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">5.2.</span> <span class="toc-text">独立按键原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.3.</span> <span class="toc-text">独立按键程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E6%8E%A7%E5%88%B6LED%E4%BA%AE%E7%81%AD"><span class="toc-number">5.3.1.</span> <span class="toc-text">独立按键控制LED亮灭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E6%8E%A7%E5%88%B6LED%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.3.2.</span> <span class="toc-text">独立按键控制LED移动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%8C%89%E9%94%AE%E6%8E%A7%E5%88%B6%E6%95%B0%E7%A0%81%E7%AE%A1%E5%92%8C%E8%9C%82%E9%B8%A3%E5%99%A8"><span class="toc-number">5.3.3.</span> <span class="toc-text">独立按键控制数码管和蜂鸣器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AE"><span class="toc-number">5.4.</span> <span class="toc-text">矩阵按键</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.4.1.</span> <span class="toc-text">矩阵按键介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AE%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">5.4.2.</span> <span class="toc-text">矩阵按键原理图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AE%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.3.</span> <span class="toc-text">矩阵按键的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AE%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.4.4.</span> <span class="toc-text">矩阵按键程序</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%8C%E5%88%97%E6%89%AB%E6%8F%8F%E6%B3%95-%E6%8C%89%E4%B8%8B%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AES1-S16-%E9%94%AE%EF%BC%8C%E6%95%B0%E7%A0%81%E7%AE%A1%E6%98%BE%E7%A4%BA-0-F"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">行列扫描法_按下矩阵按键S1-S16 键，数码管显示 0-F</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%BF%BB%E8%BD%AC%E6%89%AB%E6%8F%8F%E6%B3%95-%E6%8C%89%E4%B8%8B%E7%9F%A9%E9%98%B5%E6%8C%89%E9%94%AES1-S16-%E9%94%AE%EF%BC%8C%E6%95%B0%E7%A0%81%E7%AE%A1%E6%98%BE%E7%A4%BA-0-F"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">线翻转扫描法_按下矩阵按键S1-S16 键，数码管显示 0-F</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5"><span class="toc-number">6.</span> <span class="toc-text">LED点阵</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">LED点阵介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">6.2.</span> <span class="toc-text">LED点阵原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74HC595-%E8%8A%AF%E7%89%87%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.3.</span> <span class="toc-text">74HC595 芯片介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%AD%97%E6%A8%A1%E8%BD%AF%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">取字模软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5%E5%AE%9E%E9%AA%8C"><span class="toc-number">6.5.</span> <span class="toc-text">LED点阵实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-%E6%89%A9%E5%B1%95-%E4%B8%B2%E8%BD%AC%E5%B9%B6-%E5%AE%9E%E9%AA%8C-74HC595"><span class="toc-number">6.5.1.</span> <span class="toc-text">IO 扩展(串转并)实验-74HC595</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E4%BA%AE%E4%B8%80%E4%B8%AA%E7%82%B9"><span class="toc-number">6.5.2.</span> <span class="toc-text">点亮一个点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5%E6%98%BE%E7%A4%BA%E5%9B%BE%E5%83%8F%E2%80%9C0%E2%80%9D"><span class="toc-number">6.5.3.</span> <span class="toc-text">LED点阵显示图像“0”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LED%E7%82%B9%E9%98%B5%E6%98%BE%E7%A4%BA%E5%8A%A8%E7%94%BB"><span class="toc-number">6.5.4.</span> <span class="toc-text">LED点阵显示动画</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-16%E7%82%B9%E9%98%B5"><span class="toc-number">6.6.</span> <span class="toc-text">16*16点阵</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%B5%81%E7%94%B5%E6%9C%BA"><span class="toc-number">7.</span> <span class="toc-text">直流电机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%B5%81%E7%94%B5%E6%9C%BA%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">直流电机介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ULN2003-%E8%8A%AF%E7%89%87%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.2.</span> <span class="toc-text">ULN2003 芯片介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%B5%81%E7%94%B5%E6%9C%BA%E5%AE%9E%E9%AA%8C"><span class="toc-number">7.3.</span> <span class="toc-text">直流电机实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA"><span class="toc-number">8.</span> <span class="toc-text">步进电机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E7%AE%80%E4%BB%8B"><span class="toc-number">8.1.</span> <span class="toc-text">步进电机简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">8.2.</span> <span class="toc-text">步进电机工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.</span> <span class="toc-text">步进电机驱动原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87"><span class="toc-number">8.4.</span> <span class="toc-text">步进电机技术指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28BYJ-48-%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E7%AE%80%E4%BB%8B"><span class="toc-number">8.5.</span> <span class="toc-text">28BYJ-48 步进电机简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">8.6.</span> <span class="toc-text">步进电机原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E9%94%AE%E6%8E%A7%E5%88%B6%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C"><span class="toc-number">8.7.</span> <span class="toc-text">按键控制步进电机驱动实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD"><span class="toc-number">9.</span> <span class="toc-text">中断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E6%A6%82%E5%BF%B5"><span class="toc-number">9.1.</span> <span class="toc-text">中断概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E7%BB%93%E6%9E%84"><span class="toc-number">9.2.</span> <span class="toc-text">中断结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">9.3.</span> <span class="toc-text">中断相关寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%85%81%E8%AE%B8%E6%8E%A7%E5%88%B6"><span class="toc-number">9.3.1.</span> <span class="toc-text">中断允许控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82%E6%A0%87%E5%BF%97-TCON"><span class="toc-number">9.3.2.</span> <span class="toc-text">中断请求标志 TCON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">9.3.3.</span> <span class="toc-text">中断优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%8F%B7"><span class="toc-number">9.3.4.</span> <span class="toc-text">中断号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%93%8D%E5%BA%94%E6%9D%A1%E4%BB%B6"><span class="toc-number">9.3.5.</span> <span class="toc-text">中断响应条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD%E9%85%8D%E7%BD%AE"><span class="toc-number">9.4.</span> <span class="toc-text">外部中断配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E2%80%93%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%ADK3%E6%8E%A7%E5%88%B6LED%E4%BA%AE%E7%81%AD%E5%AE%9E%E9%AA%8C"><span class="toc-number">9.5.</span> <span class="toc-text">程序–外部中断K3控制LED亮灭实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-%E6%97%B6%E5%BA%8F"><span class="toc-number">10.1.</span> <span class="toc-text">CPU 时序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.2.</span> <span class="toc-text">定时器介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%8E%9F%E7%90%86"><span class="toc-number">10.3.</span> <span class="toc-text">定时器原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E8%AE%A1%E6%95%B0%E5%99%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">10.4.</span> <span class="toc-text">定时计数器寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F%E5%AF%84%E5%AD%98%E5%99%A8-TMOD"><span class="toc-number">10.4.1.</span> <span class="toc-text">工作方式寄存器 TMOD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8-TCON"><span class="toc-number">10.4.2.</span> <span class="toc-text">控制寄存器 TCON</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6-%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">10.5.</span> <span class="toc-text">定时&#x2F;计数器的工作方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">10.6.</span> <span class="toc-text">定时器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E2%80%93%E5%AE%9A%E6%97%B6%E5%99%A80%E6%8E%A7%E5%88%B6LED1%E7%A7%92%E9%97%AA%E7%83%81"><span class="toc-number">10.7.</span> <span class="toc-text">程序–定时器0控制LED1秒闪烁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1"><span class="toc-number">11.</span> <span class="toc-text">串口通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD"><span class="toc-number">11.1.</span> <span class="toc-text">串口通信相关术语</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%89%87%E6%9C%BA%E4%B8%B2%E5%8F%A3%E4%BB%8B%E7%BB%8D"><span class="toc-number">11.2.</span> <span class="toc-text">单片机串口介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E7%9B%B8%E5%85%B3%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">11.3.</span> <span class="toc-text">串口相关寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8-SCON"><span class="toc-number">11.3.1.</span> <span class="toc-text">串口控制寄存器 SCON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E6%BA%90%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8-PCON"><span class="toc-number">11.3.2.</span> <span class="toc-text">电源控制寄存器 PCON</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">11.4.</span> <span class="toc-text">串口工作方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">11.5.</span> <span class="toc-text">串口的使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E5%88%9D%E5%A7%8B%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="toc-number">11.6.</span> <span class="toc-text">串口初始化步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">11.7.</span> <span class="toc-text">串口通信原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1%E5%AE%9E%E9%AA%8C"><span class="toc-number">11.8.</span> <span class="toc-text">串口通信实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E5%8A%A9%E6%89%8B%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E7%BB%99%E5%8D%95%E7%89%87%E6%9C%BA%EF%BC%8C%E5%8D%95%E7%89%87%E6%9C%BA%E5%8E%9F%E5%B0%81%E4%B8%8D%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%BB%99%E4%B8%B2%E5%8F%A3%E5%8A%A9%E6%89%8B"><span class="toc-number">11.8.1.</span> <span class="toc-text">串口助手发送数据给单片机，单片机原封不动转发给串口助手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B2%E5%8F%A3%E6%8E%A7%E5%88%B6led%E7%81%AF"><span class="toc-number">11.8.2.</span> <span class="toc-text">串口控制led灯</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I2C-EEPROM"><span class="toc-number">12.</span> <span class="toc-text">I2C-EEPROM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">12.1.</span> <span class="toc-text">存储器介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I2C%E4%BB%8B%E7%BB%8D"><span class="toc-number">12.2.</span> <span class="toc-text">I2C介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I2C-%E5%8D%8F%E8%AE%AE"><span class="toc-number">12.3.</span> <span class="toc-text">I2C 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AT24C02-%E4%BB%8B%E7%BB%8D%EF%BC%88EEPROM"><span class="toc-number">12.4.</span> <span class="toc-text">AT24C02 介绍（EEPROM)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EEPROM%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">12.5.</span> <span class="toc-text">EEPROM原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I2C-EEPROM%E5%AE%9E%E9%AA%8C"><span class="toc-number">12.6.</span> <span class="toc-text">I2C-EEPROM实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%A8%8B%E5%BA%8F%E5%90%8E%EF%BC%8C%E6%95%B0%E7%A0%81%E7%AE%A1%E5%8F%B3-4-%E4%BD%8D%E6%98%BE%E7%A4%BA-0%EF%BC%8C%E6%8C%89-K1-%E9%94%AE%E5%B0%86%E5%B0%86%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%88%B0-EEPROM-%E5%86%85%E4%BF%9D%E5%AD%98%EF%BC%8C%E6%8C%89-K2-%E9%94%AE%E8%AF%BB%E5%8F%96-EEPROM-%E5%86%85%E4%BF%9D%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%8C%89-K3-%E9%94%AE%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%8A%A0-1%EF%BC%8C%E6%8C%89-K4-%E9%94%AE%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE%E6%B8%85%E9%9B%B6%EF%BC%8C%E6%9C%80%E5%A4%A7%E8%83%BD%E5%86%99%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF-255"><span class="toc-number">12.6.1.</span> <span class="toc-text">下载程序后，数码管右 4 位显示 0，按 K1 键将将数据写入到 EEPROM 内保存，按 K2 键读取 EEPROM 内保存的数据，按 K3 键显示数据加 1，按 K4 键显示数据清零，最大能写入的数据是 255</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E9%94%AE1%E6%8E%A7%E5%88%B6%E7%A7%92%E8%A1%A8%E5%90%AF%E5%8A%A8%E4%B8%8E%E6%9A%82%E5%81%9C%EF%BC%8C%E6%8C%89%E9%94%AE2%E4%BD%BF%E7%A7%92%E8%A1%A8%E6%B8%850%EF%BC%8C%E6%8C%89%E9%94%AE3%E5%B0%86%E7%A7%92%E8%A1%A8%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%88%B0EEPROM-%E6%8C%89%E9%94%AE4%E8%AF%BB%E5%8F%96EEPROM%E4%B8%AD%E5%AD%98%E5%82%A8%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">12.6.2.</span> <span class="toc-text">按键1控制秒表启动与暂停，按键2使秒表清0，按键3将秒表数据存储到EEPROM,按键4读取EEPROM中存储的数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DS18B20-%E6%B8%A9%E5%BA%A6%E4%BC%A0%E6%84%9F%E5%99%A8"><span class="toc-number">13.</span> <span class="toc-text">DS18B20-温度传感器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DS18B20-%E4%BB%8B%E7%BB%8D"><span class="toc-number">13.1.</span> <span class="toc-text">DS18B20 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%B8%A9%E5%BA%A6%E6%95%B0%E6%8D%AE"><span class="toc-number">13.2.</span> <span class="toc-text">读取温度数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E5%BA%8F"><span class="toc-number">13.2.1.</span> <span class="toc-text">初始化时序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%97%B6%E5%BA%8F"><span class="toc-number">13.2.2.</span> <span class="toc-text">写时序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E6%97%B6%E5%BA%8F"><span class="toc-number">13.2.3.</span> <span class="toc-text">读时序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DS18B20-%E6%A8%A1%E5%9D%97%E7%94%B5%E8%B7%AF%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">13.3.</span> <span class="toc-text">DS18B20 模块电路原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DS18B20-%E5%AE%9E%E9%AA%8C"><span class="toc-number">13.4.</span> <span class="toc-text">DS18B20 实验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DS1302-%E6%97%B6%E9%92%9F"><span class="toc-number">14.</span> <span class="toc-text">DS1302 时钟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DS1302-%E6%97%B6%E9%92%9F%E8%8A%AF%E7%89%87%E7%AE%80%E4%BB%8B"><span class="toc-number">14.1.</span> <span class="toc-text">DS1302 时钟芯片简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DS1302-%E4%BD%BF%E7%94%A8"><span class="toc-number">14.2.</span> <span class="toc-text">DS1302 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">14.2.1.</span> <span class="toc-text">控制寄存器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%8E%86-%E6%97%B6%E9%92%9F%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">14.2.2.</span> <span class="toc-text">日历&#x2F;时钟寄存器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DS1302-%E7%9A%84%E8%AF%BB%E5%86%99%E6%97%B6%E5%BA%8F"><span class="toc-number">14.2.3.</span> <span class="toc-text">DS1302 的读写时序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DS1302%E6%97%B6%E9%92%9F%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">14.3.</span> <span class="toc-text">DS1302时钟原理图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DS1302%E6%97%B6%E9%92%9F%E5%AE%9E%E9%AA%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">14.4.</span> <span class="toc-text">DS1302时钟实验程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E4%B8%8A%E6%98%BE%E7%A4%BA%E7%94%B5%E5%AD%90%E6%97%B6%E9%92%9F%E6%97%B6%E5%88%86%E7%A7%92%EF%BC%8C%E6%A0%BC%E5%BC%8F%E4%B8%BA%E2%80%9CXX-XX-XX%E2%80%9D"><span class="toc-number">14.4.1.</span> <span class="toc-text">数码管上显示电子时钟时分秒，格式为“XX-XX-XX”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A2%E5%A4%96%E9%81%A5%E6%8E%A7"><span class="toc-number">15.</span> <span class="toc-text">红外遥控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A2%E5%A4%96%E9%81%A5%E6%8E%A7%E4%BB%8B%E7%BB%8D"><span class="toc-number">15.1.</span> <span class="toc-text">红外遥控介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A2%E5%A4%96%E6%8E%A5%E6%94%B6%E6%A8%A1%E5%9D%97%E7%94%B5%E8%B7%AF"><span class="toc-number">15.2.</span> <span class="toc-text">红外接收模块电路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A2%E5%A4%96%E9%81%A5%E6%8E%A7%E5%AE%9E%E9%AA%8C"><span class="toc-number">15.3.</span> <span class="toc-text">红外遥控实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E4%B8%8A%E6%98%BE%E7%A4%BA%E7%BA%A2%E5%A4%96%E8%A7%A3%E7%A0%81%E9%81%A5%E6%8E%A7%E5%99%A8%E9%94%AE%E5%80%BC"><span class="toc-number">15.3.1.</span> <span class="toc-text">数码管上显示红外解码遥控器键值</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> 被窝理想家</div><div class="footer_custom_text"><div><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/Frame-Hexo-blue.svg" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/Theme-Butterfly-6513df.svg" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://vercel.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/Hosted-Vercel-brightgreen.svg" title="本站采用多线部署，次线路托管于Vercel" alt="HEXO"></a></div></div><div id="running-time" style="color: #5c5c5c;"><script>setInterval(()=>{let create_time=Math.round(new Date('9/6/2023 08:00:00').getTime()/1000);let timestamp=Math.round((new Date().getTime()+8*60*60*1000)/1000);let second=timestamp-create_time;let time=new Array(0,0,0,0,0);if(second>=365*24*3600){time[0]=parseInt(second/(365*24*3600));second%=365*24*3600;}if(second>=24*3600){time[1]=parseInt(second/(24*3600));second%=24*3600;}if(second>=3600){time[2]=parseInt(second/3600);second%=3600;}if(second>=60){time[3]=parseInt(second/60);second%=60;}if(second>0){time[4]=second;}currentTimeHtml='本站已苟活了 '+time[0]+' 年 '+time[1]+' 天 '+time[2]+' 时 '+time[3]+' 分 '+time[4]+' 秒';document.getElementById("running-time").innerHTML=currentTimeHtml;},1000);</script></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.27/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://lib.baomitu.com/KaTeX/latest/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async type="text/javascript" src="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script><script>
    document.body.oncopy = function () {
        iziToast.info({
            timeout: 4000, // 关闭弹窗的时间
          // icon: 'Fontawesome', // 图标类别
            closeOnEscape: 'true', // 允许使用Esc键关闭弹窗
            transitionIn: 'bounceInLeft', // 弹窗打开动画
            transitionOut: 'fadeOutRight', // 弹窗关闭动画
            displayMode: 'replace', // 替换已经打开的弹窗
            layout: '2', // Medium模式
            position: 'topRight', // 弹窗位置
            //icon: 'fad fa-copy', // 图标类名
            iconUrl:'https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/1122star.svg',
            backgroundColor: 'rgb(179, 182, 180)', // 弹窗背景色
            title: '复制成功', // 通知标题
            message: '键盘敲烂 月薪过万' // 通知消息内容
        });
    }
</script>    
<script  type="text/javascript" src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://cdn.staticfile.org/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div></body></html>